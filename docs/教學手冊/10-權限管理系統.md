# 10 - æ¬Šé™ç®¡ç†ç³»çµ±

> è¨­å®šå’Œç®¡ç†ä½¿ç”¨è€…æ¬Šé™ï¼Œç¢ºä¿ä¸åŒè§’è‰²åªèƒ½å­˜å–å°æ‡‰çš„åŠŸèƒ½ã€‚

## ğŸ¯ æœ¬ç« ç›®æ¨™

å®Œæˆæœ¬ç« å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š
- äº†è§£æ¬Šé™ç³»çµ±çš„é‹ä½œæ–¹å¼
- ç‚ºä½¿ç”¨è€…è¨­å®šè§’è‰²
- åœ¨å‰ç«¯æª¢æŸ¥æ¬Šé™
- åœ¨å¾Œç«¯é©—è­‰æ¬Šé™
- ç®¡ç†ä½¿ç”¨è€…æ¬Šé™

## ğŸ” æ¬Šé™ç³»çµ±æ¶æ§‹

### è§’è‰²å®šç¾©

é¾œé¦¬å±±ç³»çµ±ä½¿ç”¨**è§’è‰²å‹æ¬Šé™æ§åˆ¶**ï¼ˆRole-Based Access Controlï¼‰ã€‚

| è§’è‰² | ä»£ç¢¼ | æ¬Šé™ç¯„åœ |
|------|------|---------|
| ä¸€èˆ¬ä½¿ç”¨è€… | `user` | åŸºæœ¬åŠŸèƒ½ï¼ˆç°½åˆ°ã€æŸ¥çœ‹è‡ªå·±çš„è³‡æ–™ï¼‰ |
| é€²éšä½¿ç”¨è€… | `poweruser` | å¯ä»¥å»ºç«‹æœå‹™ç”³è«‹ |
| ç°½åˆ°ç®¡ç†å“¡ | `admin_checkin` | ç®¡ç†ç°½åˆ°ç³»çµ±ã€æŸ¥çœ‹æ‰€æœ‰ç°½åˆ°ç´€éŒ„ |
| ç¥å‹™ç®¡ç†å“¡ | `admin_service` | ç®¡ç†ç¥å‹™ç³»çµ± |
| æ’ç­ç®¡ç†å“¡ | `admin_schedule` | ç®¡ç†æ’ç­ç³»çµ± |
| è¶…ç´šç®¡ç†å“¡ | `superadmin` | æ‰€æœ‰æ¬Šé™ |

### è³‡æ–™çµæ§‹

åœ¨ Firestore çš„ users é›†åˆï¼š

```javascript
{
  "uid": "abc123",
  "displayName": "ç‹å°æ˜",
  "email": "ming@example.com",
  "photoURL": "https://...",
  "lineUserId": "U1234567890",
  "roles": ["user", "admin_checkin"],  // è§’è‰²é™£åˆ—
  "createdAt": "2025-11-01T10:00:00Z",
  "lastLogin": "2025-11-02T09:30:00Z"
}
```

**é‡é»**ï¼š
- `roles` æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä¸€å€‹ä½¿ç”¨è€…å¯ä»¥æœ‰å¤šå€‹è§’è‰²
- æ–°ä½¿ç”¨è€…é è¨­åªæœ‰ `["user"]`
- è¶…ç´šç®¡ç†å“¡å¯ä»¥ä¿®æ”¹å…¶ä»–äººçš„è§’è‰²

## ğŸ‘¤ æ­¥é©Ÿä¸€ï¼šè¨­å®šç¬¬ä¸€å€‹ç®¡ç†å“¡

### 1-1. ç”¨ä¸€èˆ¬å¸³è™Ÿç™»å…¥

1. æ‰“é–‹ç¶²ç«™ï¼šhttps://go.guimashan.org.tw
2. ç”¨ LINE ç™»å…¥
3. ç³»çµ±æœƒè‡ªå‹•å»ºç«‹æ‚¨çš„ä½¿ç”¨è€…è³‡æ–™

### 1-2. åœ¨ Firestore æ‰‹å‹•è¨­å®šè§’è‰²

1. å‰å¾€ Firebase Console
2. é¸æ“‡ Platform å°ˆæ¡ˆ
3. Firestore Database
4. æ‰¾åˆ° `users` é›†åˆ
5. æ‰¾åˆ°æ‚¨çš„ä½¿ç”¨è€…æ–‡ä»¶ï¼ˆç”¨ `lineUserId` æˆ– `displayName` è¾¨è­˜ï¼‰
6. ç·¨è¼¯ `roles` æ¬„ä½ï¼š

```json
{
  "roles": ["user", "superadmin"]
}
```

7. å„²å­˜

âœ… æ‚¨ç¾åœ¨æ˜¯è¶…ç´šç®¡ç†å“¡äº†ï¼

### 1-3. é‡æ–°æ•´ç†é é¢

é‡æ–°ç™»å…¥æˆ–é‡æ–°æ•´ç†é é¢ï¼Œæ‚¨æ‡‰è©²æœƒçœ‹åˆ°æ‰€æœ‰ç®¡ç†åŠŸèƒ½ã€‚

## ğŸ¨ æ­¥é©ŸäºŒï¼šå‰ç«¯æ¬Šé™æª¢æŸ¥

### 2-1. åœ¨ HTML éš±è—å…ƒç´ 

```html
<!-- åªæœ‰ç®¡ç†å“¡çœ‹å¾—åˆ° -->
<div id="adminPanel" style="display: none;">
    <button onclick="deleteUser()">åˆªé™¤ä½¿ç”¨è€…</button>
</div>
```

### 2-2. åœ¨ JavaScript é¡¯ç¤º/éš±è—

```javascript
// è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
async function loadUserData() {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.data();
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    if (hasRole(userData, ['admin', 'superadmin'])) {
        document.getElementById('adminPanel').style.display = 'block';
    }
}

// æª¢æŸ¥è§’è‰²çš„è¼”åŠ©å‡½æ•¸
function hasRole(userData, allowedRoles) {
    if (!userData || !userData.roles) return false;
    return userData.roles.some(role => allowedRoles.includes(role));
}
```

### 2-3. å®Œæ•´ç¯„ä¾‹

```javascript
// åˆå§‹åŒ–æ™‚æª¢æŸ¥æ¬Šé™
document.addEventListener('DOMContentLoaded', async () => {
    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            const userData = await getUserData(user.uid);
            setupPermissions(userData);
        } else {
            window.location.href = '/index.html';
        }
    });
});

// å–å¾—ä½¿ç”¨è€…è³‡æ–™
async function getUserData(uid) {
    const doc = await firebase.firestore()
        .collection('users')
        .doc(uid)
        .get();
    return doc.data();
}

// è¨­å®šæ¬Šé™
function setupPermissions(userData) {
    // ç°½åˆ°ç®¡ç†
    if (hasRole(userData, ['admin_checkin', 'superadmin'])) {
        showElement('checkinManagement');
    }
    
    // ä½¿ç”¨è€…ç®¡ç†
    if (hasRole(userData, ['superadmin'])) {
        showElement('userManagement');
    }
}

function showElement(id) {
    const element = document.getElementById(id);
    if (element) element.style.display = 'block';
}
```

## âš™ï¸ æ­¥é©Ÿä¸‰ï¼šå¾Œç«¯æ¬Šé™é©—è­‰

### 3-1. é©—è­‰ä¸­ä»‹å±¤

```javascript
// functions/src/utils/auth.js

const admin = require('firebase-admin');

// é©—è­‰ä½¿ç”¨è€…æ˜¯å¦ç™»å…¥
async function authenticate(req, res, next) {
    const token = req.headers.authorization?.split('Bearer ')[1];
    
    if (!token) {
        return res.status(401).json({ error: 'æœªæˆæ¬Š' });
    }
    
    try {
        const decodedToken = await admin.auth().verifyIdToken(token);
        req.user = decodedToken;
        
        // å–å¾—ä½¿ç”¨è€…è³‡æ–™
        const userDoc = await admin.firestore()
            .collection('users')
            .doc(decodedToken.uid)
            .get();
        req.userData = userDoc.data();
        
        next();
    } catch (error) {
        res.status(401).json({ error: 'ç„¡æ•ˆçš„ Token' });
    }
}

// æª¢æŸ¥è§’è‰²
function requireRole(allowedRoles) {
    return (req, res, next) => {
        if (!req.userData || !req.userData.roles) {
            return res.status(403).json({ error: 'æ¬Šé™ä¸è¶³' });
        }
        
        const hasPermission = req.userData.roles.some(role => 
            allowedRoles.includes(role)
        );
        
        if (!hasPermission) {
            return res.status(403).json({ error: 'æ¬Šé™ä¸è¶³' });
        }
        
        next();
    };
}

module.exports = { authenticate, requireRole };
```

### 3-2. ä½¿ç”¨æ¬Šé™ä¸­ä»‹å±¤

```javascript
// functions/src/checkin/index.js

const { authenticate, requireRole } = require('../utils/auth');

// ä¸€èˆ¬ä½¿ç”¨è€…å¯ä»¥ç°½åˆ°
app.post('/checkin', authenticate, async (req, res) => {
    // ä»»ä½•ç™»å…¥çš„ä½¿ç”¨è€…éƒ½å¯ä»¥ç°½åˆ°
});

// åªæœ‰ç®¡ç†å“¡å¯ä»¥ç®¡ç†å·¡é‚é»
app.post('/patrols', 
    authenticate, 
    requireRole(['admin_checkin', 'superadmin']),
    async (req, res) => {
        // å»ºç«‹å·¡é‚é»
    }
);

// æŸ¥çœ‹ç°½åˆ°ç´€éŒ„ï¼šç®¡ç†å“¡çœ‹å…¨éƒ¨ï¼Œä¸€èˆ¬ä½¿ç”¨è€…åªçœ‹è‡ªå·±çš„
app.get('/checkins', authenticate, async (req, res) => {
    const isAdmin = req.userData.roles.includes('admin_checkin') || 
                    req.userData.roles.includes('superadmin');
    
    let query = admin.firestore().collection('checkins');
    
    if (!isAdmin) {
        // ä¸€èˆ¬ä½¿ç”¨è€…åªèƒ½çœ‹è‡ªå·±çš„
        query = query.where('userId', '==', req.user.uid);
    }
    
    const snapshot = await query.get();
    // ...
});
```

## ğŸ”’ æ­¥é©Ÿå››ï¼šFirestore å®‰å…¨è¦å‰‡

### 4-1. Platform å°ˆæ¡ˆè¦å‰‡

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // è¼”åŠ©å‡½æ•¸
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().roles.hasAny([role]);
    }
    
    function hasAnyRole(roles) {
      return isAuthenticated() && getUserData().roles.hasAny(roles);
    }
    
    // ä½¿ç”¨è€…è³‡æ–™
    match /users/{userId} {
      // ä»»ä½•ç™»å…¥ä½¿ç”¨è€…éƒ½å¯ä»¥è®€å–ä½¿ç”¨è€…åˆ—è¡¨
      allow read: if isAuthenticated();
      
      // åªæœ‰æœ¬äººæˆ–è¶…ç´šç®¡ç†å“¡å¯ä»¥å¯«å…¥
      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        hasRole('superadmin')
      );
    }
    
    // å…¬å‘Š
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create, update: if hasAnyRole(['admin', 'superadmin']);
      allow delete: if hasRole('superadmin');
    }
  }
}
```

### 4-2. Checkin å°ˆæ¡ˆè¦å‰‡

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return getUserData().roles.hasAny(['admin_checkin', 'superadmin']);
    }
    
    // å·¡é‚é»
    match /patrols/{patrolId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // ç°½åˆ°ç´€éŒ„
    match /checkins/{checkinId} {
      // ç®¡ç†å“¡å¯ä»¥çœ‹å…¨éƒ¨ï¼Œä¸€èˆ¬ä½¿ç”¨è€…åªèƒ½çœ‹è‡ªå·±çš„
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.userId == request.auth.uid
      );
      
      // åªæœ‰æœ¬äººå¯ä»¥å»ºç«‹
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // åªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹/åˆªé™¤
      allow update, delete: if isAdmin();
    }
  }
}
```

## ğŸ‘¥ æ­¥é©Ÿäº”ï¼šä½¿ç”¨è€…ç®¡ç†ä»‹é¢

### 5-1. å»ºç«‹ä½¿ç”¨è€…ç®¡ç†é é¢

```html
<!-- public/admin/users.html -->
<div class="container">
    <h1>ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</h1>
    
    <div id="usersList">
        <!-- ä½¿ç”¨è€…åˆ—è¡¨ -->
    </div>
</div>

<script>
async function loadUsers() {
    const snapshot = await db.collection('users').get();
    const container = document.getElementById('usersList');
    
    snapshot.forEach(doc => {
        const user = doc.data();
        const card = createUserCard(doc.id, user);
        container.appendChild(card);
    });
}

function createUserCard(uid, user) {
    const card = document.createElement('div');
    card.className = 'user-card';
    card.innerHTML = `
        <div class="user-name">${user.displayName}</div>
        <div class="user-roles">
            è§’è‰²ï¼š${user.roles ? user.roles.join(', ') : 'ç„¡'}
        </div>
        <button onclick="editRoles('${uid}')">ç·¨è¼¯è§’è‰²</button>
    `;
    return card;
}

async function editRoles(uid) {
    const userDoc = await db.collection('users').doc(uid).get();
    const user = userDoc.data();
    
    const newRoles = prompt(
        'è«‹è¼¸å…¥è§’è‰²ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰ï¼š\n' +
        'å¯ç”¨è§’è‰²ï¼šuser, poweruser, admin_checkin, admin_service, admin_schedule, superadmin',
        user.roles ? user.roles.join(', ') : 'user'
    );
    
    if (newRoles !== null) {
        const rolesArray = newRoles.split(',').map(r => r.trim());
        await db.collection('users').doc(uid).update({
            roles: rolesArray
        });
        alert('è§’è‰²æ›´æ–°æˆåŠŸï¼');
        location.reload();
    }
}
</script>
```

## ğŸ“Š æ­¥é©Ÿå…­ï¼šæ¬Šé™æ¸¬è©¦

### 6-1. å»ºç«‹æ¸¬è©¦å¸³è™Ÿ

1. ç”¨ä¸åŒçš„ LINE å¸³è™Ÿç™»å…¥
2. åœ¨ Firestore è¨­å®šä¸åŒçš„è§’è‰²
3. æ¸¬è©¦æ¯å€‹è§’è‰²çš„æ¬Šé™

### 6-2. æ¸¬è©¦æ¸…å–®

**ä¸€èˆ¬ä½¿ç”¨è€…ï¼ˆuserï¼‰**ï¼š
- [ ] å¯ä»¥ç°½åˆ°
- [ ] åªèƒ½çœ‹åˆ°è‡ªå·±çš„ç°½åˆ°ç´€éŒ„
- [ ] çœ‹ä¸åˆ°ç®¡ç†åŠŸèƒ½
- [ ] ç„¡æ³•å»ºç«‹å·¡é‚é»

**ç°½åˆ°ç®¡ç†å“¡ï¼ˆadmin_checkinï¼‰**ï¼š
- [ ] å¯ä»¥ç°½åˆ°
- [ ] å¯ä»¥çœ‹åˆ°æ‰€æœ‰ç°½åˆ°ç´€éŒ„
- [ ] å¯ä»¥å»ºç«‹/ç·¨è¼¯å·¡é‚é»
- [ ] å¯ä»¥åˆªé™¤ç°½åˆ°ç´€éŒ„

**è¶…ç´šç®¡ç†å“¡ï¼ˆsuperadminï¼‰**ï¼š
- [ ] å¯ä»¥ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½
- [ ] å¯ä»¥ç®¡ç†ä½¿ç”¨è€…è§’è‰²
- [ ] å¯ä»¥å­˜å–æ‰€æœ‰è³‡æ–™

## âš ï¸ å¸¸è¦‹éŒ¯èª¤

### éŒ¯èª¤ 1ï¼šæ¬Šé™ä¸è¶³

**ç—‡ç‹€**ï¼šæ“ä½œè¢«æ‹’çµ•

**æª¢æŸ¥**ï¼š
1. Firestore è¦å‰‡æ˜¯å¦æ­£ç¢º
2. ä½¿ç”¨è€…çš„ roles æ¬„ä½æ˜¯å¦æ­£ç¢º
3. å‰ç«¯æ˜¯å¦æœ‰é€ Authorization header

### éŒ¯èª¤ 2ï¼šè§’è‰²æ²’æœ‰ç”Ÿæ•ˆ

**ç—‡ç‹€**ï¼šè¨­å®šè§’è‰²å¾Œä»çœ‹ä¸åˆ°åŠŸèƒ½

**è§£æ±º**ï¼š
1. é‡æ–°ç™»å…¥
2. æ¸…é™¤ç€è¦½å™¨å¿«å–
3. æª¢æŸ¥ JavaScript Console æ˜¯å¦æœ‰éŒ¯èª¤

## âœ… æª¢æŸ¥æ¸…å–®

è«‹ç¢ºèªï¼š
- [ ] äº†è§£è§’è‰²ç³»çµ±çš„é‹ä½œæ–¹å¼
- [ ] è¨­å®šäº†ç¬¬ä¸€å€‹è¶…ç´šç®¡ç†å“¡
- [ ] å‰ç«¯æœ‰æ¬Šé™æª¢æŸ¥
- [ ] å¾Œç«¯æœ‰æ¬Šé™é©—è­‰
- [ ] Firestore è¦å‰‡å·²è¨­å®š
- [ ] æ¸¬è©¦éæ‰€æœ‰è§’è‰²çš„æ¬Šé™
- [ ] çŸ¥é“å¦‚ä½•ç®¡ç†ä½¿ç”¨è€…è§’è‰²

## ğŸ“ ä¸‹ä¸€æ­¥

æ¬Šé™ç³»çµ±è¨­å®šå®Œæˆï¼æ¥ä¸‹ä¾†å­¸ç¿’æ—¥å¸¸ç¶­è­·ï¼š

â¡ï¸ **ä¸‹ä¸€ç« ï¼š12-æ—¥å¸¸ç¶­è­·å’Œæ›´æ–°.md**

åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘å€‘æœƒèªªæ˜å¦‚ä½•ç¶­è­·å’Œæ›´æ–°ç³»çµ±ã€‚

---

ğŸ’¡ **å°æç¤º**ï¼š
- æ¬Šé™æª¢æŸ¥è¦åœ¨å‰ç«¯å’Œå¾Œç«¯éƒ½åš
- å‰ç«¯æª¢æŸ¥ï¼šæ”¹å–„ä½¿ç”¨è€…é«”é©—
- å¾Œç«¯é©—è­‰ï¼šç¢ºä¿å®‰å…¨æ€§
- Firestore è¦å‰‡ï¼šæœ€å¾Œä¸€é“é˜²ç·š
- å®šæœŸæª¢æŸ¥ä½¿ç”¨è€…æ¬Šé™æ˜¯å¦æ­£ç¢º
