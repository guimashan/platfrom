# 06 - Firebase å°ˆæ¡ˆå»ºç«‹

> å»ºç«‹å››å€‹ Firebase å°ˆæ¡ˆï¼Œç‚ºç³»çµ±æä¾›å¾Œç«¯æœå‹™ã€‚

## ğŸ¯ æœ¬ç« ç›®æ¨™

å®Œæˆæœ¬ç« å¾Œï¼Œæ‚¨å°‡ï¼š
- å»ºç«‹å››å€‹ Firebase å°ˆæ¡ˆï¼ˆPlatformã€Checkinã€Serviceã€Scheduleï¼‰
- å•Ÿç”¨ Firestore è³‡æ–™åº«
- å‡ç´šåˆ° Blaze æ–¹æ¡ˆ
- è¨­å®šå®‰å…¨è¦å‰‡
- å–å¾—å°ˆæ¡ˆè¨­å®šå€¼

## ğŸ“‹ å‰ç½®è¦æ±‚

- âœ… å·²è¨»å†Š Firebase å¸³è™Ÿï¼ˆç¬¬ 02 ç« ï¼‰
- âœ… æœ‰ Google å¸³è™Ÿ
- âœ… æº–å‚™å¥½ä¿¡ç”¨å¡ï¼ˆå‡ç´š Blaze æ–¹æ¡ˆç”¨ï¼‰

## ğŸ—ï¸ å››å€‹å°ˆæ¡ˆçš„åŠŸèƒ½

| å°ˆæ¡ˆåç¨± | å°ˆæ¡ˆ ID | è² è²¬ä»€éº¼ | è³‡æ–™åº«å…§å®¹ |
|---------|---------|---------|-----------|
| Platform | platform-bc783 | ä¸»å¹³å° | usersï¼ˆä½¿ç”¨è€…è³‡æ–™ã€è§’è‰²ï¼‰ |
| Checkin | checkin-76c77 | ç°½åˆ°ç³»çµ± | patrolsï¼ˆå·¡é‚é»ï¼‰ã€checkinsï¼ˆç°½åˆ°ç´€éŒ„ï¼‰ |
| Service | service-b9d4a | ç¥å‹™æœå‹™ | servicesï¼ˆæœå‹™é …ç›®ï¼‰ã€requestsï¼ˆæœå‹™ç”³è«‹ï¼‰ |
| Schedule | schedule-48ff9 | æ’ç­ç³»çµ± | schedulesï¼ˆæ’ç­è¡¨ï¼‰ã€attendanceï¼ˆå‡ºå‹¤ï¼‰ |

## ğŸ“± æ­¥é©Ÿä¸€ï¼šå»ºç«‹ç¬¬ä¸€å€‹å°ˆæ¡ˆï¼ˆPlatformï¼‰

### 1-1. é€²å…¥ Firebase Console

å‰å¾€ï¼šhttps://console.firebase.google.com/

### 1-2. å»ºç«‹æ–°å°ˆæ¡ˆ

1. é»æ“Šã€Œæ–°å¢å°ˆæ¡ˆã€æˆ–ã€ŒAdd projectã€
2. è¼¸å…¥å°ˆæ¡ˆåç¨±ï¼š`é¾œé¦¬å±± Platform`
3. é»æ“Šã€Œç¹¼çºŒã€

### 1-3. Google Analyticsï¼ˆé¸ç”¨ï¼‰

- å¯ä»¥é¸æ“‡ã€Œå•Ÿç”¨ã€æˆ–ã€Œä¸å•Ÿç”¨ã€
- å»ºè­°ï¼š**å•Ÿç”¨**ï¼ˆå¯ä»¥è¿½è¹¤ä½¿ç”¨æƒ…æ³ï¼‰
- å¦‚æœå•Ÿç”¨ï¼Œé¸æ“‡æˆ–å»ºç«‹ Analytics å¸³æˆ¶
- é»æ“Šã€Œå»ºç«‹å°ˆæ¡ˆã€

### 1-4. ç­‰å¾…å»ºç«‹å®Œæˆ

ç´„éœ€è¦ 30 ç§’åˆ° 1 åˆ†é˜ã€‚

âœ… **å®Œæˆï¼**æ‚¨çš„ç¬¬ä¸€å€‹ Firebase å°ˆæ¡ˆå»ºç«‹æˆåŠŸï¼

### 1-5. è¨˜éŒ„å°ˆæ¡ˆ ID

å»ºç«‹å®Œæˆå¾Œï¼Œæ‚¨æœƒåœ¨å°ˆæ¡ˆè¨­å®šè£¡çœ‹åˆ°å°ˆæ¡ˆ IDï¼š
```
å°ˆæ¡ˆ ID: platform-bc783ï¼ˆç¯„ä¾‹ï¼‰
```

**âš ï¸ è¨˜éŒ„åˆ°ç­†è¨˜æœ¬ï¼**

## ğŸ”¥ æ­¥é©ŸäºŒï¼šå•Ÿç”¨ Firestore è³‡æ–™åº«

### 2-1. é€²å…¥ Firestore

1. åœ¨å·¦å´é¸å–®é»æ“Šã€ŒFirestore Databaseã€
2. é»æ“Šã€Œå»ºç«‹è³‡æ–™åº«ã€

### 2-2. é¸æ“‡æ¨¡å¼

é¸æ“‡ï¼š**æ­£å¼ç‰ˆæ¨¡å¼ï¼ˆProduction modeï¼‰**

**ç‚ºä»€éº¼ä¸é¸æ¸¬è©¦æ¨¡å¼ï¼Ÿ**
- æ¸¬è©¦æ¨¡å¼æ‰€æœ‰äººéƒ½èƒ½è®€å¯«ï¼Œå¾ˆå±éšª
- æˆ‘å€‘æœƒè‡ªå·±è¨­å®šå®‰å…¨è¦å‰‡

### 2-3. é¸æ“‡ä½ç½®

é¸æ“‡ï¼š**asia-east1 (Taiwan)** æˆ– **asia-east2 (Hong Kong)**

**å»ºè­°**ï¼šé¸æ“‡ **asia-east2**
- è·é›¢å°ç£è¿‘ï¼Œé€Ÿåº¦å¿«
- Cloud Functions ä¹Ÿè¦é¸åŒæ¨£çš„å€åŸŸ

âš ï¸ **é‡è¦**ï¼šä½ç½®ä¸€æ—¦é¸å®šå°±ç„¡æ³•æ›´æ”¹ï¼

### 2-4. å»ºç«‹è³‡æ–™åº«

é»æ“Šã€Œå•Ÿç”¨ã€ï¼Œç­‰å¾…ç´„ 30 ç§’ã€‚

âœ… Firestore è³‡æ–™åº«å»ºç«‹æˆåŠŸï¼

## ğŸ’³ æ­¥é©Ÿä¸‰ï¼šå‡ç´šåˆ° Blaze æ–¹æ¡ˆ

### 3-1. ç‚ºä»€éº¼è¦å‡ç´šï¼Ÿ

å…è²»çš„ Spark æ–¹æ¡ˆ**ä¸èƒ½ä½¿ç”¨ Cloud Functions**ï¼

Blaze æ–¹æ¡ˆç‰¹é»ï¼š
- ä¾ç”¨é‡è¨ˆè²»
- å°å‹å°ˆæ¡ˆç´„ $0-5/æœˆ
- å¯ä»¥è¨­å®šé ç®—ä¸Šé™
- å¯ä»¥ä½¿ç”¨ Cloud Functions

### 3-2. å‡ç´šæ­¥é©Ÿ

1. é»æ“Šå·¦ä¸‹è§’çš„ã€ŒSparkã€æˆ–ã€Œå‡ç´šã€
2. é¸æ“‡ã€ŒBlaze æ–¹æ¡ˆã€
3. é¸æ“‡è¨ˆè²»å¸³æˆ¶ï¼ˆæˆ–å»ºç«‹æ–°çš„ï¼‰
4. è¼¸å…¥ä¿¡ç”¨å¡è³‡è¨Š
5. è¨­å®šé ç®—ä¸Šé™ï¼ˆå»ºè­°ï¼š$10/æœˆï¼‰
6. é»æ“Šã€Œç¹¼çºŒã€

âœ… å‡ç´šå®Œæˆï¼

## ğŸ”’ æ­¥é©Ÿå››ï¼šè¨­å®š Firestore å®‰å…¨è¦å‰‡

### 4-1. é€²å…¥è¦å‰‡ç·¨è¼¯å™¨

1. Firestore Database â†’ è¦å‰‡ï¼ˆRulesï¼‰
2. æ‚¨æœƒçœ‹åˆ°é è¨­çš„è¦å‰‡

### 4-2. è¨­å®š Platform å°ˆæ¡ˆè¦å‰‡

è¤‡è£½ä»¥ä¸‹è¦å‰‡ï¼Œè²¼åˆ°ç·¨è¼¯å™¨ï¼š

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ä½¿ç”¨è€…è³‡æ–™
    match /users/{userId} {
      // ä»»ä½•ç™»å…¥çš„ä½¿ç”¨è€…éƒ½å¯ä»¥è®€å–ä½¿ç”¨è€…åˆ—è¡¨
      allow read: if request.auth != null;
      
      // åªæœ‰æœ¬äººæˆ– superadmin å¯ä»¥å¯«å…¥
      allow write: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['superadmin'])
      );
    }
    
    // å…¬å‘Š
    match /announcements/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny(['superadmin', 'admin']);
    }
    
    // å…¶ä»–é›†åˆé è¨­æ‹’çµ•
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

### 4-3. ç™¼å¸ƒè¦å‰‡

é»æ“Šã€Œç™¼å¸ƒã€ã€‚

âœ… å®‰å…¨è¦å‰‡è¨­å®šå®Œæˆï¼

## ğŸ” æ­¥é©Ÿäº”ï¼šé‡è¤‡å»ºç«‹å…¶ä»–ä¸‰å€‹å°ˆæ¡ˆ

ä½¿ç”¨**å®Œå…¨ç›¸åŒçš„æ­¥é©Ÿ**å»ºç«‹å…¶ä»–ä¸‰å€‹å°ˆæ¡ˆï¼š

### å°ˆæ¡ˆ 2ï¼šCheckinï¼ˆç°½åˆ°ç³»çµ±ï¼‰

1. **å°ˆæ¡ˆåç¨±**ï¼š`é¾œé¦¬å±± Checkin`
2. **å°ˆæ¡ˆ ID**ï¼š`checkin-76c77`ï¼ˆæˆ–ç³»çµ±è‡ªå‹•ç”¢ç”Ÿçš„ï¼‰
3. **å•Ÿç”¨ Firestore**
4. **å€åŸŸ**ï¼šasia-east2ï¼ˆèˆ‡ Platform ç›¸åŒï¼‰
5. **å‡ç´šåˆ° Blaze æ–¹æ¡ˆ**
6. **è¨­å®šå®‰å…¨è¦å‰‡**ï¼ˆè¦‹ä¸‹æ–¹ï¼‰

**Checkin å°ˆæ¡ˆçš„å®‰å…¨è¦å‰‡**ï¼š
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—ä½¿ç”¨è€…è§’è‰²
    function getUserRoles() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    // è¼”åŠ©å‡½æ•¸ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    function isAdmin() {
      return getUserRoles().hasAny(['superadmin', 'admin_checkin']);
    }
    
    // ä½¿ç”¨è€…è³‡æ–™ï¼ˆå¾ Platform åŒæ­¥ï¼‰
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if false; // åªèƒ½å¾ Platform åŒæ­¥
    }
    
    // å·¡é‚é»
    match /patrols/{patrolId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }
    
    // ç°½åˆ°ç´€éŒ„
    match /checkins/{checkinId} {
      // ç®¡ç†å“¡å¯ä»¥çœ‹æ‰€æœ‰ç´€éŒ„
      allow read: if request.auth != null && (
        isAdmin() || 
        resource.data.userId == request.auth.uid
      );
      
      // åªæœ‰æœ¬äººå¯ä»¥å»ºç«‹ç°½åˆ°
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
      
      // åªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹/åˆªé™¤
      allow update, delete: if request.auth != null && isAdmin();
    }
  }
}
```

### å°ˆæ¡ˆ 3ï¼šServiceï¼ˆç¥å‹™æœå‹™ï¼‰

1. **å°ˆæ¡ˆåç¨±**ï¼š`é¾œé¦¬å±± Service`
2. **å°ˆæ¡ˆ ID**ï¼š`service-b9d4a`
3. å…¶ä»–æ­¥é©Ÿç›¸åŒ

### å°ˆæ¡ˆ 4ï¼šScheduleï¼ˆæ’ç­ç³»çµ±ï¼‰

1. **å°ˆæ¡ˆåç¨±**ï¼š`é¾œé¦¬å±± Schedule`
2. **å°ˆæ¡ˆ ID**ï¼š`schedule-48ff9`
3. å…¶ä»–æ­¥é©Ÿç›¸åŒ

## ğŸ“ æ­¥é©Ÿå…­ï¼šå–å¾—å°ˆæ¡ˆè¨­å®šå€¼

æ¯å€‹å°ˆæ¡ˆéƒ½éœ€è¦è¨˜éŒ„é€™äº›è³‡è¨Šï¼š

### 6-1. é€²å…¥å°ˆæ¡ˆè¨­å®š

1. é»æ“Šå·¦ä¸Šè§’çš„é½’è¼ªåœ–ç¤º
2. é¸æ“‡ã€Œå°ˆæ¡ˆè¨­å®šã€

### 6-2. æ–°å¢ç¶²é æ‡‰ç”¨ç¨‹å¼

1. å¾€ä¸‹æ²å‹•æ‰¾åˆ°ã€Œæ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€
2. é»æ“Š Web åœ–ç¤ºï¼ˆ`</>`ï¼‰
3. è¼¸å…¥æ‡‰ç”¨ç¨‹å¼åç¨±ï¼š`é¾œé¦¬å±± Web`
4. **ä¸è¦**å‹¾é¸ã€ŒåŒæ™‚è¨­å®š Firebase Hostingã€
5. é»æ“Šã€Œè¨»å†Šæ‡‰ç”¨ç¨‹å¼ã€

### 6-3. è¤‡è£½è¨­å®š

æ‚¨æœƒçœ‹åˆ°é¡ä¼¼é€™æ¨£çš„ç¨‹å¼ç¢¼ï¼š

```javascript
const firebaseConfig = {
  apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  authDomain: "platform-bc783.firebaseapp.com",
  projectId: "platform-bc783",
  storageBucket: "platform-bc783.appspot.com",
  messagingSenderId: "123456789012",
  appId: "1:123456789012:web:abcdef123456"
};
```

**âš ï¸ æŠŠé€™äº›è¨­å®šè¨˜éŒ„åˆ°ç­†è¨˜æœ¬ï¼**

### 6-4. å°æ‰€æœ‰å°ˆæ¡ˆé‡è¤‡

å° Platformã€Checkinã€Serviceã€Schedule å››å€‹å°ˆæ¡ˆéƒ½å–å¾—è¨­å®šå€¼ã€‚

## ğŸ” æ­¥é©Ÿä¸ƒï¼šå»ºç«‹æœå‹™å¸³æˆ¶é‡‘é‘°

### 7-1. é€²å…¥æœå‹™å¸³æˆ¶

1. å°ˆæ¡ˆè¨­å®š â†’ æœå‹™å¸³æˆ¶
2. é»æ“Šã€Œç”¢ç”Ÿæ–°çš„ç§å¯†é‡‘é‘°ã€
3. ç¢ºèªä¸¦ä¸‹è¼‰ JSON æª”æ¡ˆ

### 7-2. å¦¥å–„ä¿ç®¡é‡‘é‘°

- **çµ•å°ä¸è¦**ä¸Šå‚³åˆ° GitHub
- **çµ•å°ä¸è¦**åˆ†äº«çµ¦åˆ¥äºº
- å„²å­˜åœ¨å®‰å…¨çš„åœ°æ–¹
- ä¹‹å¾Œæœƒç”¨æ–¼éƒ¨ç½² Functions

## ğŸ“Š æ­¥é©Ÿå…«ï¼šè¨˜éŒ„æ‰€æœ‰è³‡è¨Š

è«‹å»ºç«‹ä¸€ä»½å®Œæ•´çš„è¨˜éŒ„ï¼š

```
=== Firebase å°ˆæ¡ˆè³‡è¨Š ===

ã€Platform å°ˆæ¡ˆã€‘
å°ˆæ¡ˆåç¨±: é¾œé¦¬å±± Platform
å°ˆæ¡ˆ ID: platform-bc783
å€åŸŸ: asia-east2
apiKey: AIzaSy...
authDomain: platform-bc783.firebaseapp.com
å»ºç«‹æ—¥æœŸ: [æ—¥æœŸ]

ã€Checkin å°ˆæ¡ˆã€‘
å°ˆæ¡ˆåç¨±: é¾œé¦¬å±± Checkin
å°ˆæ¡ˆ ID: checkin-76c77
å€åŸŸ: asia-east2
apiKey: AIzaSy...
authDomain: checkin-76c77.firebaseapp.com
å»ºç«‹æ—¥æœŸ: [æ—¥æœŸ]

ã€Service å°ˆæ¡ˆã€‘
å°ˆæ¡ˆåç¨±: é¾œé¦¬å±± Service
å°ˆæ¡ˆ ID: service-b9d4a
å€åŸŸ: asia-east2
å»ºç«‹æ—¥æœŸ: [æ—¥æœŸ]

ã€Schedule å°ˆæ¡ˆã€‘
å°ˆæ¡ˆåç¨±: é¾œé¦¬å±± Schedule
å°ˆæ¡ˆ ID: schedule-48ff9
å€åŸŸ: asia-east2
å»ºç«‹æ—¥æœŸ: [æ—¥æœŸ]

æœå‹™å¸³æˆ¶é‡‘é‘°: [å·²ä¸‹è¼‰ä¸¦å¦¥å–„ä¿ç®¡]
```

## âš ï¸ å¸¸è¦‹å•é¡Œ

### å•é¡Œ 1ï¼šç„¡æ³•å»ºç«‹å°ˆæ¡ˆ

**åŸå› **ï¼šå¯èƒ½é”åˆ°å°ˆæ¡ˆæ•¸é‡ä¸Šé™

**è§£æ±º**ï¼š
- å…è²»å¸³è™Ÿæœ‰å°ˆæ¡ˆæ•¸é‡é™åˆ¶
- åˆªé™¤ä¸ç”¨çš„èˆŠå°ˆæ¡ˆ
- æˆ–ä½¿ç”¨ä¸åŒçš„ Google å¸³è™Ÿ

### å•é¡Œ 2ï¼šæ‰¾ä¸åˆ° asia-east2

**åŸå› **ï¼šå¯èƒ½é¸éŒ¯æœå‹™

**è§£æ±º**ï¼š
- ç¢ºèªæ˜¯ Firestoreï¼ˆä¸æ˜¯ Realtime Databaseï¼‰
- asia-east2 åœ¨ Firestore å¯ç”¨

### å•é¡Œ 3ï¼šå‡ç´šå¤±æ•—

**åŸå› **ï¼šä¿¡ç”¨å¡é©—è­‰å•é¡Œ

**è§£æ±º**ï¼š
- æª¢æŸ¥ä¿¡ç”¨å¡è³‡æ–™æ˜¯å¦æ­£ç¢º
- ç¢ºèªä¿¡ç”¨å¡æ”¯æ´åœ‹éš›äº¤æ˜“
- å˜—è©¦å…¶ä»–ä¿¡ç”¨å¡

## âœ… å®Œæˆæª¢æŸ¥æ¸…å–®

è«‹ç¢ºèªï¼š
- [ ] å»ºç«‹äº†å››å€‹ Firebase å°ˆæ¡ˆ
- [ ] æ‰€æœ‰å°ˆæ¡ˆéƒ½å•Ÿç”¨äº† Firestore
- [ ] æ‰€æœ‰å°ˆæ¡ˆéƒ½å‡ç´šåˆ° Blaze æ–¹æ¡ˆ
- [ ] æ‰€æœ‰å°ˆæ¡ˆéƒ½é¸æ“‡ asia-east2 å€åŸŸ
- [ ] Platform å’Œ Checkin éƒ½è¨­å®šäº†å®‰å…¨è¦å‰‡
- [ ] å–å¾—ä¸¦è¨˜éŒ„äº†æ‰€æœ‰å°ˆæ¡ˆçš„è¨­å®šå€¼
- [ ] ä¸‹è¼‰ä¸¦å¦¥å–„ä¿ç®¡æœå‹™å¸³æˆ¶é‡‘é‘°

## ğŸ“ ä¸‹ä¸€æ­¥

Firebase å°ˆæ¡ˆéƒ½å»ºç«‹å¥½äº†ï¼æ¥ä¸‹ä¾†è¦éƒ¨ç½² Cloud Functionsï¼š

â¡ï¸ **ä¸‹ä¸€ç« ï¼š07-Firebase-Functions-éƒ¨ç½².md**

åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘å€‘æœƒæŠŠå¾Œç«¯ç¨‹å¼éƒ¨ç½²åˆ° Firebaseï¼Œè®“ç¶²ç«™å¯ä»¥é‹ä½œã€‚

---

ğŸ’¡ **å°æç¤º**ï¼š
- å››å€‹å°ˆæ¡ˆè¦é¸**ç›¸åŒçš„å€åŸŸ**ï¼ˆasia-east2ï¼‰
- å®šæœŸæª¢æŸ¥ Firebase ä½¿ç”¨é‡å’Œè²»ç”¨
- å¯ä»¥åœ¨ Firebase Console è¨­å®šé ç®—æé†’
- æœå‹™å¸³æˆ¶é‡‘é‘°éå¸¸é‡è¦ï¼Œä¸€å®šè¦å¦¥å–„ä¿ç®¡ï¼
