# 01 - 系統架構說明

> 在開始動手之前，先了解整個系統是如何運作的，就像組樂高前先看說明書上的完成圖。

## 🏗️ 系統整體架構

「龜馬山 goLine 平台」是一個整合 LINE 的數位化管理系統，包含四個主要模組：

```
┌─────────────────────────────────────────────────┐
│           LINE 官方帳號 (@495fdqrw)              │
│  使用者從 LINE 聊天室進入系統                     │
└─────────────┬───────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────┐
│         goLine 平台入口                          │
│     (https://go.guimashan.org.tw)               │
│  • LINE Login 登入                               │
│  • 顯示可用模組（依權限）                         │
└─────────────┬───────────────────────────────────┘
              │
              ├─────────┬─────────┬─────────┐
              ▼         ▼         ▼         ▼
         ┌────────┐┌────────┐┌────────┐┌────────┐
         │奉香簽到││神務服務││排班系統││系統管理│
         │        ││        ││        ││        │
         │GPS簽到 ││法會報名││志工排班││使用者  │
         │巡邏點  ││服務管理││出勤統計││權限管理│
         └────────┘└────────┘└────────┘└────────┘
```

## 🧩 技術組成（就像樂高的零件）

### 1. LINE 平台（使用者入口）
- **LINE Login** - 讓使用者用 LINE 帳號登入網頁
- **LIFF** - 在 LINE 聊天室內開啟網頁（不用跳出 LINE）
- **Messaging API** - LINE 官方帳號機器人（自動回覆）

### 2. Firebase 平台（後端系統）
我們使用**四個**獨立的 Firebase 專案：

| 專案名稱 | 專案 ID | 負責什麼 | 狀態 |
|---------|---------|---------|------|
| Platform | platform-bc783 | 登入、使用者資料、權限管理 | ✅ 已完成 |
| Checkin | checkin-76c77 | GPS 簽到、巡邏點資料 | ✅ 已完成 |
| Service | service-b9d4a | 神務服務、法會報名 | ⏳ 待開發 |
| Schedule | schedule-48ff9 | 志工排班、出勤紀錄 | ⏳ 待開發 |

**為什麼要分成四個專案？**
- 資料分開管理，更安全
- 每個模組可以獨立開發和部署
- 出問題時不會影響其他模組
- 容易控制各模組的權限

### 3. Vercel（前端部署平台）
- 免費部署靜態網站
- 自動從 GitHub 更新
- 支援自訂網域（go.guimashan.org.tw）

## 🔄 使用者使用流程

### 流程 1：網頁登入（適合電腦使用）

```
使用者 → 開啟網址 → LINE Login 登入 → 選擇模組 → 使用功能
```

**詳細步驟：**
1. 使用者打開 https://go.guimashan.org.tw
2. 點擊「LINE 登入」按鈕
3. LINE 跳出授權畫面，使用者點「同意」
4. 系統取得使用者的 LINE 資料（名稱、頭像）
5. 建立使用者帳號並分配權限
6. 顯示使用者可以使用的模組（例如：奉香簽到、神務服務）
7. 使用者點擊模組開始使用

### 流程 2：LINE 內使用（適合手機使用）

```
使用者 → LINE 聊天室 → 輸入關鍵字 → 開啟 LIFF → 使用功能
```

**詳細步驟：**
1. 使用者在 LINE 加入龜馬山官方帳號（@495fdqrw）
2. 在聊天室輸入關鍵字，例如：「奉香簽到」
3. 機器人自動回覆 LIFF 連結
4. 使用者點擊連結，在 LINE 內開啟網頁
5. 自動登入（因為已經在 LINE 裡面了）
6. 直接使用功能（例如：GPS 簽到）

## 🔐 權限系統

### 使用者角色
每個使用者可以有多個角色（就像遊戲裡的多重職業）：

| 角色 | 說明 | 可以做什麼 |
|------|------|----------|
| `user` | 一般使用者 | 基本功能（簽到、查看自己的紀錄） |
| `poweruser` | 進階使用者 | 可以建立服務單 |
| `admin_checkin` | 簽到管理員 | 管理簽到系統（巡邏點、查看所有紀錄） |
| `admin_service` | 神務管理員 | 管理神務系統 |
| `admin_schedule` | 排班管理員 | 管理排班系統 |
| `superadmin` | 超級管理員 | 所有權限 |

**範例：**
- 小明的角色：`["user"]` - 只能簽到和看自己的紀錄
- 小華的角色：`["user", "poweruser", "admin_checkin"]` - 可以簽到、建立服務單、管理簽到系統

## 📊 資料流動

### 簽到功能的資料流（範例）

```
1. 使用者在手機上開啟 LIFF 簽到頁面
   ↓
2. 手機取得目前的 GPS 座標（例如：24.1375, 120.6736）
   ↓
3. 選擇巡邏點（例如：廟公室）
   ↓
4. 點擊「簽到」按鈕
   ↓
5. 前端送出請求到 Firebase Functions
   資料包含：使用者 ID、巡邏點 ID、GPS 座標
   ↓
6. Cloud Function 驗證：
   - 檢查使用者是否登入
   - 計算距離：使用者座標 vs 巡邏點座標
   - 判斷是否在範圍內（例如：50 公尺內）
   ↓
7. 如果通過驗證：
   - 寫入 Firestore 資料庫
   - 回傳成功訊息
   ↓
8. 前端顯示「簽到成功！」
```

## 💾 資料儲存位置

### Platform 專案資料庫
```
users/                    # 使用者資料
  └─ {userId}/
      ├─ displayName      # 顯示名稱
      ├─ email           # Email（可選）
      ├─ photoURL        # 頭像網址
      ├─ lineUserId      # LINE 使用者 ID
      └─ roles[]         # 角色陣列
```

### Checkin 專案資料庫
```
patrols/                  # 巡邏點
  └─ {patrolId}/
      ├─ name            # 名稱（例如：廟公室）
      ├─ lat, lng        # GPS 座標
      ├─ radius          # 容許範圍（公尺）
      └─ qr              # QR Code 內容

checkins/                 # 簽到紀錄
  └─ {checkinId}/
      ├─ userId          # 誰簽到的
      ├─ patrolId        # 在哪裡簽到
      ├─ timestamp       # 什麼時候
      ├─ distance        # 距離（公尺）
      └─ mode            # 方式（gps/qr）
```

## 🎨 前端設計規範

### 顏色配置
- **主色**：金黃色 `#D4AF37`（象徵廟宇的莊嚴）
- **輔色**：深金色 `#B8941F`
- **背景**：米白色 `#F5F0E8`
- **文字**：深褐色 `#2C2416`

### 字體
- **主要字體**：Noto Sans TC（思源黑體繁體中文）
- 清楚好讀，支援繁體中文

## 🔧 開發工具

### 必備工具
1. **GitHub** - 程式碼版本控制
2. **Replit** - 線上開發環境（目前使用中）
3. **Firebase Console** - 管理後端專案
4. **LINE Developers** - 管理 LINE 整合
5. **Vercel** - 部署前端網站

### 瀏覽器工具
- **開發者工具**（F12）- 除錯用
- **Network 分頁** - 查看 API 請求
- **Console 分頁** - 查看錯誤訊息

## ✅ 檢查清單

在開始之前，請確認您了解：
- [ ] 整個系統有四個模組（簽到、神務、排班、管理）
- [ ] LINE 有三個功能（Login、LIFF、Messaging API）
- [ ] Firebase 有四個專案，每個專案負責不同功能
- [ ] 使用者有不同的角色和權限
- [ ] 資料會分開儲存在不同的專案裡

## 🎓 下一步

現在您已經了解整個系統的架構，接下來：

➡️ **下一章：02-需要準備的帳號和工具.md**

在下一章，我們會教您註冊所有需要的帳號，準備好開發環境。

---

💡 **小提示**：如果有任何不清楚的地方，建議您多看幾遍這一章，或是畫出自己的架構圖幫助理解。理解架構後，後面的開發會輕鬆很多！
