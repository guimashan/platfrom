# 13 - 常見問題解決

> 收集常見問題和解決方法，幫助您快速除錯。

## 🎯 本章目標

完成本章後，您將能夠：
- 快速診斷問題
- 查找解決方法
- 使用除錯工具
- 知道何時尋求協助

## 🔧 LINE 相關問題

### ❌ LINE Login 失敗

**症狀**：點擊「LINE 登入」後出現錯誤

**可能原因 1**：Callback URL 設定錯誤
```
解決方法：
1. 前往 LINE Developers Console
2. LINE Login Channel → LINE Login 設定
3. 檢查 Callback URL 是否包含：
   https://go.guimashan.org.tw/callback.html
4. 確認沒有多餘空格、拼字正確
```

**可能原因 2**：Channel ID 錯誤
```
解決方法：
1. 檢查 public/js/config.js
2. 確認 LINE_LOGIN_CHANNEL_ID 正確
3. 對照 LINE Developers Console 的 Channel ID
```

**可能原因 3**：使用者拒絕授權
```
解決方法：
使用者需要重新點擊登入，並同意授權
```

### ❌ LIFF 無法開啟

**症狀**：點擊 LIFF 連結後顯示錯誤

**可能原因 1**：LIFF ID 錯誤
```javascript
// 檢查 public/liff/checkin.html
const LIFF_ID = '2008269293-Nl2pZBpV';

// 對照 LINE Developers Console
// LINE Login → LIFF → 查看 LIFF ID
```

**可能原因 2**：Endpoint URL 錯誤
```
解決方法：
1. LINE Developers Console → LIFF 設定
2. 檢查 Endpoint URL：
   https://go.guimashan.org.tw/liff/checkin.html
3. 確認該網址可以直接在瀏覽器開啟
```

**可能原因 3**：在瀏覽器開啟而非 LINE
```
解決方法：
LIFF 只能在 LINE App 內開啟
請用手機 LINE 點擊連結
```

### ❌ Webhook 驗證失敗

**症狀**：LINE Developers Console 驗證 Webhook 失敗

**可能原因 1**：Functions 還沒部署
```bash
# 部署 Functions
firebase deploy --only functions:lineWebhook --project platform-bc783

# 確認部署成功
firebase functions:log --project platform-bc783
```

**可能原因 2**：Webhook URL 錯誤
```
正確格式：
https://asia-east2-platform-bc783.cloudfunctions.net/lineWebhook

常見錯誤：
- 少了 https://
- 區域錯誤（asia-east1 vs asia-east2）
- 專案 ID 錯誤
- Function 名稱錯誤
```

**可能原因 3**：Signature 驗證失敗
```
檢查：
1. LINE_MESSAGING_CHANNEL_SECRET 是否正確
2. Firebase Secrets 是否已設定
3. Function 程式碼是否有錯誤
```

## 🔥 Firebase 相關問題

### ❌ Permission Denied

**症狀**：Firestore 操作被拒絕

**可能原因 1**：安全規則太嚴格
```javascript
// 檢查 Firestore Rules
// Firebase Console → Firestore → Rules

// 測試模式（僅開發時使用）：
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
```

**可能原因 2**：使用者未登入
```javascript
// 確認使用者已登入
firebase.auth().onAuthStateChanged((user) => {
  if (user) {
    console.log('已登入：', user.uid);
  } else {
    console.log('未登入');
    window.location.href = '/index.html';
  }
});
```

**可能原因 3**：權限不足
```
檢查：
1. Firestore 的 users 集合
2. 查看該使用者的 roles 欄位
3. 確認包含所需的角色
```

### ❌ Functions 逾時

**症狀**：Function execution timeout

**可能原因**：函數執行時間超過 60 秒

**解決方法**：
```javascript
// functions/src/index.js
exports.myFunction = functions
  .runWith({ 
    timeoutSeconds: 120,  // 增加到 120 秒
    memory: '512MB'       // 增加記憶體
  })
  .https.onRequest(app);
```

### ❌ 無法部署 Functions

**症狀**：`firebase deploy` 失敗

**可能原因 1**：未登入
```bash
firebase logout
firebase login
```

**可能原因 2**：專案 ID 錯誤
```bash
# 查看可用專案
firebase projects:list

# 切換專案
firebase use platform-bc783
```

**可能原因 3**：套件錯誤
```bash
cd functions
rm -rf node_modules
npm install
cd ..
firebase deploy --only functions
```

## 🌐 Vercel 相關問題

### ❌ 網站 404

**症狀**：網站顯示 Page Not Found

**可能原因**：Output Directory 設定錯誤

**解決方法**：
```
1. Vercel Dashboard → 專案設定
2. Settings → General
3. Build & Development Settings
4. Output Directory: public
5. 儲存並重新部署
```

### ❌ 部署失敗

**症狀**：Vercel 部署顯示失敗

**解決方法**：
```
1. Vercel Dashboard → Deployments
2. 點擊失敗的部署
3. 查看錯誤訊息
4. 常見原因：
   - package.json 錯誤
   - build 指令錯誤
   - 檔案路徑錯誤
```

### ❌ 修改沒有生效

**症狀**：推送程式碼但網站沒變化

**解決方法**：
```
1. 確認 GitHub 有收到 push：
   查看 GitHub 倉庫的 commits

2. 確認 Vercel 有觸發部署：
   Vercel Dashboard → Deployments

3. 清除瀏覽器快取：
   Ctrl+Shift+R (Windows)
   Cmd+Shift+R (Mac)

4. 等待 CDN 更新（約 1-2 分鐘）
```

## 💾 資料相關問題

### ❌ 簽到失敗

**症狀**：簽到時顯示錯誤

**可能原因 1**：GPS 定位失敗
```javascript
// 檢查瀏覽器 Console
// 查看 getCurrentPosition 錯誤

// 確認：
1. 網站使用 HTTPS
2. 使用者允許定位權限
3. 裝置有 GPS 功能
```

**可能原因 2**：距離過遠
```
檢查：
1. 實際距離是否在範圍內（預設 50 公尺）
2. 巡邏點座標是否正確
3. 可以調整 radius 參數
```

**可能原因 3**：API 錯誤
```bash
# 查看 Functions Logs
firebase functions:log --project checkin-76c77 --only checkinApi

# 檢查錯誤訊息
```

### ❌ 資料沒有顯示

**症狀**：頁面空白或資料列表是空的

**解決方法**：
```javascript
// 1. 檢查 Console 是否有錯誤
console.log('載入資料...');

// 2. 確認 Firestore 有資料
// Firebase Console → Firestore → 檢查集合

// 3. 檢查查詢條件
const snapshot = await db.collection('checkins')
  .where('userId', '==', currentUser.uid)
  .get();

console.log('查詢結果：', snapshot.size);

// 4. 檢查權限
// Firestore Rules 是否允許讀取
```

## 🐛 除錯工具

### Chrome DevTools

**開啟方式**：按 F12 或右鍵 → 檢查

**Console 分頁**：
```javascript
// 查看錯誤訊息
console.error('錯誤訊息');

// 檢查變數值
console.log('使用者資料：', userData);

// 追蹤執行流程
console.log('步驟 1：載入資料');
console.log('步驟 2：處理資料');
```

**Network 分頁**：
```
查看 API 請求：
1. 開啟 Network 分頁
2. 重新整理頁面
3. 查看每個請求：
   - Status（狀態碼）
   - Response（回應內容）
   - Headers（標頭）
```

**Application 分頁**：
```
查看儲存資料：
1. Local Storage - 本機儲存
2. Session Storage - 會話儲存
3. Cookies - Cookie
4. IndexedDB - Firebase 本機快取
```

### Firebase Console

**Functions Logs**：
```
Firebase Console → Functions → Logs

篩選條件：
- 時間範圍
- 嚴重程度（Error, Warning, Info）
- Function 名稱

常見錯誤訊息：
- "Permission denied" - 權限問題
- "Timeout" - 逾時
- "Cannot find module" - 套件問題
```

**Firestore**：
```
Firebase Console → Firestore Database

檢查：
1. 資料是否存在
2. 欄位是否正確
3. 權限規則是否正確
```

### 指令工具

**Firebase CLI**：
```bash
# 查看 Logs
firebase functions:log --project platform-bc783

# 即時監看
firebase functions:log --project platform-bc783 --follow

# 只看錯誤
firebase functions:log --project platform-bc783 | grep Error
```

**Git**：
```bash
# 查看修改
git status
git diff

# 查看歷史
git log --oneline

# 回到之前的版本
git checkout <commit-id>
```

## 📞 尋求協助

### 自己除錯步驟

1. **查看錯誤訊息**
   - Console 錯誤
   - Functions Logs
   - Network 請求

2. **重現問題**
   - 記錄操作步驟
   - 截圖或錄影

3. **查找資料**
   - 搜尋錯誤訊息
   - 查看文件
   - 參考範例

4. **嘗試解決**
   - 修改程式碼
   - 測試
   - 記錄結果

### 何時尋求協助

- 嘗試超過 30 分鐘仍無法解決
- 涉及安全性問題
- 可能影響正式環境
- 不確定解決方法的風險

### 提問技巧

**好的提問**：
```
問題：簽到功能在 iOS 上無法使用

環境：
- 裝置：iPhone 12, iOS 16
- 瀏覽器：LINE 內建瀏覽器
- 網址：https://go.guimashan.org.tw/liff/checkin.html

錯誤訊息：
"getCurrentPosition failed: User denied Geolocation"

已嘗試：
1. 確認 LINE 有定位權限
2. 清除快取重新開啟
3. 其他手機正常

請問可能是什麼原因？
```

**不好的提問**：
```
簽到壞了，怎麼辦？
```

## ✅ 除錯檢查清單

遇到問題時，依序檢查：

**前端問題**：
- [ ] Console 有錯誤訊息嗎？
- [ ] Network 請求有失敗嗎？
- [ ] JavaScript 語法正確嗎？
- [ ] Firebase 設定正確嗎？

**後端問題**：
- [ ] Functions 有部署嗎？
- [ ] Logs 有錯誤訊息嗎？
- [ ] Secrets 有設定嗎？
- [ ] 權限規則正確嗎？

**資料問題**：
- [ ] Firestore 有資料嗎？
- [ ] 查詢條件正確嗎？
- [ ] 權限允許讀寫嗎？
- [ ] 資料格式正確嗎？

**LINE 問題**：
- [ ] Channel ID 正確嗎？
- [ ] Callback URL 正確嗎？
- [ ] LIFF ID 正確嗎？
- [ ] Webhook 驗證成功嗎？

## 🎓 結語

恭喜您完成整本教學手冊！🎉

現在您已經學會：
- ✅ LINE 平台的完整設定
- ✅ Firebase 後端系統
- ✅ 開發新功能
- ✅ 管理權限
- ✅ 維護和更新
- ✅ 處理常見問題

**持續學習**：
- 遇到新問題時記錄解決方法
- 定期更新系統和套件
- 關注 Firebase 和 LINE 的更新
- 參考官方文件和社群資源

**回顧手冊**：
- 需要時隨時翻閱
- 把實際經驗補充進來
- 分享給其他開發者

祝您開發順利！如有問題，隨時回來查閱這本手冊。💪

---

💡 **最後提醒**：
- 遇到問題不要慌張
- 系統性地除錯
- 保持學習的心態
- 記錄解決過程
- 適時尋求協助
