# 09 - é–‹ç™¼ç¬¬ä¸€å€‹æ¨¡çµ„

> è·Ÿè‘—ç¯„ä¾‹ä¸€æ­¥ä¸€æ­¥é–‹ç™¼æ–°åŠŸèƒ½ï¼Œå¾å‰ç«¯åˆ°å¾Œç«¯å®Œæ•´å¯¦ä½œã€‚

## ğŸ¯ æœ¬ç« ç›®æ¨™

å®Œæˆæœ¬ç« å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š
- è¦åŠƒä¸€å€‹æ–°æ¨¡çµ„çš„åŠŸèƒ½
- å»ºç«‹å‰ç«¯é é¢
- é–‹ç™¼å¾Œç«¯ API
- æ•´åˆå‰å¾Œç«¯
- æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸

## ğŸ“‹ ç¯„ä¾‹ï¼šé–‹ç™¼ã€Œå…¬å‘Šæ¨¡çµ„ã€

æˆ‘å€‘è¦é–‹ç™¼ä¸€å€‹å…¬å‘Šç³»çµ±ï¼Œè®“ç®¡ç†å“¡å¯ä»¥ç™¼å¸ƒå…¬å‘Šï¼Œä½¿ç”¨è€…å¯ä»¥æŸ¥çœ‹ã€‚

### åŠŸèƒ½éœ€æ±‚

**ç®¡ç†å“¡å¯ä»¥**ï¼š
- ç™¼å¸ƒæ–°å…¬å‘Š
- ç·¨è¼¯å…¬å‘Š
- åˆªé™¤å…¬å‘Š

**ä¸€èˆ¬ä½¿ç”¨è€…å¯ä»¥**ï¼š
- æŸ¥çœ‹æ‰€æœ‰å…¬å‘Š
- æŸ¥çœ‹å…¬å‘Šè©³æƒ…

## ğŸ¨ æ­¥é©Ÿä¸€ï¼šè¨­è¨ˆè³‡æ–™çµæ§‹

### 1-1. Firestore è³‡æ–™çµæ§‹

```
announcements/                 # å…¬å‘Šé›†åˆ
  â””â”€ {announcementId}/        # å…¬å‘Šæ–‡ä»¶
      â”œâ”€ title                # æ¨™é¡Œ
      â”œâ”€ content              # å…§å®¹
      â”œâ”€ author               # ä½œè€…ï¼ˆuserIdï¼‰
      â”œâ”€ authorName           # ä½œè€…åç¨±
      â”œâ”€ createdAt            # å»ºç«‹æ™‚é–“
      â”œâ”€ updatedAt            # æ›´æ–°æ™‚é–“
      â””â”€ isActive             # æ˜¯å¦å•Ÿç”¨
```

### 1-2. å»ºç«‹æ¸¬è©¦è³‡æ–™

åœ¨ Firebase Consoleï¼š
1. é¸æ“‡ Platform å°ˆæ¡ˆ
2. Firestore Database
3. æ–°å¢é›†åˆï¼š`announcements`
4. æ–°å¢æ–‡ä»¶ï¼š

```json
{
  "title": "æ­¡è¿ä½¿ç”¨ goLine å¹³å°",
  "content": "é€™æ˜¯ç¬¬ä¸€å‰‡å…¬å‘Š",
  "author": "system",
  "authorName": "ç³»çµ±ç®¡ç†å“¡",
  "createdAt": "2025-11-02T10:00:00Z",
  "updatedAt": "2025-11-02T10:00:00Z",
  "isActive": true
}
```

## ğŸ“„ æ­¥é©ŸäºŒï¼šå»ºç«‹å‰ç«¯é é¢

### 2-1. å»ºç«‹è³‡æ–™å¤¾çµæ§‹

```bash
mkdir -p public/announcements/js
```

### 2-2. å»ºç«‹ HTML é é¢

å»ºç«‹ `public/announcements/index.html`ï¼š

```html
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å‘Šç®¡ç† - é¾œé¦¬å±± goLine</title>
    <link rel="stylesheet" href="../styles/common.css">
    <style>
        .announcement-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .announcement-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .announcement-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        .announcement-content {
            line-height: 1.6;
            color: var(--text-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“¢ å…¬å‘Šç®¡ç†</h1>
        
        <!-- æ–°å¢å…¬å‘ŠæŒ‰éˆ•ï¼ˆåªæœ‰ç®¡ç†å“¡çœ‹å¾—åˆ°ï¼‰ -->
        <div id="adminActions" style="display: none;">
            <button class="primary-btn" onclick="showCreateForm()">
                â• æ–°å¢å…¬å‘Š
            </button>
        </div>

        <!-- å…¬å‘Šåˆ—è¡¨ -->
        <div id="announcementsList"></div>

        <!-- æ–°å¢å…¬å‘Šè¡¨å–® -->
        <div id="createForm" style="display: none;">
            <div class="form-card">
                <h2>æ–°å¢å…¬å‘Š</h2>
                <input type="text" id="title" placeholder="å…¬å‘Šæ¨™é¡Œ" class="input-field">
                <textarea id="content" placeholder="å…¬å‘Šå…§å®¹" class="input-field" rows="5"></textarea>
                <button class="primary-btn" onclick="createAnnouncement()">ç™¼å¸ƒ</button>
                <button class="secondary-btn" onclick="hideCreateForm()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- è¨­å®šæª” -->
    <script src="../js/config.js"></script>
    
    <!-- åŠŸèƒ½ç¨‹å¼ -->
    <script src="js/announcements.js"></script>
</body>
</html>
```

### 2-3. å»ºç«‹ JavaScript åŠŸèƒ½

å»ºç«‹ `public/announcements/js/announcements.js`ï¼š

```javascript
// åˆå§‹åŒ–
let currentUser = null;
let db = null;

// é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
document.addEventListener('DOMContentLoaded', async () => {
    // åˆå§‹åŒ– Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();

    // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            await loadUserData();
            await loadAnnouncements();
        } else {
            window.location.href = '/index.html';
        }
    });
});

// è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
async function loadUserData() {
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.data();
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    if (userData.roles && userData.roles.includes('admin')) {
        document.getElementById('adminActions').style.display = 'block';
    }
}

// è¼‰å…¥å…¬å‘Šåˆ—è¡¨
async function loadAnnouncements() {
    const snapshot = await db.collection('announcements')
        .where('isActive', '==', true)
        .orderBy('createdAt', 'desc')
        .get();

    const container = document.getElementById('announcementsList');
    container.innerHTML = '';

    snapshot.forEach(doc => {
        const announcement = doc.data();
        const card = createAnnouncementCard(doc.id, announcement);
        container.appendChild(card);
    });

    if (snapshot.empty) {
        container.innerHTML = '<p style="text-align: center; color: #999;">ç›®å‰æ²’æœ‰å…¬å‘Š</p>';
    }
}

// å»ºç«‹å…¬å‘Šå¡ç‰‡
function createAnnouncementCard(id, announcement) {
    const card = document.createElement('div');
    card.className = 'announcement-card';
    
    const date = new Date(announcement.createdAt).toLocaleDateString('zh-TW');
    
    card.innerHTML = `
        <div class="announcement-title">${announcement.title}</div>
        <div class="announcement-meta">
            ğŸ‘¤ ${announcement.authorName} | ğŸ“… ${date}
        </div>
        <div class="announcement-content">${announcement.content}</div>
    `;
    
    return card;
}

// é¡¯ç¤ºæ–°å¢è¡¨å–®
function showCreateForm() {
    document.getElementById('createForm').style.display = 'block';
}

// éš±è—æ–°å¢è¡¨å–®
function hideCreateForm() {
    document.getElementById('createForm').style.display = 'none';
    document.getElementById('title').value = '';
    document.getElementById('content').value = '';
}

// å»ºç«‹å…¬å‘Š
async function createAnnouncement() {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();

    if (!title || !content) {
        alert('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹');
        return;
    }

    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();

        await db.collection('announcements').add({
            title: title,
            content: content,
            author: currentUser.uid,
            authorName: userData.displayName || 'åŒ¿å',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            isActive: true
        });

        alert('å…¬å‘Šç™¼å¸ƒæˆåŠŸï¼');
        hideCreateForm();
        await loadAnnouncements();
    } catch (error) {
        console.error('ç™¼å¸ƒå¤±æ•—ï¼š', error);
        alert('ç™¼å¸ƒå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
}
```

## ğŸ”§ æ­¥é©Ÿä¸‰ï¼šåŠ å…¥ Dashboard

### 3-1. æ›´æ–° dashboard.html

åœ¨ `public/dashboard.html` çš„æ¨¡çµ„åˆ—è¡¨åŠ å…¥ï¼š

```html
<div class="module-card" onclick="window.location.href='announcements/index.html'">
    <div class="module-icon">ğŸ“¢</div>
    <div class="module-name">å…¬å‘Šç®¡ç†</div>
    <div class="module-desc">æŸ¥çœ‹å’Œç®¡ç†å…¬å‘Š</div>
</div>
```

## âš™ï¸ æ­¥é©Ÿå››ï¼šé–‹ç™¼å¾Œç«¯ APIï¼ˆé¸ç”¨ï¼‰

å¦‚æœéœ€è¦æ›´è¤‡é›œçš„åŠŸèƒ½ï¼ˆä¾‹å¦‚ï¼šæ¬Šé™æª¢æŸ¥ã€è³‡æ–™é©—è­‰ï¼‰ï¼Œå¯ä»¥å»ºç«‹ APIã€‚

### 4-1. å»ºç«‹ API æª”æ¡ˆ

å»ºç«‹ `functions/src/announcements/index.js`ï¼š

```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const express = require('express');
const cors = require('cors')({ origin: true });

const app = express();
app.use(cors);
app.use(express.json());

// é©—è­‰ä¸­ä»‹å±¤
async function authenticate(req, res, next) {
    const token = req.headers.authorization?.split('Bearer ')[1];
    if (!token) {
        return res.status(401).json({ error: 'æœªæˆæ¬Š' });
    }
    
    try {
        const decodedToken = await admin.auth().verifyIdToken(token);
        req.user = decodedToken;
        next();
    } catch (error) {
        res.status(401).json({ error: 'ç„¡æ•ˆçš„ Token' });
    }
}

// å–å¾—å…¬å‘Šåˆ—è¡¨
app.get('/announcements', authenticate, async (req, res) => {
    try {
        const snapshot = await admin.firestore()
            .collection('announcements')
            .where('isActive', '==', true)
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();

        const announcements = [];
        snapshot.forEach(doc => {
            announcements.push({
                id: doc.id,
                ...doc.data()
            });
        });

        res.json({ success: true, data: announcements });
    } catch (error) {
        console.error('å–å¾—å…¬å‘Šå¤±æ•—ï¼š', error);
        res.status(500).json({ error: 'ä¼ºæœå™¨éŒ¯èª¤' });
    }
});

// å»ºç«‹å…¬å‘Š
app.post('/announcements', authenticate, async (req, res) => {
    try {
        const { title, content } = req.body;
        
        // é©—è­‰è³‡æ–™
        if (!title || !content) {
            return res.status(400).json({ error: 'ç¼ºå°‘å¿…è¦æ¬„ä½' });
        }

        // æª¢æŸ¥æ¬Šé™
        const userDoc = await admin.firestore()
            .collection('users')
            .doc(req.user.uid)
            .get();
        
        const userData = userDoc.data();
        if (!userData.roles || !userData.roles.includes('admin')) {
            return res.status(403).json({ error: 'æ¬Šé™ä¸è¶³' });
        }

        // å»ºç«‹å…¬å‘Š
        const announcement = {
            title,
            content,
            author: req.user.uid,
            authorName: userData.displayName || 'åŒ¿å',
            createdAt: admin.firestore.FieldValue.serverTimestamp(),
            updatedAt: admin.firestore.FieldValue.serverTimestamp(),
            isActive: true
        };

        const docRef = await admin.firestore()
            .collection('announcements')
            .add(announcement);

        res.json({ success: true, id: docRef.id });
    } catch (error) {
        console.error('å»ºç«‹å…¬å‘Šå¤±æ•—ï¼š', error);
        res.status(500).json({ error: 'ä¼ºæœå™¨éŒ¯èª¤' });
    }
});

exports.announcementsApi = functions.https.onRequest(app);
```

### 4-2. æ›´æ–° index.js

åœ¨ `functions/src/index.js` åŠ å…¥ï¼š

```javascript
const announcements = require('./announcements');
exports.announcementsApi = announcements.announcementsApi;
```

### 4-3. éƒ¨ç½² Functions

```bash
firebase deploy --only functions:announcementsApi --project platform-bc783
```

## ğŸ§ª æ­¥é©Ÿäº”ï¼šæ¸¬è©¦åŠŸèƒ½

### 5-1. æœ¬æ©Ÿæ¸¬è©¦

```bash
cd public
npx http-server -p 5000
```

æ‰“é–‹ï¼šhttp://localhost:5000/announcements/

### 5-2. æ¸¬è©¦é …ç›®

**ä¸€èˆ¬ä½¿ç”¨è€…**ï¼š
- [ ] å¯ä»¥çœ‹åˆ°å…¬å‘Šåˆ—è¡¨
- [ ] çœ‹ä¸åˆ°ã€Œæ–°å¢å…¬å‘Šã€æŒ‰éˆ•
- [ ] å¯ä»¥çœ‹åˆ°å…¬å‘Šå…§å®¹

**ç®¡ç†å“¡**ï¼š
- [ ] å¯ä»¥çœ‹åˆ°ã€Œæ–°å¢å…¬å‘Šã€æŒ‰éˆ•
- [ ] å¯ä»¥æ–°å¢å…¬å‘Š
- [ ] æ–°å¢å¾Œç«‹å³é¡¯ç¤ºåœ¨åˆ—è¡¨

### 5-3. æª¢æŸ¥ Firestore

åœ¨ Firebase Console ç¢ºèªï¼š
- æ–°å¢çš„å…¬å‘Šæœ‰æ­£ç¢ºå¯«å…¥
- è³‡æ–™çµæ§‹æ­£ç¢º
- æ™‚é–“æˆ³è¨˜æ­£ç¢º

## ğŸ“Š æ­¥é©Ÿå…­ï¼šæ–°å¢ LIFF ç‰ˆæœ¬ï¼ˆé¸ç”¨ï¼‰

å»ºç«‹ `public/liff/announcements.html`ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥åœ¨ LINE å…§æŸ¥çœ‹å…¬å‘Šã€‚

## âœ… é–‹ç™¼æª¢æŸ¥æ¸…å–®

å®Œæˆä¸€å€‹æ¨¡çµ„éœ€è¦ï¼š
- [ ] è¦åŠƒè³‡æ–™çµæ§‹
- [ ] å»ºç«‹ HTML é é¢
- [ ] æ’°å¯« JavaScript åŠŸèƒ½
- [ ] åŠ å…¥ Dashboard é€£çµ
- [ ] ï¼ˆé¸ç”¨ï¼‰é–‹ç™¼å¾Œç«¯ API
- [ ] æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½
- [ ] éƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒ

## ğŸ’¡ é–‹ç™¼æœ€ä½³å¯¦è¸

### 1. å…ˆç°¡å–®å¾Œè¤‡é›œ
- å…ˆç”¨ Firestore ç›´æ¥è®€å¯«
- åŠŸèƒ½ç©©å®šå¾Œå†åŠ  API

### 2. é‡è¤‡ä½¿ç”¨ç¨‹å¼ç¢¼
- è¤‡è£½ç¾æœ‰æ¨¡çµ„çš„çµæ§‹
- ä¿®æ”¹æˆæ–°åŠŸèƒ½
- ä¿æŒé¢¨æ ¼ä¸€è‡´

### 3. æ¸¬è©¦å…ˆè¡Œ
- åœ¨æœ¬æ©Ÿæ¸¬è©¦é€šéæ‰éƒ¨ç½²
- ç”¨ä¸åŒè§’è‰²æ¸¬è©¦æ¬Šé™
- æª¢æŸ¥éŒ¯èª¤è™•ç†

### 4. ç¨‹å¼ç¢¼æ•´ç†
- é©ç•¶çš„è¨»è§£
- æ¸…æ¥šçš„è®Šæ•¸åç¨±
- å‡½æ•¸åŠŸèƒ½å–®ä¸€

## ğŸ“ ä¸‹ä¸€æ­¥

å­¸æœƒé–‹ç™¼æ¨¡çµ„å¾Œï¼Œæ¥ä¸‹ä¾†äº†è§£æ¬Šé™ç®¡ç†ï¼š

â¡ï¸ **ä¸‹ä¸€ç« ï¼š10-æ¬Šé™ç®¡ç†ç³»çµ±.md**

åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘å€‘æœƒè©³ç´°èªªæ˜å¦‚ä½•è¨­å®šå’Œç®¡ç†ä½¿ç”¨è€…æ¬Šé™ã€‚

---

ğŸ’¡ **å°æç¤º**ï¼š
- é–‹ç™¼æ–°åŠŸèƒ½æ™‚ï¼Œåƒè€ƒç¾æœ‰çš„ç¨‹å¼ç¢¼
- ä¿æŒæª”æ¡ˆçµæ§‹å’Œå‘½åä¸€è‡´
- é©ç•¶ä½¿ç”¨ common.css çš„æ¨£å¼
- è¨˜å¾—æ¸¬è©¦ä¸åŒè§’è‰²çš„æ¬Šé™
