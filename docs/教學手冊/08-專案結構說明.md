# 08 - å°ˆæ¡ˆçµæ§‹èªªæ˜

> äº†è§£ç¨‹å¼ç¢¼çš„çµ„ç¹”æ–¹å¼ï¼ŒçŸ¥é“æ¯å€‹æª”æ¡ˆæ”¾åœ¨å“ªè£¡ã€åšä»€éº¼ç”¨ã€‚

## ğŸ¯ æœ¬ç« ç›®æ¨™

å®Œæˆæœ¬ç« å¾Œï¼Œæ‚¨å°‡ï¼š
- äº†è§£æ•´å€‹å°ˆæ¡ˆçš„æª”æ¡ˆçµæ§‹
- çŸ¥é“å‰ç«¯å’Œå¾Œç«¯ç¨‹å¼ç¢¼çš„ä½ç½®
- äº†è§£å„å€‹è³‡æ–™å¤¾çš„ç”¨é€”
- å­¸æœƒåœ¨å“ªè£¡æ–°å¢åŠŸèƒ½

## ğŸ“ å®Œæ•´å°ˆæ¡ˆçµæ§‹

```
platfrom/                       # å°ˆæ¡ˆæ ¹ç›®éŒ„
â”œâ”€â”€ public/                     # å‰ç«¯ç¨‹å¼ç¢¼ï¼ˆç¶²é ï¼‰
â”‚   â”œâ”€â”€ index.html             # é¦–é ï¼ˆLINE Loginï¼‰
â”‚   â”œâ”€â”€ callback.html          # LINE Login å›èª¿é é¢
â”‚   â”œâ”€â”€ dashboard.html         # ä¸»æ§å°ï¼ˆæ¨¡çµ„é¸å–®ï¼‰
â”‚   â”œâ”€â”€ styles/                # CSS æ¨£å¼
â”‚   â”‚   â”œâ”€â”€ common.css        # å…±ç”¨æ¨£å¼ï¼ˆé‡‘é»ƒè‰²ä¸»é¡Œï¼‰
â”‚   â”‚   â””â”€â”€ dashboard.css     # ä¸»æ§å°æ¨£å¼
â”‚   â”œâ”€â”€ js/                    # JavaScript ç¨‹å¼
â”‚   â”‚   â”œâ”€â”€ config.js         # Firebase è¨­å®š
â”‚   â”‚   â”œâ”€â”€ auth.js           # ç™»å…¥é©—è­‰
â”‚   â”‚   â””â”€â”€ dashboard.js      # ä¸»æ§å°åŠŸèƒ½
â”‚   â”œâ”€â”€ images/                # åœ–ç‰‡è³‡æº
â”‚   â”‚   â””â”€â”€ temple-icon.png   # å»Ÿå®‡åœ–ç¤º
â”‚   â”œâ”€â”€ liff/                  # LIFF é é¢
â”‚   â”‚   â”œâ”€â”€ index.html        # LIFF é¦–é 
â”‚   â”‚   â”œâ”€â”€ checkin.html      # ç°½åˆ°é é¢
â”‚   â”‚   â”œâ”€â”€ service.html      # ç¥å‹™æœå‹™é é¢
â”‚   â”‚   â””â”€â”€ schedule.html     # æ’ç­é é¢
â”‚   â””â”€â”€ checkin/               # ç°½åˆ°æ¨¡çµ„
â”‚       â””â”€â”€ manage/
â”‚           â”œâ”€â”€ index.html    # ç°½åˆ°ç®¡ç†é¦–é 
â”‚           â”œâ”€â”€ dashboard.html # ç°½åˆ°ç´€éŒ„ç®¡ç†
â”‚           â”œâ”€â”€ patrols.html  # å·¡é‚é»ç®¡ç†
â”‚           â””â”€â”€ js/
â”‚               â”œâ”€â”€ dashboard.js  # ç°½åˆ°ç´€éŒ„åŠŸèƒ½
â”‚               â””â”€â”€ patrols.js    # å·¡é‚é»ç®¡ç†åŠŸèƒ½
â”‚
â”œâ”€â”€ functions/                  # å¾Œç«¯ç¨‹å¼ç¢¼ï¼ˆFirebase Functionsï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ index.js           # Functions å…¥å£
â”‚   â”‚   â”œâ”€â”€ platform/          # Platform å°ˆæ¡ˆ Functions
â”‚   â”‚   â”‚   â”œâ”€â”€ lineWebhook.js # LINE Webhook è™•ç†
â”‚   â”‚   â”‚   â””â”€â”€ api.js         # Platform API
â”‚   â”‚   â”œâ”€â”€ checkin/           # Checkin å°ˆæ¡ˆ Functions
â”‚   â”‚   â”‚   â””â”€â”€ index.js       # Checkin API
â”‚   â”‚   â””â”€â”€ utils/             # å…±ç”¨å·¥å…·
â”‚   â”‚       â”œâ”€â”€ firestore.js   # è³‡æ–™åº«æ“ä½œ
â”‚   â”‚       â””â”€â”€ auth.js        # é©—è­‰å·¥å…·
â”‚   â”œâ”€â”€ package.json           # Node.js ä¾è³´å¥—ä»¶
â”‚   â””â”€â”€ .env.example           # ç’°å¢ƒè®Šæ•¸ç¯„ä¾‹
â”‚
â”œâ”€â”€ docs/                       # æ–‡ä»¶
â”‚   â””â”€â”€ æ•™å­¸æ‰‹å†Š/              # æœ¬æ•™å­¸æ‰‹å†Š
â”‚
â”œâ”€â”€ firebase.json              # Firebase å°ˆæ¡ˆè¨­å®š
â”œâ”€â”€ firestore.rules            # Firestore å®‰å…¨è¦å‰‡
â”œâ”€â”€ firestore.indexes.json     # Firestore ç´¢å¼•
â”œâ”€â”€ .gitignore                 # Git å¿½ç•¥æª”æ¡ˆ
â”œâ”€â”€ package.json               # å‰ç«¯ä¾è³´å¥—ä»¶
â””â”€â”€ README.md                  # å°ˆæ¡ˆèªªæ˜
```

## ğŸŒ å‰ç«¯çµæ§‹è©³è§£

### ğŸ“„ ä¸»è¦é é¢

#### public/index.html
- **ç”¨é€”**ï¼šç¶²ç«™é¦–é 
- **åŠŸèƒ½**ï¼šLINE Login ç™»å…¥æŒ‰éˆ•
- **èª°æœƒç”¨**ï¼šç¬¬ä¸€æ¬¡è¨ªå•ç¶²ç«™çš„ä½¿ç”¨è€…

#### public/callback.html
- **ç”¨é€”**ï¼šLINE Login å›èª¿é é¢
- **åŠŸèƒ½**ï¼šæ¥æ”¶ LINE ç™»å…¥å¾Œçš„è³‡æ–™ï¼Œå»ºç«‹ä½¿ç”¨è€…å¸³è™Ÿ
- **æµç¨‹**ï¼š
  1. LINE ç™»å…¥æˆåŠŸå¾Œè·³è½‰åˆ°é€™è£¡
  2. å–å¾—ä½¿ç”¨è€…è³‡æ–™ï¼ˆIDã€åç¨±ã€é ­åƒï¼‰
  3. å¯«å…¥ Firestore
  4. è·³è½‰åˆ° dashboard

#### public/dashboard.html
- **ç”¨é€”**ï¼šä¸»æ§å°
- **åŠŸèƒ½**ï¼šé¡¯ç¤ºä½¿ç”¨è€…å¯ç”¨çš„æ¨¡çµ„
- **æ ¹æ“šæ¬Šé™**ï¼šä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒæ¨¡çµ„

### ğŸ¨ æ¨£å¼æª”æ¡ˆ

#### public/styles/common.css
- **ç”¨é€”**ï¼šå…¨ç«™å…±ç”¨æ¨£å¼
- **å…§å®¹**ï¼š
  - é‡‘é»ƒè‰²ä¸»é¡Œè‰²
  - æŒ‰éˆ•æ¨£å¼
  - å¡ç‰‡æ¨£å¼
  - éŸ¿æ‡‰å¼è¨­è¨ˆ

**ä¸»è¦é¡è‰²**ï¼š
```css
--primary-color: #D4AF37;      /* é‡‘é»ƒè‰² */
--primary-dark: #B8941F;       /* æ·±é‡‘è‰² */
--background: #F5F0E8;         /* ç±³ç™½è‰² */
--text-color: #2C2416;         /* æ·±è¤è‰² */
```

### ğŸ“± LIFF é é¢

#### public/liff/checkin.html
- **ç”¨é€”**ï¼šLINE å…§ç°½åˆ°é é¢
- **åŠŸèƒ½**ï¼š
  - GPS å®šä½
  - é¸æ“‡å·¡é‚é»
  - ç°½åˆ°
  - æŸ¥çœ‹å€‹äººç´€éŒ„

#### public/liff/index.html
- **ç”¨é€”**ï¼šLIFF é¦–é ï¼ˆæ¨¡çµ„é¸å–®ï¼‰
- **åŠŸèƒ½**ï¼šé¡ä¼¼ dashboardï¼Œä½†åœ¨ LINE å…§ä½¿ç”¨

### ğŸ“‚ æ¨¡çµ„çµæ§‹

æ¯å€‹æ¨¡çµ„éƒ½æœ‰è‡ªå·±çš„è³‡æ–™å¤¾ï¼š

```
public/checkin/               # ç°½åˆ°æ¨¡çµ„
â”œâ”€â”€ manage/                   # ç®¡ç†ä»‹é¢
â”‚   â”œâ”€â”€ index.html           # æ¨¡çµ„é¦–é 
â”‚   â”œâ”€â”€ dashboard.html       # ç´€éŒ„ç®¡ç†
â”‚   â”œâ”€â”€ patrols.html         # å·¡é‚é»ç®¡ç†
â”‚   â””â”€â”€ js/                  # JavaScript
â”‚       â”œâ”€â”€ dashboard.js     # ç´€éŒ„ç®¡ç†åŠŸèƒ½
â”‚       â””â”€â”€ patrols.js       # å·¡é‚é»ç®¡ç†åŠŸèƒ½
```

**æœªä¾†æ–°å¢æ¨¡çµ„**ï¼š
```
public/service/               # ç¥å‹™æ¨¡çµ„
public/schedule/              # æ’ç­æ¨¡çµ„
```

## âš™ï¸ å¾Œç«¯çµæ§‹è©³è§£

### ğŸ”¥ Functions çµ„ç¹”

#### functions/src/index.js
```javascript
// ä¸»å…¥å£ï¼ŒåŒ¯å‡ºæ‰€æœ‰ Functions
const platform = require('./platform');
const checkin = require('./checkin');

// åŒ¯å‡º Platform Functions
exports.lineWebhook = platform.lineWebhook;
exports.api = platform.api;

// åŒ¯å‡º Checkin Functions
exports.checkinApi = checkin.checkinApi;
```

#### functions/src/platform/lineWebhook.js
- **ç”¨é€”**ï¼šè™•ç† LINE Messaging API çš„ Webhook
- **åŠŸèƒ½**ï¼š
  - æ¥æ”¶ä½¿ç”¨è€…è¨Šæ¯
  - åˆ¤æ–·é—œéµå­—
  - å›è¦† LIFF é€£çµ

#### functions/src/checkin/index.js
- **ç”¨é€”**ï¼šç°½åˆ°ç³»çµ± API
- **ç«¯é»**ï¼š
  - `POST /checkin` - å»ºç«‹ç°½åˆ°
  - `GET /checkins` - å–å¾—ç°½åˆ°ç´€éŒ„
  - `GET /patrols` - å–å¾—å·¡é‚é»åˆ—è¡¨
  - `POST /patrols` - å»ºç«‹å·¡é‚é»

### ğŸ› ï¸ å…±ç”¨å·¥å…·

#### functions/src/utils/firestore.js
```javascript
// Firestore æ“ä½œå·¥å…·
const admin = require('firebase-admin');
const db = admin.firestore();

// å–å¾—ä½¿ç”¨è€…è³‡æ–™
async function getUser(userId) {
  const doc = await db.collection('users').doc(userId).get();
  return doc.data();
}

// æª¢æŸ¥ä½¿ç”¨è€…è§’è‰²
function hasRole(user, roles) {
  return user.roles && user.roles.some(r => roles.includes(r));
}
```

#### functions/src/utils/auth.js
```javascript
// é©—è­‰å·¥å…·
function verifyToken(req, res, next) {
  // é©—è­‰ Firebase ID Token
  // ...
}
```

## ğŸ“Š è³‡æ–™æµç¨‹

### ä½¿ç”¨è€…ç™»å…¥æµç¨‹

```
1. index.html
   â†“ é»æ“Šã€ŒLINE ç™»å…¥ã€
2. LINE æˆæ¬Šé é¢
   â†“ ä½¿ç”¨è€…åŒæ„
3. callback.html
   â†“ å–å¾—ä½¿ç”¨è€…è³‡æ–™
4. Platform Firestore (users)
   â†“ å¯«å…¥ä½¿ç”¨è€…è³‡æ–™
5. dashboard.html
   â†“ é¡¯ç¤ºæ¨¡çµ„é¸å–®
```

### ç°½åˆ°æµç¨‹

```
1. LIFF checkin.html
   â†“ GPS å®šä½ã€é¸æ“‡å·¡é‚é»
2. POST /checkinApi/checkin
   â†“ Cloud Function é©—è­‰
3. è¨ˆç®—è·é›¢ã€æª¢æŸ¥æ¬Šé™
   â†“ é©—è­‰é€šé
4. Checkin Firestore (checkins)
   â†“ å¯«å…¥ç°½åˆ°ç´€éŒ„
5. å›å‚³æˆåŠŸ
   â†“
6. å‰ç«¯é¡¯ç¤ºã€Œç°½åˆ°æˆåŠŸã€
```

## ğŸ”§ è¨­å®šæª”èªªæ˜

### firebase.json
```json
{
  "firestore": {
    "rules": "firestore.rules",      // Firestore å®‰å…¨è¦å‰‡
    "indexes": "firestore.indexes.json"
  },
  "functions": [
    {
      "source": "functions",          // Functions ç¨‹å¼ç¢¼ä½ç½®
      "codebase": "platform",
      "ignore": ["node_modules", ".git"]
    }
  ]
}
```

### package.jsonï¼ˆæ ¹ç›®éŒ„ï¼‰
```json
{
  "name": "guimashan-goLine",
  "dependencies": {
    "firebase-tools": "^13.0.0"
  }
}
```

### functions/package.json
```json
{
  "name": "functions",
  "engines": {
    "node": "18"                      // Node.js ç‰ˆæœ¬
  },
  "dependencies": {
    "firebase-admin": "^12.0.0",
    "firebase-functions": "^5.0.0",
    "@line/bot-sdk": "^9.0.0",
    "express": "^4.18.0"
  }
}
```

## ğŸ“ å‘½åè¦ç¯„

### æª”æ¡ˆå‘½å

- **HTML**ï¼šå°å¯«ï¼Œç”¨é€£å­—è™Ÿ
  - âœ… `checkin.html`
  - âœ… `patrol-management.html`
  - âŒ `CheckIn.html`

- **JavaScript**ï¼šå°å¯«ï¼Œç”¨é€£å­—è™Ÿ
  - âœ… `dashboard.js`
  - âœ… `auth-helper.js`

- **CSS**ï¼šå°å¯«ï¼Œç”¨é€£å­—è™Ÿ
  - âœ… `common.css`
  - âœ… `mobile-responsive.css`

### å‡½æ•¸å‘½å

- **å°é§å³°**ï¼šä¸€èˆ¬å‡½æ•¸
  ```javascript
  function getUserData() { }
  function checkPermission() { }
  ```

- **å¤§é§å³°**ï¼šé¡åˆ¥ã€å»ºæ§‹å‡½æ•¸
  ```javascript
  class UserManager { }
  ```

### è®Šæ•¸å‘½å

- **å¸¸æ•¸**ï¼šå…¨å¤§å¯«ï¼Œåº•ç·šåˆ†éš”
  ```javascript
  const FIREBASE_CONFIG = { };
  const MAX_DISTANCE = 50;
  ```

- **ä¸€èˆ¬è®Šæ•¸**ï¼šå°é§å³°
  ```javascript
  let userName = '';
  const checkInData = { };
  ```

## ğŸ—‚ï¸ æ–°å¢åŠŸèƒ½çš„ä½ç½®

### æ–°å¢å‰ç«¯é é¢
```
public/
â””â”€â”€ æ¨¡çµ„åç¨±/
    â”œâ”€â”€ index.html
    â”œâ”€â”€ manage.html
    â””â”€â”€ js/
        â””â”€â”€ manage.js
```

### æ–°å¢å¾Œç«¯ API
```
functions/src/
â””â”€â”€ æ¨¡çµ„åç¨±/
    â””â”€â”€ index.js
```

### æ–°å¢å…±ç”¨æ¨£å¼
```
public/styles/
â””â”€â”€ æ¨¡çµ„åç¨±.css
```

## âœ… æª¢æŸ¥æ¸…å–®

è«‹ç¢ºèªæ‚¨äº†è§£ï¼š
- [ ] å‰ç«¯ç¨‹å¼ç¢¼åœ¨ `public/` è³‡æ–™å¤¾
- [ ] å¾Œç«¯ç¨‹å¼ç¢¼åœ¨ `functions/src/` è³‡æ–™å¤¾
- [ ] LIFF é é¢åœ¨ `public/liff/` è³‡æ–™å¤¾
- [ ] æ¯å€‹æ¨¡çµ„æœ‰è‡ªå·±çš„è³‡æ–™å¤¾
- [ ] å…±ç”¨æ¨£å¼åœ¨ `common.css`
- [ ] è¨­å®šæª”çš„ä½œç”¨
- [ ] å‘½åè¦ç¯„
- [ ] è³‡æ–™æµç¨‹

## ğŸ“ ä¸‹ä¸€æ­¥

äº†è§£å°ˆæ¡ˆçµæ§‹å¾Œï¼Œæ¥ä¸‹ä¾†å¯¦éš›é–‹ç™¼åŠŸèƒ½ï¼š

â¡ï¸ **ä¸‹ä¸€ç« ï¼š09-é–‹ç™¼ç¬¬ä¸€å€‹æ¨¡çµ„.md**

åœ¨ä¸‹ä¸€ç« ï¼Œæˆ‘å€‘æœƒæ‰‹æŠŠæ‰‹æ•™æ‚¨é–‹ç™¼ä¸€å€‹æ–°æ¨¡çµ„ï¼Œå¾å‰ç«¯åˆ°å¾Œç«¯ã€‚

---

ğŸ’¡ **å°æç¤º**ï¼š
- ä¿æŒæª”æ¡ˆçµæ§‹æ•´é½Šï¼Œç›¸åŒåŠŸèƒ½æ”¾åœ¨ä¸€èµ·
- éµå¾ªå‘½åè¦ç¯„ï¼Œè®“ç¨‹å¼ç¢¼æ˜“è®€
- æ–°å¢åŠŸèƒ½å‰å…ˆçœ‹çœ‹ç¾æœ‰çš„ç¨‹å¼ç¢¼æ€éº¼å¯«
- å–„ç”¨ common.css çš„å…±ç”¨æ¨£å¼
