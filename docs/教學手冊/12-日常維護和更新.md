# 12 - æ—¥å¸¸ç¶­è­·å’Œæ›´æ–°

> å­¸ç¿’å¦‚ä½•ç¶­è­·ç³»çµ±ã€æ›´æ–°ç¨‹å¼ç¢¼ã€ç›£æ§é‹ä½œç‹€æ³ã€å‚™ä»½è³‡æ–™ã€‚

## ğŸ¯ æœ¬ç« ç›®æ¨™

å®Œæˆæœ¬ç« å¾Œï¼Œæ‚¨å°‡èƒ½å¤ ï¼š
- æ›´æ–°ç¶²ç«™ç¨‹å¼ç¢¼
- ç›£æ§ç³»çµ±é‹ä½œç‹€æ³
- å‚™ä»½é‡è¦è³‡æ–™
- è™•ç†å¸¸è¦‹å•é¡Œ
- å„ªåŒ–ç³»çµ±æ•ˆèƒ½

## ğŸ”„ ç¨‹å¼ç¢¼æ›´æ–°æµç¨‹

### æ­¥é©Ÿä¸€ï¼šä¿®æ”¹ç¨‹å¼ç¢¼

åœ¨ Replit æˆ–æœ¬æ©Ÿä¿®æ”¹ç¨‹å¼ç¢¼ã€‚

### æ­¥é©ŸäºŒï¼šæ¸¬è©¦

```bash
# æœ¬æ©Ÿæ¸¬è©¦
cd public
npx http-server -p 5000
```

é–‹å•Ÿ http://localhost:5000 æ¸¬è©¦åŠŸèƒ½æ˜¯å¦æ­£å¸¸ã€‚

### æ­¥é©Ÿä¸‰ï¼šæäº¤åˆ° GitHub

```bash
# æŸ¥çœ‹ä¿®æ”¹äº†å“ªäº›æª”æ¡ˆ
git status

# åŠ å…¥æ‰€æœ‰ä¿®æ”¹
git add .

# æäº¤è®Šæ›´
git commit -m "ä¿®æ”¹èªªæ˜"

# æ¨é€åˆ° GitHub
git push origin main
```

### æ­¥é©Ÿå››ï¼šVercel è‡ªå‹•éƒ¨ç½²

Vercel æœƒè‡ªå‹•åµæ¸¬ GitHub çš„æ›´æ–°ä¸¦éƒ¨ç½²ï¼Œç´„éœ€ 1-2 åˆ†é˜ã€‚

### æ­¥é©Ÿäº”ï¼šé©—è­‰éƒ¨ç½²

1. å‰å¾€ https://go.guimashan.org.tw
2. æŒ‰ Ctrl+Shift+R å¼·åˆ¶é‡æ–°æ•´ç†
3. æ¸¬è©¦ä¿®æ”¹çš„åŠŸèƒ½

âœ… æ›´æ–°å®Œæˆï¼

## ğŸ“¦ Functions æ›´æ–°æµç¨‹

### æ­¥é©Ÿä¸€ï¼šä¿®æ”¹ Functions ç¨‹å¼ç¢¼

åœ¨ `functions/src/` ä¿®æ”¹ç¨‹å¼ç¢¼ã€‚

### æ­¥é©ŸäºŒï¼šæœ¬æ©Ÿæ¸¬è©¦ï¼ˆé¸ç”¨ï¼‰

```bash
cd functions
npm test  # å¦‚æœæœ‰å¯«æ¸¬è©¦
cd ..
```

### æ­¥é©Ÿä¸‰ï¼šéƒ¨ç½²åˆ° Firebase

```bash
# éƒ¨ç½²æ‰€æœ‰ Functions
firebase deploy --only functions --project platform-bc783

# æˆ–åªéƒ¨ç½²ç‰¹å®š Functionï¼ˆæ›´å¿«ï¼‰
firebase deploy --only functions:lineWebhook --project platform-bc783
```

### æ­¥é©Ÿå››ï¼šé©—è­‰éƒ¨ç½²

```bash
# æŸ¥çœ‹éƒ¨ç½²ç´€éŒ„
firebase functions:log --project platform-bc783
```

æˆ–åœ¨ Firebase Console æŸ¥çœ‹ã€‚

## ğŸ“Š ç›£æ§ç³»çµ±ç‹€æ…‹

### æ¯æ—¥æª¢æŸ¥æ¸…å–®

**ç¶²ç«™ç‹€æ…‹**ï¼ˆæ¯å¤©ï¼‰ï¼š
- [ ] ç¶²ç«™å¯ä»¥æ­£å¸¸é–‹å•Ÿ
- [ ] LINE Login æ­£å¸¸é‹ä½œ
- [ ] LIFF å¯ä»¥æ­£å¸¸é–‹å•Ÿ
- [ ] ç°½åˆ°åŠŸèƒ½æ­£å¸¸

**Firebase Functions**ï¼ˆæ¯å¤©ï¼‰ï¼š
```bash
# æŸ¥çœ‹æœ€è¿‘çš„ Logs
firebase functions:log --project platform-bc783 --limit 50
```

æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯ã€‚

**Firebase ä½¿ç”¨é‡**ï¼ˆæ¯é€±ï¼‰ï¼š
1. å‰å¾€ Firebase Console
2. æŸ¥çœ‹ Usage and billing
3. æª¢æŸ¥ï¼š
   - Firestore è®€å¯«æ¬¡æ•¸
   - Functions èª¿ç”¨æ¬¡æ•¸
   - å„²å­˜ç©ºé–“ä½¿ç”¨é‡

### è¨­å®šç›£æ§æé†’

#### Firebase é ç®—æé†’

1. Firebase Console â†’ å°ˆæ¡ˆè¨­å®š
2. Usage and billing â†’ Details & settings
3. è¨­å®šé ç®—æé†’ï¼š
   - é ç®—ï¼š$10/æœˆ
   - æé†’é–€æª»ï¼š50%, 90%, 100%

#### Uptime ç›£æ§ï¼ˆé¸ç”¨ï¼‰

ä½¿ç”¨ UptimeRobot æˆ–é¡ä¼¼æœå‹™ï¼š
1. è¨»å†Šï¼šhttps://uptimerobot.com/
2. æ–°å¢ç›£æ§ï¼š
   - URL: https://go.guimashan.org.tw
   - Type: HTTP(s)
   - Interval: 5 åˆ†é˜
3. è¨­å®š Email é€šçŸ¥

## ğŸ’¾ è³‡æ–™å‚™ä»½

### Firestore è³‡æ–™åŒ¯å‡º

#### æ–¹æ³• 1ï¼šFirebase Consoleï¼ˆå°é‡è³‡æ–™ï¼‰

1. Firestore Database
2. é¸æ“‡é›†åˆ
3. åŒ¯å‡ºç‚º JSON

#### æ–¹æ³• 2ï¼šæŒ‡ä»¤åŒ¯å‡ºï¼ˆæ¨è–¦ï¼‰

```bash
# å®‰è£ gcloud CLI
# https://cloud.google.com/sdk/docs/install

# ç™»å…¥
gcloud auth login

# åŒ¯å‡ºæ•´å€‹è³‡æ–™åº«
gcloud firestore export gs://platform-bc783-backup/$(date +%Y%m%d) \
  --project platform-bc783

# åŒ¯å‡ºç‰¹å®šé›†åˆ
gcloud firestore export gs://platform-bc783-backup/$(date +%Y%m%d) \
  --collection-ids=users,announcements \
  --project platform-bc783
```

#### æ–¹æ³• 3ï¼šè‡ªå‹•å‚™ä»½è…³æœ¬

å»ºç«‹ `backup.sh`ï¼š
```bash
#!/bin/bash

DATE=$(date +%Y%m%d)
PROJECT="platform-bc783"
BUCKET="gs://${PROJECT}-backup"

echo "é–‹å§‹å‚™ä»½ Firestore..."

gcloud firestore export ${BUCKET}/${DATE} \
  --project ${PROJECT}

echo "å‚™ä»½å®Œæˆï¼š${BUCKET}/${DATE}"
```

è¨­å®šå®šæœŸåŸ·è¡Œï¼ˆä¾‹å¦‚ï¼šæ¯é€±æ—¥å‡Œæ™¨ï¼‰ã€‚

### é‡è¦æª”æ¡ˆå‚™ä»½

**æ¯æœˆå‚™ä»½**ï¼š
- Firebase å°ˆæ¡ˆè¨­å®š
- LINE Channel è¨­å®š
- ç’°å¢ƒè®Šæ•¸åˆ—è¡¨
- ä½¿ç”¨è€…æ¬Šé™åˆ—è¡¨

å»ºç«‹å‚™ä»½æ¸…å–®ï¼š
```
=== ç³»çµ±å‚™ä»½æ¸…å–® - 2025-11 ===

ã€Firebase è¨­å®šã€‘
- Platform config: [å·²å„²å­˜]
- Checkin config: [å·²å„²å­˜]
- Service Account Keys: [å·²å„²å­˜]

ã€LINE è¨­å®šã€‘
- LINE Login Channel ID: 2008269293
- LIFF IDs: [å·²è¨˜éŒ„]
- Webhook URL: [å·²è¨˜éŒ„]

ã€ç’°å¢ƒè®Šæ•¸ã€‘
- LINE_CHANNEL_SECRET: [å·²å„²å­˜]
- SESSION_SECRET: [å·²å„²å­˜]

ã€Firestore è³‡æ–™ã€‘
- æœ€å¾Œå‚™ä»½æ—¥æœŸ: 2025-11-01
- å‚™ä»½ä½ç½®: gs://platform-bc783-backup/20251101
```

## ğŸ” Logs åˆ†æ

### æŸ¥çœ‹ Firebase Functions Logs

```bash
# æŸ¥çœ‹æœ€è¿‘çš„ Logs
firebase functions:log --project platform-bc783

# åªçœ‹ç‰¹å®š Function
firebase functions:log --only lineWebhook --project platform-bc783

# å³æ™‚ç›£çœ‹
firebase functions:log --project platform-bc783 --follow
```

### å¸¸è¦‹ Log è¨Šæ¯

**æ­£å¸¸**ï¼š
```
Function execution took 234 ms, finished with status: 'ok'
âœ“ ä½¿ç”¨è€…ç™»å…¥æˆåŠŸï¼šU123456
âœ“ ç°½åˆ°æˆåŠŸï¼šuserId=abc123, patrolId=å»Ÿå…¬å®¤
```

**éœ€è¦æ³¨æ„**ï¼š
```
âš  ç°½åˆ°å¤±æ•—ï¼šè·é›¢éé  (123m)
âš  æ¬Šé™ä¸è¶³ï¼šuser å˜—è©¦å­˜å– admin åŠŸèƒ½
```

**éœ€è¦è™•ç†**ï¼š
```
âœ— Error: Cannot find module 'xxx'
âœ— Firebase permission denied
âœ— Function timeout
```

### åœ¨ Firebase Console æŸ¥çœ‹

1. Firebase Console â†’ Functions â†’ Logs
2. å¯ä»¥ç¯©é¸ï¼š
   - æ™‚é–“ç¯„åœ
   - åš´é‡ç¨‹åº¦ï¼ˆError, Warning, Infoï¼‰
   - Function åç¨±

## âš¡ æ•ˆèƒ½å„ªåŒ–

### æ¸›å°‘ Firestore è®€å¯«

**âŒ ä¸å¥½çš„åšæ³•**ï¼š
```javascript
// æ¯æ¬¡éƒ½è®€å–æ•´å€‹ä½¿ç”¨è€…åˆ—è¡¨
const users = await db.collection('users').get();
```

**âœ… å¥½çš„åšæ³•**ï¼š
```javascript
// åªè®€å–éœ€è¦çš„æ¬„ä½
const users = await db.collection('users')
  .select('displayName', 'roles')
  .get();

// ä½¿ç”¨åˆ†é 
const users = await db.collection('users')
  .limit(20)
  .get();
```

### ä½¿ç”¨å¿«å–

```javascript
// å¿«å–ä½¿ç”¨è€…è³‡æ–™ 5 åˆ†é˜
let userCache = null;
let cacheTime = 0;

async function getUserData(uid) {
  const now = Date.now();
  if (userCache && now - cacheTime < 300000) {
    return userCache;
  }
  
  userCache = await db.collection('users').doc(uid).get().then(doc => doc.data());
  cacheTime = now;
  return userCache;
}
```

### å„ªåŒ– Functions

```javascript
// è¨­å®šè¼ƒçŸ­çš„é€¾æ™‚æ™‚é–“
exports.myFunction = functions
  .runWith({ 
    timeoutSeconds: 60,
    memory: '256MB'
  })
  .https.onRequest(app);

// ä½¿ç”¨ Connection Pooling
const db = admin.firestore();
// é‡è¤‡ä½¿ç”¨åŒä¸€å€‹é€£ç·š
```

## ğŸ—“ï¸ å®šæœŸç¶­è­·æ™‚ç¨‹

### æ¯å¤©
- [ ] æª¢æŸ¥ç¶²ç«™æ˜¯å¦æ­£å¸¸
- [ ] æŸ¥çœ‹ Functions Logs

### æ¯é€±
- [ ] æª¢æŸ¥ Firebase ä½¿ç”¨é‡
- [ ] æŸ¥çœ‹ä½¿ç”¨è€…å›å ±çš„å•é¡Œ
- [ ] æ›´æ–°å¾…ä¿®å¾©çš„ Bug æ¸…å–®

### æ¯æœˆ
- [ ] å‚™ä»½ Firestore è³‡æ–™
- [ ] æª¢æŸ¥è²»ç”¨
- [ ] æ›´æ–°æ–‡ä»¶
- [ ] æª¢è¦–ä½¿ç”¨è€…æ¬Šé™
- [ ] æ¸…ç†ç„¡ç”¨çš„æ¸¬è©¦è³‡æ–™

### æ¯å­£
- [ ] æ›´æ–°ä¾è³´å¥—ä»¶
- [ ] æª¢æŸ¥å®‰å…¨æ€§
- [ ] æ•ˆèƒ½å„ªåŒ–
- [ ] å®Œæ•´ç³»çµ±æ¸¬è©¦

## ğŸ“ ç¶­è­·ç´€éŒ„è¡¨

å»ºè­°å»ºç«‹ç¶­è­·ç´€éŒ„ï¼š

```
=== ç³»çµ±ç¶­è­·ç´€éŒ„ ===

æ—¥æœŸï¼š2025-11-02
åŸ·è¡Œè€…ï¼š[æ‚¨çš„åå­—]

ã€æª¢æŸ¥é …ç›®ã€‘
âœ… ç¶²ç«™é‹ä½œæ­£å¸¸
âœ… Functions ç„¡éŒ¯èª¤
âœ… ä½¿ç”¨é‡æ­£å¸¸

ã€æ›´æ–°å…§å®¹ã€‘
- ä¿®å¾©ç°½åˆ°è·é›¢è¨ˆç®—éŒ¯èª¤
- æ›´æ–°å·¡é‚é»åˆ—è¡¨

ã€å•é¡Œç´€éŒ„ã€‘
- ç„¡

ã€ä¸‹æ¬¡ç¶­è­·é‡é»ã€‘
- æ–°å¢ç¥å‹™æ¨¡çµ„
```

## ğŸ†˜ ç·Šæ€¥è™•ç†

### ç¶²ç«™ç„¡æ³•é–‹å•Ÿ

1. æª¢æŸ¥ Vercel ç‹€æ…‹ï¼šhttps://vercel.com/status
2. æŸ¥çœ‹éƒ¨ç½²ç´€éŒ„ï¼šVercel Dashboard â†’ Deployments
3. å¦‚æœæœ€æ–°éƒ¨ç½²å¤±æ•—ï¼Œå›æ»¾åˆ°ä¹‹å‰çš„ç‰ˆæœ¬

### Functions éŒ¯èª¤

1. æŸ¥çœ‹ Logsï¼š
   ```bash
   firebase functions:log --project platform-bc783
   ```
2. æ‰¾å‡ºéŒ¯èª¤åŸå› 
3. ä¿®å¾©ä¸¦é‡æ–°éƒ¨ç½²
4. å¦‚æœç„¡æ³•ç«‹å³ä¿®å¾©ï¼Œå›æ»¾åˆ°ä¹‹å‰çš„ç‰ˆæœ¬ï¼š
   ```bash
   git revert HEAD
   git push
   firebase deploy --only functions
   ```

### è³‡æ–™éŒ¯èª¤

1. åœæ­¢å¯«å…¥æ“ä½œï¼ˆå¦‚æœéœ€è¦ï¼‰
2. å¾å‚™ä»½é‚„åŸï¼š
   ```bash
   gcloud firestore import gs://platform-bc783-backup/20251101 \
     --project platform-bc783
   ```
3. é©—è­‰è³‡æ–™æ­£ç¢ºæ€§

## âœ… æª¢æŸ¥æ¸…å–®

è«‹ç¢ºèªæ‚¨çŸ¥é“å¦‚ä½•ï¼š
- [ ] æ›´æ–°ç¶²ç«™ç¨‹å¼ç¢¼
- [ ] æ›´æ–° Functions
- [ ] æŸ¥çœ‹ Logs
- [ ] ç›£æ§ä½¿ç”¨é‡
- [ ] å‚™ä»½è³‡æ–™
- [ ] é‚„åŸè³‡æ–™
- [ ] è™•ç†ç·Šæ€¥ç‹€æ³
- [ ] è¨˜éŒ„ç¶­è­·ç´€éŒ„

## ğŸ“ ä¸‹ä¸€æ­¥

å­¸æœƒç¶­è­·å¾Œï¼Œæœ€å¾Œäº†è§£å¦‚ä½•è™•ç†å•é¡Œï¼š

â¡ï¸ **ä¸‹ä¸€ç« ï¼š13-å¸¸è¦‹å•é¡Œè§£æ±º.md**

åœ¨æœ€å¾Œä¸€ç« ï¼Œæˆ‘å€‘æœƒåˆ—å‡ºå¸¸è¦‹å•é¡Œå’Œè§£æ±ºæ–¹æ³•ã€‚

---

ğŸ’¡ **å°æç¤º**ï¼š
- å®šæœŸå‚™ä»½éå¸¸é‡è¦ï¼
- æ›´æ–°å‰å…ˆæ¸¬è©¦
- ä¿æŒç¶­è­·ç´€éŒ„
- è¨­å®šç›£æ§æé†’
- é‡åˆ°å•é¡Œå…ˆæŸ¥ Logs
