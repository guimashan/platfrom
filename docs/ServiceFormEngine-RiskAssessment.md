# ServiceFormEngine é¢¨éšªè©•ä¼°èˆ‡æ¸¬è©¦ç­–ç•¥

## ğŸ¯ ç›®æ¨™

ç¢ºä¿ ServiceFormEngine é‡æ§‹é …ç›®å®‰å…¨ã€ç©©å®šåœ°å®Œæˆï¼Œé›¶æ¥­å‹™ä¸­æ–·ï¼Œé›¶æ•¸æ“šä¸Ÿå¤±ã€‚

**âš ï¸ é‡è¦è²æ˜**ï¼š
æœ¬æ–‡ä»¶ç‚º**é¢¨éšªç®¡ç†åƒè€ƒæŒ‡å—**ï¼Œç”¨æ–¼æœªä¾†å¯¦ä½œã€‚å¯¦éš›åŸ·è¡Œå‰éœ€è¦ï¼š
- å»ºç«‹è‡ªå‹•åŒ–æ¸¬è©¦æ¡†æ¶ï¼ˆVitest, Playwrightï¼‰
- é…ç½®ç›£æ§å’Œå‘Šè­¦ç³»çµ±ï¼ˆFirebase Console, Sentryï¼‰
- æº–å‚™å›æ»¾è…³æœ¬å’Œæ‡‰æ€¥ç¨‹åº
- æ ¹æ“šå¯¦éš›ç’°å¢ƒèª¿æ•´é¢¨éšªè©•ä¼°

---

## ğŸš¨ é¢¨éšªçŸ©é™£

### é¢¨éšªè©•ç´šæ¨™æº–

| å½±éŸ¿ç¨‹åº¦ | æ©Ÿç‡ | é¢¨éšªç­‰ç´š |
|---------|------|----------|
| é«˜ Ã— é«˜ | ğŸ”´ **å±æ€¥** | ç«‹å³è™•ç† |
| é«˜ Ã— ä¸­ | ğŸŸ  **åš´é‡** | å„ªå…ˆè™•ç† |
| é«˜ Ã— ä½ | ğŸŸ¡ **ä¸­ç­‰** | è¨ˆåŠƒè™•ç† |
| ä¸­ Ã— é«˜ | ğŸŸ¡ **ä¸­ç­‰** | è¨ˆåŠƒè™•ç† |
| ä½ Ã— ä½ | ğŸŸ¢ **è¼•å¾®** | ç›£æ§å³å¯ |

---

## ğŸ”´ å±æ€¥é¢¨éšªï¼ˆéœ€ç«‹å³ç·©è§£ï¼‰

### é¢¨éšª 1ï¼šCloud Function è³‡æ–™æ ¼å¼ä¸å…¼å®¹

**æè¿°**ï¼šé‡æ§‹å¾Œæäº¤çš„è³‡æ–™æ ¼å¼èˆ‡ Cloud Function ä¸å…¼å®¹ï¼Œå°è‡´æ‰€æœ‰è¨‚å–®æäº¤å¤±æ•—ã€‚

**å½±éŸ¿**ï¼šğŸ”´ é«˜ - ç”¨æˆ¶ç„¡æ³•ä½¿ç”¨æœå‹™ï¼Œæ¥­å‹™å®Œå…¨ä¸­æ–·  
**æ©Ÿç‡**ï¼šğŸŸ¡ ä¸­ - API å¥‘ç´„å¯èƒ½æœ‰ç´°å¾®å·®ç•°

**ç·©è§£æªæ–½**ï¼š

1. **æå‰é©—è­‰**ï¼ˆéšæ®µ 1ï¼ŒDay 5ï¼‰
   ```javascript
   // æ¸¬è©¦ï¼šå°æ¯”èˆŠç‰ˆæœ¬å’Œæ–°ç‰ˆæœ¬çš„è³‡æ–™æ ¼å¼
   const oldData = collectFormDataOldWay();
   const newData = engine.collectFormData();
   
   assert.deepEqual(oldData, newData, 'è³‡æ–™æ ¼å¼å¿…é ˆå®Œå…¨ä¸€è‡´');
   ```

2. **é›™é‡æª¢æŸ¥**ï¼ˆéšæ®µ 2ï¼ŒDay 7ï¼‰
   - ä½¿ç”¨ Postman ç›´æ¥å‘¼å« Cloud Function
   - ç¢ºèªæ–°æ ¼å¼å¯ä»¥æˆåŠŸè™•ç†

3. **é‡‘çµ²é›€éƒ¨ç½²**ï¼ˆéšæ®µ 2ï¼ŒDay 9ï¼‰
   - DD å…ˆä¸Šç·š 1 å°æ™‚ï¼Œç›£æ§éŒ¯èª¤ç‡
   - éŒ¯èª¤ç‡ > 1% ç«‹å³å›æ»¾

4. **å›æ»¾è¨ˆåŠƒ**ï¼ˆ< 10 åˆ†é˜ï¼‰
   - ä¿ç•™èˆŠä»£ç¢¼å‚™ä»½
   - é å…ˆæº–å‚™å›æ»¾è…³æœ¬

**ç›£æ§æŒ‡æ¨™**ï¼š
- Cloud Function æˆåŠŸç‡ â‰¥ 99%
- éŒ¯èª¤æ—¥èªŒç›£æ§ï¼ˆæ¯ 5 åˆ†é˜æª¢æŸ¥ï¼‰

---

### é¢¨éšª 2ï¼šLINE OAuth èªè­‰æµç¨‹ä¸­æ–·

**æè¿°**ï¼šé‡æ§‹å½±éŸ¿ LINE ç™»å…¥æµç¨‹ï¼Œç”¨æˆ¶ç„¡æ³•ç™»å…¥ã€‚

**å½±éŸ¿**ï¼šğŸ”´ é«˜ - ç”¨æˆ¶å®Œå…¨ç„¡æ³•ä½¿ç”¨æœå‹™  
**æ©Ÿç‡**ï¼šğŸŸ¢ ä½ - èªè­‰é‚è¼¯èˆ‡è¡¨å–®é‚è¼¯åˆ†é›¢

**ç·©è§£æªæ–½**ï¼š

1. **éš”é›¢èªè­‰æ¨¡çµ„**ï¼ˆè¨­è¨ˆéšæ®µå·²å®Œæˆï¼‰
   - AuthManager ç¨ç«‹æ–¼è¡¨å–®é‚è¼¯
   - ä½¿ç”¨ç¾æœ‰çš„ `/js/auth.js`ï¼Œä¸ä¿®æ”¹æ ¸å¿ƒèªè­‰

2. **èªè­‰æ¸¬è©¦**ï¼ˆéšæ®µ 2ï¼ŒDay 7ï¼‰
   - [ ] LINE ç™»å…¥æŒ‰éˆ•æ­£å¸¸
   - [ ] OAuth è·³è½‰æ­£å¸¸
   - [ ] callback.html æ­£å¸¸è™•ç†
   - [ ] ç”¨æˆ¶è³‡æ–™æ­£ç¢ºè¼‰å…¥

3. **æ¸¬è©¦ç’°å¢ƒé©—è­‰**ï¼ˆéšæ®µ 1ï¼ŒDay 5ï¼‰
   - åœ¨ Replit ç’°å¢ƒæ¸¬è©¦å®Œæ•´ç™»å…¥æµç¨‹
   - è¨˜éŒ„æ‰€æœ‰ state é©—è­‰æ­¥é©Ÿ

**ç›£æ§æŒ‡æ¨™**ï¼š
- LINE ç™»å…¥æˆåŠŸç‡ â‰¥ 95%
- callback.html éŒ¯èª¤ç‡ < 1%

---

### é¢¨éšª 3ï¼šç”Ÿè‚–è¨ˆç®—éŒ¯èª¤

**æè¿°**ï¼šlunar-javascript å¥—ä»¶æ•´åˆéŒ¯èª¤ï¼Œç”Ÿè‚–è¨ˆç®—ä¸æº–ç¢ºã€‚

**å½±éŸ¿**ï¼šğŸ”´ é«˜ - å½±éŸ¿è¨‚å–®è³‡æ–™æ­£ç¢ºæ€§  
**æ©Ÿç‡**ï¼šğŸŸ¡ ä¸­ - ä¾è³´å¤–éƒ¨å¥—ä»¶

**ç·©è§£æªæ–½**ï¼š

1. **å–®å…ƒæ¸¬è©¦**ï¼ˆéšæ®µ 1ï¼ŒDay 4ï¼‰
   ```javascript
   describe('ç”Ÿè‚–è¨ˆç®—', () => {
       test('1984-02-04 æ‡‰ç‚ºé¼ å¹´', () => {
           const result = calculateShengxiao('1984-02-04');
           expect(result.shengxiao).toBe('rat');
       });
       
       test('è·¨å¹´é‚Šç•Œï¼š2025-01-28ï¼ˆå¤§å¹´é™¤å¤•å‰ï¼‰æ‡‰ç‚ºé¾å¹´', () => {
           const result = calculateShengxiao('2025-01-28');
           expect(result.shengxiao).toBe('dragon');
       });
       
       test('è·¨å¹´é‚Šç•Œï¼š2025-01-29ï¼ˆå¤§å¹´åˆä¸€ï¼‰æ‡‰ç‚ºè›‡å¹´', () => {
           const result = calculateShengxiao('2025-01-29');
           expect(result.shengxiao).toBe('snake');
       });
   });
   ```

2. **å°ç…§æ¸¬è©¦**ï¼ˆéšæ®µ 2ï¼ŒDay 7ï¼‰
   - ä½¿ç”¨èˆŠç‰ˆæœ¬è¨ˆç®— 100 å€‹æ—¥æœŸ
   - æ–°ç‰ˆæœ¬å¿…é ˆå®Œå…¨ä¸€è‡´

3. **é‚Šç•Œæ¸¬è©¦**
   - æ¸¬è©¦è¾²æ›†æ–°å¹´å‰å¾Œæ—¥æœŸ
   - æ¸¬è©¦é–å¹´æƒ…æ³
   - æ¸¬è©¦æ¥µç«¯æ—¥æœŸï¼ˆ1900-01-01, 2100-12-31ï¼‰

**ç›£æ§æŒ‡æ¨™**ï¼š
- ç”Ÿè‚–è¨ˆç®—æº–ç¢ºç‡ = 100%

---

## ğŸŸ  åš´é‡é¢¨éšªï¼ˆéœ€å„ªå…ˆè™•ç†ï¼‰

### é¢¨éšª 4ï¼šå¡ç‰‡ç®¡ç†é‚è¼¯éŒ¯èª¤

**æè¿°**ï¼šæ–°å¢/åˆªé™¤å¡ç‰‡æ™‚ï¼Œäº‹ä»¶ç¶å®šæˆ–æ•¸æ“šæ”¶é›†éŒ¯èª¤ã€‚

**å½±éŸ¿**ï¼šğŸŸ¡ ä¸­ - éƒ¨åˆ†åŠŸèƒ½ç•°å¸¸ï¼Œç”¨æˆ¶é«”é©—å·®  
**æ©Ÿç‡**ï¼šğŸŸ¡ ä¸­ - è¤‡é›œçš„ DOM æ“ä½œ

**ç·©è§£æªæ–½**ï¼š

1. **CardManager å–®å…ƒæ¸¬è©¦**ï¼ˆéšæ®µ 1ï¼ŒDay 4ï¼‰
   ```javascript
   describe('CardManager', () => {
       test('createCard() æ­£ç¢ºç¶å®šäº‹ä»¶', () => {
           const card = cardManager.createCard();
           const toggleBtn = card.querySelector('.card-toggle-btn');
           
           toggleBtn.click();
           expect(card.dataset.collapsed).toBe('true');
       });
       
       test('deleteCard() è‡³å°‘ä¿ç•™ä¸€å¼µå¡ç‰‡', () => {
           cardManager.createCard();
           cardManager.createCard();
           
           const cards = document.querySelectorAll('.applicant-card');
           cardManager.deleteCard(cards[0]);
           
           expect(document.querySelectorAll('.applicant-card').length).toBe(1);
       });
   });
   ```

2. **UI æ¸¬è©¦**ï¼ˆéšæ®µ 2ï¼ŒDay 7ï¼‰
   - ä½¿ç”¨ Playwright éŒ„è£½å¡ç‰‡æ“ä½œ
   - è‡ªå‹•åŒ–é‡è¤‡æ¸¬è©¦

**ç›£æ§æŒ‡æ¨™**ï¼š
- JavaScript éŒ¯èª¤ç‡ < 0.1%

---

### é¢¨éšª 5ï¼šè¡¨å–®é©—è­‰éºæ¼

**æè¿°**ï¼šæŸäº›é©—è­‰è¦å‰‡åœ¨é‡æ§‹ä¸­éºæ¼ï¼Œå…è¨±ç„¡æ•ˆè³‡æ–™æäº¤ã€‚

**å½±éŸ¿**ï¼šğŸŸ¡ ä¸­ - è³‡æ–™å“è³ªä¸‹é™ï¼ŒCloud Function å¯èƒ½æ‹’çµ•  
**æ©Ÿç‡**ï¼šğŸŸ¡ ä¸­ - é©—è­‰è¦å‰‡åˆ†æ•£åœ¨å¤šè™•

**ç·©è§£æªæ–½**ï¼š

1. **é©—è­‰è¦å‰‡æ¸…å–®**ï¼ˆéšæ®µ 1ï¼ŒDay 2ï¼‰
   - æ•´ç†æ‰€æœ‰ç¾æœ‰é©—è­‰è¦å‰‡
   - å°ç…§æ–°æ¶æ§‹ç¢ºèªå®Œæ•´æ€§

2. **è² é¢æ¸¬è©¦**ï¼ˆéšæ®µ 2ï¼ŒDay 7ï¼‰
   ```javascript
   describe('è¡¨å–®é©—è­‰', () => {
       test('å¿…å¡«æ¬„ä½æœªå¡«æ™‚æ‡‰æ‹’çµ•æäº¤', () => {
           // ä¸å¡«å§“å
           const result = validator.validateAll();
           expect(result.isValid).toBe(false);
           expect(result.errors).toContain('å§“åç‚ºå¿…å¡«');
       });
       
       test('æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤æ™‚æ‡‰æ‹’çµ•æäº¤', () => {
           contactPhone.value = '123456';  // éŒ¯èª¤æ ¼å¼
           const result = validator.validateAll();
           expect(result.isValid).toBe(false);
       });
   });
   ```

3. **å°ç…§é©—è­‰**ï¼ˆéšæ®µ 2ï¼ŒDay 8ï¼‰
   - æ–°èˆŠç‰ˆæœ¬ä¸¦æ’æ¸¬è©¦
   - æäº¤ç›¸åŒçš„ç„¡æ•ˆè³‡æ–™
   - éŒ¯èª¤è¨Šæ¯å¿…é ˆä¸€è‡´

**ç›£æ§æŒ‡æ¨™**ï¼š
- Cloud Function æ‹’çµ•ç‡ < 1%ï¼ˆç„¡æ•ˆè³‡æ–™è¢«æ””æˆªï¼‰

---

## ğŸŸ¡ ä¸­ç­‰é¢¨éšªï¼ˆè¨ˆåŠƒè™•ç†ï¼‰

### é¢¨éšª 6ï¼šæ•ˆèƒ½ä¸‹é™

**æè¿°**ï¼šå¼•æ“é¡å¤–é–‹éŠ·å°è‡´é é¢è¼‰å…¥è®Šæ…¢ã€‚

**å½±éŸ¿**ï¼šğŸŸ¡ ä¸­ - ç”¨æˆ¶é«”é©—ä¸‹é™  
**æ©Ÿç‡**ï¼šğŸŸ¢ ä½ - æ¨¡çµ„åŒ–æ‡‰è©²æ›´å¿«

**ç·©è§£æªæ–½**ï¼š

1. **æ•ˆèƒ½åŸºæº–æ¸¬è©¦**ï¼ˆéšæ®µ 1ï¼ŒDay 5ï¼‰
   - èˆŠç‰ˆæœ¬ï¼šé¦–æ¬¡è¼‰å…¥æ™‚é–“ã€äº’å‹•æ™‚é–“
   - æ–°ç‰ˆæœ¬ï¼šä¸å¾—è¶…éåŸºæº– +10%

2. **Lighthouse æ¸¬è©¦**ï¼ˆéšæ®µ 4ï¼ŒDay 18ï¼‰
   - ç›®æ¨™åˆ†æ•¸ â‰¥ 90
   - é¦–æ¬¡è¼‰å…¥ < 2 ç§’
   - TTI < 3 ç§’

3. **å„ªåŒ–æªæ–½**ï¼ˆéšæ®µ 4ï¼ŒDay 19ï¼‰
   - Code Splitting
   - Lazy Loading
   - Tree Shaking

**ç›£æ§æŒ‡æ¨™**ï¼š
- Lighthouse åˆ†æ•¸ â‰¥ 90
- ç”¨æˆ¶æŠ±æ€¨è¼‰å…¥æ…¢çš„æ¬¡æ•¸ = 0

---

### é¢¨éšª 7ï¼šç¬¬ä¸‰æ–¹å¥—ä»¶ä¾è³´é¢¨éšª

**æè¿°**ï¼šlunar-javascript å¥—ä»¶æ›´æ–°æˆ–åœæ­¢ç¶­è­·ã€‚

**å½±éŸ¿**ï¼šğŸŸ¢ ä½ - çŸ­æœŸå…§ä¸æœƒå½±éŸ¿  
**æ©Ÿç‡**ï¼šğŸŸ¢ ä½ - å¥—ä»¶ç©©å®š

**ç·©è§£æªæ–½**ï¼š

1. **ç‰ˆæœ¬é–å®š**ï¼ˆéšæ®µ 1ï¼ŒDay 1ï¼‰
   ```json
   {
     "dependencies": {
       "lunar-javascript": "1.6.13"  // é–å®šç‰ˆæœ¬
     }
   }
   ```

2. **å‚™ç”¨æ–¹æ¡ˆ**ï¼ˆéšæ®µ 4ï¼ŒDay 20ï¼‰
   - ç ”ç©¶å…¶ä»–ç”Ÿè‚–è¨ˆç®—å¥—ä»¶
   - å¦‚æœ‰éœ€è¦ï¼Œè‡ªè¡Œå¯¦ä½œç”Ÿè‚–è¨ˆç®—é‚è¼¯

**ç›£æ§æŒ‡æ¨™**ï¼š
- å¥—ä»¶å¥åº·åº¦æª¢æŸ¥ï¼ˆæ¯æœˆä¸€æ¬¡ï¼‰

---

## ğŸŸ¢ è¼•å¾®é¢¨éšªï¼ˆç›£æ§å³å¯ï¼‰

### é¢¨éšª 8ï¼šç€è¦½å™¨å…¼å®¹æ€§

**æè¿°**ï¼šæŸäº›èˆŠç€è¦½å™¨ä¸æ”¯æ´ ES6 èªæ³•ã€‚

**å½±éŸ¿**ï¼šğŸŸ¢ ä½ - å°‘æ•¸ç”¨æˆ¶å—å½±éŸ¿  
**æ©Ÿç‡**ï¼šğŸŸ¢ ä½ - ç›®æ¨™ç”¨æˆ¶ä½¿ç”¨ç¾ä»£ç€è¦½å™¨

**ç·©è§£æªæ–½**ï¼š

1. **ç€è¦½å™¨æ”¯æ´è²æ˜**
   - Chrome 90+
   - Firefox 88+
   - Safari 14+
   - Edge 90+

2. **Polyfill**ï¼ˆå¦‚éœ€è¦ï¼‰
   - ä½¿ç”¨ Babel è½‰è­¯
   - æ·»åŠ å¿…è¦çš„ Polyfill

**ç›£æ§æŒ‡æ¨™**ï¼š
- JavaScript éŒ¯èª¤ä¸­ç€è¦½å™¨ä¸å…¼å®¹çš„æ¯”ä¾‹ < 1%

---

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### æ¸¬è©¦é‡‘å­—å¡”

```
       /\
      /E2E\        ç«¯åˆ°ç«¯æ¸¬è©¦ï¼ˆ10%ï¼‰- Playwright
     /------\
    /  æ•´åˆ  \      æ•´åˆæ¸¬è©¦ï¼ˆ30%ï¼‰- Vitest + JSDOM
   /----------\
  /  å–®å…ƒæ¸¬è©¦  \    å–®å…ƒæ¸¬è©¦ï¼ˆ60%ï¼‰- Vitest
 /--------------\
```

---

### 1. å–®å…ƒæ¸¬è©¦ï¼ˆ60%ï¼Œç´„ 150 å€‹æ¸¬è©¦ï¼‰

**å·¥å…·**ï¼šVitest

**è¦†è“‹ç¯„åœ**ï¼š

#### ServiceFormEngine
- [ ] `resolveDOMElements()` è§£æé¸æ“‡å™¨
- [ ] `initializeHooks()` å»ºç«‹é‰¤å­
- [ ] `calculateTotal()` è¨ˆç®—é‡‘é¡

#### AuthManager
- [ ] `checkAuthState()` æª¢æŸ¥ç™»å…¥ç‹€æ…‹
- [ ] `loadUserData()` è¼‰å…¥ç”¨æˆ¶è³‡æ–™

#### FormValidator
- [ ] `validateField()` é©—è­‰å–®ä¸€æ¬„ä½
- [ ] `validateAll()` é©—è­‰æ‰€æœ‰æ¬„ä½
- [ ] æ­£è¦è¡¨é”å¼æ¸¬è©¦ï¼ˆæ‰‹æ©Ÿã€Emailï¼‰

#### PaymentHandler
- [ ] `formatCardNumber()` æ ¼å¼åŒ–å¡è™Ÿ
- [ ] `formatCardExpiry()` æ ¼å¼åŒ–åˆ°æœŸæ—¥
- [ ] `formatCardCVV()` CVV é™åˆ¶

#### CardManager
- [ ] `createCard()` å‰µå»ºå¡ç‰‡
- [ ] `deleteCard()` åˆªé™¤å¡ç‰‡
- [ ] `getAllCardData()` æ”¶é›†æ•¸æ“š
- [ ] `generateField()` ç”Ÿæˆæ¬„ä½

#### SubmitHandler
- [ ] `submit()` æäº¤è³‡æ–™
- [ ] `handleError()` éŒ¯èª¤è™•ç†

**ç¯„ä¾‹**ï¼š
```javascript
// tests/unit/CardManager.test.js
import { describe, test, expect, beforeEach } from 'vitest';
import { CardManager } from '../public/js/service-form-engine/CardManager.js';

describe('CardManager', () => {
    let cardManager;
    
    beforeEach(() => {
        document.body.innerHTML = `<div id="applicantCardList"></div>`;
        cardManager = new CardManager(mockConfig, mockElements, mockHooks);
    });
    
    test('createCard() æ‡‰è©²æ–°å¢å¡ç‰‡åˆ° DOM', () => {
        cardManager.createCard();
        const cards = document.querySelectorAll('.applicant-card');
        expect(cards.length).toBe(1);
    });
    
    test('deleteCard() æ‡‰è©²è‡³å°‘ä¿ç•™ä¸€å¼µå¡ç‰‡', () => {
        cardManager.createCard();
        cardManager.createCard();
        
        const cards = document.querySelectorAll('.applicant-card');
        cardManager.deleteCard(cards[0]);
        
        expect(document.querySelectorAll('.applicant-card').length).toBe(1);
    });
});
```

**ç›®æ¨™è¦†è“‹ç‡**ï¼šâ‰¥ 80%

---

### 2. æ•´åˆæ¸¬è©¦ï¼ˆ30%ï¼Œç´„ 50 å€‹æ¸¬è©¦ï¼‰

**å·¥å…·**ï¼šVitest + JSDOMï¼ˆæ¨¡æ“¬ç€è¦½å™¨ç’°å¢ƒï¼‰

**è¦†è“‹ç¯„åœ**ï¼š

#### å¼•æ“åˆå§‹åŒ–æµç¨‹
- [ ] å¼•æ“æ­£ç¢ºåˆå§‹åŒ–æ‰€æœ‰æ¨¡çµ„
- [ ] äº‹ä»¶ç›£è½æ­£ç¢ºç¶å®š
- [ ] é‰¤å­ç³»çµ±æ­£å¸¸é‹ä½œ

#### è¡¨å–®å®Œæ•´æµç¨‹
- [ ] è¼‰å…¥ â†’ å¡«å¯« â†’ é©—è­‰ â†’ æäº¤
- [ ] èªè­‰æµç¨‹æ•´åˆæ¸¬è©¦
- [ ] å¡ç‰‡ç®¡ç†èˆ‡è¨ˆç®—æ•´åˆ

**ç¯„ä¾‹**ï¼š
```javascript
// tests/integration/DD-flow.test.js
import { describe, test, expect } from 'vitest';
import { ServiceFormEngine } from '../public/js/service-form-engine/ServiceFormEngine.js';
import { ddConfig } from '../public/service/configs/dd.config.js';

describe('DD æœå‹™å®Œæ•´æµç¨‹', () => {
    test('æ‡‰è©²æ­£ç¢ºè¼‰å…¥ä¸¦åˆå§‹åŒ–', async () => {
        document.body.innerHTML = `<!-- DD.html çš„ HTML çµæ§‹ -->`;
        
        const engine = new ServiceFormEngine(ddConfig);
        await engine.init();
        
        expect(engine.modules.auth).toBeDefined();
        expect(engine.modules.cards).toBeDefined();
    });
    
    test('æ‡‰è©²æ­£ç¢ºæ”¶é›†è¡¨å–®è³‡æ–™', () => {
        // æ¨¡æ“¬ç”¨æˆ¶å¡«å¯«è¡¨å–®
        engine.elements.contactName.value = 'æ¸¬è©¦ç”¨æˆ¶';
        engine.elements.contactPhone.value = '0912345678';
        
        // æ–°å¢å ±åè€…
        engine.modules.cards.createCard();
        
        // æ”¶é›†è³‡æ–™
        const formData = engine.collectFormData();
        
        expect(formData.contactInfo.name).toBe('æ¸¬è©¦ç”¨æˆ¶');
        expect(formData.applicants.length).toBe(1);
    });
});
```

---

### 3. ç«¯åˆ°ç«¯æ¸¬è©¦ï¼ˆ10%ï¼Œç´„ 20 å€‹æ¸¬è©¦ï¼‰

**å·¥å…·**ï¼šPlaywright

**è¦†è“‹ç¯„åœ**ï¼š

#### DD æœå‹™ï¼ˆå®Œæ•´ç”¨æˆ¶æ—…ç¨‹ï¼‰
- [ ] è¨ªå• DD.html
- [ ] é»æ“Š LINE ç™»å…¥ï¼ˆæ¨¡æ“¬ï¼‰
- [ ] è‡ªå‹•å¡«å…¥è¯çµ¡äººè³‡è¨Š
- [ ] å¡«å¯«å ±åè€…è³‡æ–™
- [ ] è¼¸å…¥ç”Ÿæ—¥ï¼Œé©—è­‰ç”Ÿè‚–è‡ªå‹•è¨ˆç®—
- [ ] æ–°å¢ç¬¬äºŒå€‹å ±åè€…
- [ ] é¸æ“‡æ„Ÿè¬ç‹€é ˜å–æ–¹å¼
- [ ] å¡«å¯«ä¿¡ç”¨å¡è³‡è¨Š
- [ ] é©—è­‰ç¸½é‡‘é¡æ­£ç¢º
- [ ] é»æ“Šé€å‡º
- [ ] å°å‘æˆåŠŸé é¢

**ç¯„ä¾‹**ï¼š
```javascript
// tests/e2e/DD.spec.js
import { test, expect } from '@playwright/test';

test('DD æœå‹™å®Œæ•´æµç¨‹', async ({ page }) => {
    // 1. è¨ªå•é é¢
    await page.goto('/service/DD.html');
    
    // 2. æ¨¡æ“¬å·²ç™»å…¥ç‹€æ…‹ï¼ˆè¨­å®š localStorageï¼‰
    await page.evaluate(() => {
        localStorage.setItem('line_state', 'test-state');
        // æ¨¡æ“¬ Firebase Auth
    });
    
    // 3. å¡«å¯«è¯çµ¡äººè³‡è¨Š
    await page.fill('#contactName', 'æ¸¬è©¦ç”¨æˆ¶');
    await page.fill('#contactPhone', '0912345678');
    await page.fill('#contactEmail', 'test@example.com');
    
    // 4. å¡«å¯«å ±åè€…è³‡æ–™
    await page.fill('.card-input-name', 'å ±åè€…1');
    await page.fill('.card-input-birthdate', '1990-01-01');
    
    // 5. é©—è­‰ç”Ÿè‚–è‡ªå‹•è¨ˆç®—
    const shengxiao = await page.locator('.card-input-shengxiao').inputValue();
    expect(shengxiao).toBe('horse');  // 1990 å¹´å±¬é¦¬
    
    // 6. æ–°å¢ç¬¬äºŒå€‹å ±åè€…
    await page.click('#addApplicantBtn');
    const cards = await page.locator('.applicant-card').count();
    expect(cards).toBe(2);
    
    // 7. é¸æ“‡æ„Ÿè¬ç‹€é ˜å–æ–¹å¼
    await page.click('input[name="receiptOption"][value="self"]');
    const addressDisabled = await page.locator('#contactAddress').isDisabled();
    expect(addressDisabled).toBe(true);  // è¦ªè‡ªé ˜å–æ™‚é–å®šåœ°å€
    
    // 8. å¡«å¯«ä¿¡ç”¨å¡
    await page.fill('#cardNumber', '4111111111111111');
    await page.fill('#cardExpiry', '12/25');
    await page.fill('#cardCVV', '123');
    
    // 9. é©—è­‰ç¸½é‡‘é¡
    const totalAmount = await page.locator('#totalAmount').textContent();
    expect(totalAmount).toBe('1000');  // 2 ç› Ã— 500 å…ƒ
    
    // 10. é€å‡º
    await page.click('#submitBtn');
    
    // 11. é©—è­‰å°å‘æˆåŠŸé 
    await expect(page).toHaveURL(/success\.html\?orderId=.*&service=dd/);
});
```

---

## ğŸ“Š å›æ­¸æ¸¬è©¦è¨ˆåŠƒ

### å›æ­¸æ¸¬è©¦æ¸…å–®ï¼ˆæ¯å€‹æœå‹™å¿…é ˆ 100% é€šéï¼‰

#### 1. èªè­‰æµç¨‹ï¼ˆ5 é …ï¼‰
- [ ] æœªç™»å…¥æ™‚é¡¯ç¤ºç™»å…¥æç¤º
- [ ] LINE ç™»å…¥æŒ‰éˆ•æ­£å¸¸é‹ä½œ
- [ ] LINE ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•å¡«å…¥è¯çµ¡äººè³‡è¨Š
- [ ] ç™»å…¥ç‹€æ…‹åœ¨é é¢åˆ·æ–°å¾Œä¿æŒ
- [ ] ç™»å‡ºåŠŸèƒ½æ­£å¸¸

#### 2. è¡¨å–®é©—è­‰ï¼ˆ8 é …ï¼‰
- [ ] å¿…å¡«æ¬„ä½æœªå¡«æ™‚é¡¯ç¤ºéŒ¯èª¤æç¤º
- [ ] æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼é©—è­‰æ­£ç¢º
- [ ] Email æ ¼å¼é©—è­‰æ­£ç¢º
- [ ] åœ°å€æ¬„ä½ä¾æ“šé ˜å–æ–¹å¼é¡¯ç¤º/é–å®š
- [ ] éŒ¯èª¤æç¤ºæ­£ç¢ºæ²å‹•åˆ°ç¬¬ä¸€å€‹éŒ¯èª¤æ¬„ä½
- [ ] ä¿®æ­£éŒ¯èª¤å¾Œæç¤ºè‡ªå‹•æ¶ˆå¤±
- [ ] æäº¤å‰å†æ¬¡é©—è­‰æ‰€æœ‰æ¬„ä½
- [ ] é©—è­‰å¤±æ•—æ™‚ä¸ç™¼é€è«‹æ±‚

#### 3. å¡ç‰‡ç®¡ç†ï¼ˆ7 é …ï¼‰
- [ ] é è¨­é¡¯ç¤ºä¸€å¼µå ±åè€…å¡ç‰‡
- [ ] é»æ“Šã€Œæ–°å¢å ±åè€…ã€æ­£ç¢ºæ–°å¢å¡ç‰‡
- [ ] å¡ç‰‡å¯ä»¥æ‘ºç–Š/å±•é–‹
- [ ] å¯ä»¥åˆªé™¤å¡ç‰‡ï¼ˆè‡³å°‘ä¿ç•™ä¸€å¼µï¼‰
- [ ] åˆªé™¤å¡ç‰‡å¾Œé‡æ–°ç·¨è™Ÿ
- [ ] ç¬¬ä¸€å¼µå¡ç‰‡å§“åèˆ‡è¯çµ¡äººå§“åé›™å‘åŒæ­¥
- [ ] å¡ç‰‡æ•¸æ“šæ­£ç¢ºæ”¶é›†

#### 4. ç”Ÿè‚–è¨ˆç®—ï¼ˆ6 é …ï¼‰
- [ ] è¼¸å…¥é™½æ›†ç”Ÿæ—¥å¾Œè‡ªå‹•è¨ˆç®—ç”Ÿè‚–
- [ ] ç”Ÿè‚–é¸é …è‡ªå‹•é¸ä¸­
- [ ] é¡¯ç¤ºè¾²æ›†æ—¥æœŸ
- [ ] é¡¯ç¤ºæ°‘åœ‹å¹´
- [ ] é¡¯ç¤ºè¥¿å…ƒå¹´
- [ ] è·¨å¹´é‚Šç•Œè¨ˆç®—æ­£ç¢º

#### 5. è¨ˆç®—é‚è¼¯ï¼ˆ4 é …ï¼‰
- [ ] ç¸½æ•¸é‡ = å ±åè€…æ•¸é‡
- [ ] ç¸½é‡‘é¡ = ç¸½æ•¸é‡ Ã— å–®åƒ¹
- [ ] æ–°å¢å¡ç‰‡æ™‚å³æ™‚æ›´æ–°
- [ ] åˆªé™¤å¡ç‰‡æ™‚å³æ™‚æ›´æ–°

#### 6. æ”¯ä»˜è™•ç†ï¼ˆ5 é …ï¼‰
- [ ] ä¿¡ç”¨å¡è™Ÿç¢¼è‡ªå‹•æ ¼å¼åŒ–
- [ ] åˆ°æœŸæ—¥è‡ªå‹•æ ¼å¼åŒ–
- [ ] CVV é™åˆ¶ 3-4 ä½æ•¸å­—
- [ ] æ”¯ä»˜è³‡æ–™æ­£ç¢ºæ”¶é›†
- [ ] æ•æ„Ÿè³‡æ–™ä¸å¤–æ´©åˆ° console

#### 7. æäº¤æµç¨‹ï¼ˆ6 é …ï¼‰
- [ ] é»æ“Šã€Œé€å‡ºç”³è«‹ã€é©—è­‰æ‰€æœ‰æ¬„ä½
- [ ] æäº¤æ™‚é¡¯ç¤º loading ç‹€æ…‹
- [ ] è³‡æ–™æ­£ç¢ºé€åˆ° Cloud Function
- [ ] Cloud Function å›æ‡‰æ­£ç¢ºè™•ç†
- [ ] æˆåŠŸå¾Œå°å‘ success.html
- [ ] å¤±æ•—æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯

**ç¸½è¨ˆ**ï¼š41 é …æ¸¬è©¦

---

## ğŸš€ åˆ†éšæ®µä¸Šç·šç­–ç•¥

### é‡‘çµ²é›€éƒ¨ç½²ï¼ˆCanary Deploymentï¼‰

#### éšæ®µ 1ï¼šå…§éƒ¨æ¸¬è©¦ï¼ˆ1 å¤©ï¼‰
- **å°è±¡**ï¼šé–‹ç™¼åœ˜éšŠ
- **ç¯„åœ**ï¼šDD æœå‹™
- **é©—è­‰**ï¼šå®Œæ•´å›æ­¸æ¸¬è©¦é€šé

#### éšæ®µ 2ï¼šå°ç¯„åœç”¨æˆ¶æ¸¬è©¦ï¼ˆ3 å¤©ï¼‰
- **å°è±¡**ï¼š5% ç”¨æˆ¶
- **ç¯„åœ**ï¼šDD æœå‹™
- **ç›£æ§**ï¼š
  - Cloud Function æˆåŠŸç‡ â‰¥ 99%
  - JavaScript éŒ¯èª¤ç‡ < 0.1%
  - ç”¨æˆ¶æŠ±æ€¨ = 0

#### éšæ®µ 3ï¼šDD æœå‹™å…¨é‡ä¸Šç·šï¼ˆ1 å¤©ï¼‰
- **å°è±¡**ï¼š100% ç”¨æˆ¶
- **ç¯„åœ**ï¼šDD æœå‹™
- **ç›£æ§**ï¼šæŒçºŒ 24 å°æ™‚ç„¡ç•°å¸¸

#### éšæ®µ 4ï¼šæ‰¹æ¬¡ä¸Šç·šå…¶ä»–æœå‹™ï¼ˆ1 é€±ï¼‰
- **é †åº**ï¼šLD â†’ ND â†’ PS â†’ QJ â†’ ZY â†’ BG â†’ FTC â†’ FTP â†’ FTY â†’ XY
- **ç­–ç•¥**ï¼šæ¯å€‹æœå‹™ä¸Šç·š 1 å¤©å¾Œå†ä¸Šç·šä¸‹ä¸€å€‹
- **ç›£æ§**ï¼šåŒéšæ®µ 3

---

## ğŸ“ˆ ç›£æ§èˆ‡å‘Šè­¦

### é—œéµæŒ‡æ¨™

#### 1. æ¥­å‹™æŒ‡æ¨™
- **è¨‚å–®æäº¤æˆåŠŸç‡** â‰¥ 99%
  - å‘Šè­¦ï¼š< 95%
  - ç·Šæ€¥å‘Šè­¦ï¼š< 90%

- **LINE ç™»å…¥æˆåŠŸç‡** â‰¥ 95%
  - å‘Šè­¦ï¼š< 90%

#### 2. æŠ€è¡“æŒ‡æ¨™
- **Cloud Function éŒ¯èª¤ç‡** < 1%
  - å‘Šè­¦ï¼š> 5%
  - ç·Šæ€¥å‘Šè­¦ï¼š> 10%

- **å‰ç«¯ JavaScript éŒ¯èª¤ç‡** < 0.1%
  - å‘Šè­¦ï¼š> 1%

- **é é¢è¼‰å…¥æ™‚é–“** < 2 ç§’
  - å‘Šè­¦ï¼š> 3 ç§’

#### 3. ç”¨æˆ¶é«”é©—æŒ‡æ¨™
- **ç”¨æˆ¶æŠ±æ€¨æ•¸é‡** = 0
  - å‘Šè­¦ï¼š> 1

---

### ç›£æ§å·¥å…·

#### Firebase Console
- Cloud Functions éŒ¯èª¤æ—¥èªŒ
- æ•ˆèƒ½ç›£æ§

#### Google Analytics
- é é¢è¼‰å…¥æ™‚é–“
- ç”¨æˆ¶è¡Œç‚ºè¿½è¹¤

#### Sentryï¼ˆå¦‚é©ç”¨ï¼‰
- JavaScript éŒ¯èª¤è¿½è¹¤
- éŒ¯èª¤å †ç–Šåˆ†æ

---

### å‘Šè­¦é€šçŸ¥

#### é€šçŸ¥æ¸ é“
- ğŸ“§ Email
- ğŸ’¬ Slack / LINE
- ğŸ“± SMSï¼ˆç·Šæ€¥å‘Šè­¦ï¼‰

#### å‘Šè­¦åˆ†ç´š
- **P0ï¼ˆç·Šæ€¥ï¼‰**ï¼šæ¥­å‹™å®Œå…¨ä¸­æ–·ï¼Œéœ€ç«‹å³è™•ç†
- **P1ï¼ˆåš´é‡ï¼‰**ï¼šå½±éŸ¿éƒ¨åˆ†ç”¨æˆ¶ï¼Œéœ€ 1 å°æ™‚å…§è™•ç†
- **P2ï¼ˆä¸€èˆ¬ï¼‰**ï¼šç”¨æˆ¶é«”é©—ä¸‹é™ï¼Œéœ€ 1 å¤©å…§è™•ç†
- **P3ï¼ˆè¼•å¾®ï¼‰**ï¼šç›£æ§å³å¯

---

## ğŸ”§ æ•…éšœæ‡‰å°è¨ˆåŠƒ

### P0 ç·Šæ€¥æ•…éšœï¼ˆæ¥­å‹™å®Œå…¨ä¸­æ–·ï¼‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- Cloud Function æˆåŠŸç‡ < 90%
- ç”¨æˆ¶å®Œå…¨ç„¡æ³•æäº¤è¨‚å–®
- LINE ç™»å…¥å®Œå…¨å¤±æ•—

**æ‡‰å°æ­¥é©Ÿ**ï¼ˆSLA: 10 åˆ†é˜å…§å›æ»¾ï¼‰ï¼š

1. **ç«‹å³å›æ»¾**ï¼ˆ5 åˆ†é˜ï¼‰
   ```bash
   # é‚„åŸèˆŠä»£ç¢¼
   git revert HEAD
   git push
   
   # æˆ–ä½¿ç”¨å‚™ä»½
   cp public/service/js/DD.js.backup_20250111 public/service/js/DD.js
   git add public/service/js/DD.js
   git commit -m "revert: ç·Šæ€¥å›æ»¾ DD æœå‹™"
   git push
   ```

2. **é©—è­‰æ¢å¾©**ï¼ˆ3 åˆ†é˜ï¼‰
   - æ‰‹å‹•æ¸¬è©¦æäº¤æµç¨‹
   - æª¢æŸ¥ Cloud Function æˆåŠŸç‡

3. **é€šçŸ¥ç”¨æˆ¶**ï¼ˆ2 åˆ†é˜ï¼‰
   - ç¶²ç«™æ©«å¹…ï¼šã€Œæœå‹™å·²æ¢å¾©æ­£å¸¸ã€

4. **äº‹å¾Œåˆ†æ**ï¼ˆ1 å°æ™‚å…§ï¼‰
   - æ ¹å› åˆ†æ
   - åˆ¶å®šä¿®å¾©è¨ˆåŠƒ

---

### P1 åš´é‡æ•…éšœï¼ˆå½±éŸ¿éƒ¨åˆ†ç”¨æˆ¶ï¼‰

**è§¸ç™¼æ¢ä»¶**ï¼š
- Cloud Function æˆåŠŸç‡ < 95%
- ç‰¹å®šåŠŸèƒ½ç•°å¸¸ï¼ˆå¦‚ç”Ÿè‚–è¨ˆç®—éŒ¯èª¤ï¼‰

**æ‡‰å°æ­¥é©Ÿ**ï¼ˆSLA: 1 å°æ™‚å…§è™•ç†ï¼‰ï¼š

1. **è©•ä¼°å½±éŸ¿ç¯„åœ**ï¼ˆ10 åˆ†é˜ï¼‰
   - å“ªäº›ç”¨æˆ¶å—å½±éŸ¿ï¼Ÿ
   - å“ªäº›æœå‹™å—å½±éŸ¿ï¼Ÿ

2. **æ±ºç­–**ï¼ˆ5 åˆ†é˜ï¼‰
   - å›æ»¾ vs ç·Šæ€¥ä¿®å¾©

3. **åŸ·è¡Œä¿®å¾©**ï¼ˆ30 åˆ†é˜ï¼‰
   - å¦‚å›æ»¾ï¼šåŒ P0 æµç¨‹
   - å¦‚ä¿®å¾©ï¼šhot fix â†’ æ¸¬è©¦ â†’ éƒ¨ç½²

4. **é©—è­‰æ¢å¾©**ï¼ˆ15 åˆ†é˜ï¼‰

---

## âœ… é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶
- [ ] æ‰€æœ‰ 11 å€‹æœå‹™é€šéå®Œæ•´å›æ­¸æ¸¬è©¦ï¼ˆ41 é … Ã— 11 = 451 é …ï¼‰
- [ ] å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ â‰¥ 80%
- [ ] æ•´åˆæ¸¬è©¦å…¨éƒ¨é€šé
- [ ] ç«¯åˆ°ç«¯æ¸¬è©¦å…¨éƒ¨é€šé

### æ•ˆèƒ½é©—æ”¶
- [ ] Lighthouse åˆ†æ•¸ â‰¥ 90
- [ ] é¦–æ¬¡è¼‰å…¥æ™‚é–“ < 2 ç§’
- [ ] äº’å‹•æ™‚é–“ï¼ˆTTIï¼‰< 3 ç§’

### ç©©å®šæ€§é©—æ”¶
- [ ] Cloud Function æˆåŠŸç‡ â‰¥ 99%ï¼ˆ7 å¤©å¹³å‡ï¼‰
- [ ] JavaScript éŒ¯èª¤ç‡ < 0.1%ï¼ˆ7 å¤©å¹³å‡ï¼‰
- [ ] ç”¨æˆ¶æŠ±æ€¨ = 0ï¼ˆ7 å¤©å…§ï¼‰

### ä»£ç¢¼å“è³ªé©—æ”¶
- [ ] ESLint ç„¡éŒ¯èª¤
- [ ] ä»£ç¢¼å¯©æŸ¥é€šé
- [ ] æ–‡ä»¶å®Œæ•´ï¼ˆæ¶æ§‹ã€APIã€æ¸¬è©¦ï¼‰

---

## ğŸ“ ç¸½çµ

æœ¬é¢¨éšªè©•ä¼°æ–‡ä»¶è­˜åˆ¥äº† **8 å€‹ä¸»è¦é¢¨éšª**ï¼Œä¸¦é‡å°æ¯å€‹é¢¨éšªåˆ¶å®šäº†è©³ç´°çš„ç·©è§£æªæ–½ã€‚

**é‡é»é¢¨éšª**ï¼š
1. ğŸ”´ Cloud Function è³‡æ–™æ ¼å¼ä¸å…¼å®¹ï¼ˆæå‰é©—è­‰ã€é‡‘çµ²é›€éƒ¨ç½²ï¼‰
2. ğŸ”´ LINE OAuth èªè­‰æµç¨‹ä¸­æ–·ï¼ˆéš”é›¢æ¨¡çµ„ã€å……åˆ†æ¸¬è©¦ï¼‰
3. ğŸ”´ ç”Ÿè‚–è¨ˆç®—éŒ¯èª¤ï¼ˆå–®å…ƒæ¸¬è©¦ã€å°ç…§æ¸¬è©¦ï¼‰

**æ¸¬è©¦ç­–ç•¥**ï¼š
- å–®å…ƒæ¸¬è©¦ 60%ï¼ˆ150 å€‹ï¼‰
- æ•´åˆæ¸¬è©¦ 30%ï¼ˆ50 å€‹ï¼‰
- ç«¯åˆ°ç«¯æ¸¬è©¦ 10%ï¼ˆ20 å€‹ï¼‰

**ä¸Šç·šç­–ç•¥**ï¼š
- é‡‘çµ²é›€éƒ¨ç½²
- åˆ†éšæ®µä¸Šç·š
- å³æ™‚ç›£æ§

**å›æ»¾è¨ˆåŠƒ**ï¼š
- P0 æ•…éšœï¼š10 åˆ†é˜å…§å›æ»¾
- P1 æ•…éšœï¼š1 å°æ™‚å…§è™•ç†

---

**ç‰ˆæœ¬**ï¼šv1.0  
**å»ºç«‹æ—¥æœŸ**ï¼š2025-11-11  
**ä½œè€…**ï¼šReplit Agent  
**ç‹€æ…‹**ï¼šè¦åŠƒéšæ®µ
