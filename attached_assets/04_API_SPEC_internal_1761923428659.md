---
Document ID: DOC-API-04
Version: 1.0-internal
Last Updated: 2025-10-30
Maintainer: guimashan-dev
Visibility: internal-only
---
## API 與 Cloud Functions 規格文件 (Internal)

本文件定義所有內部 Cloud Functions 端點、請求 / 回應格式、授權要求與錯誤代碼標準。  

---

## 1. 整體說明

系統後端主要使用 Firebase Cloud Functions（Node.js 20 環境），  
並依模組區分部署：

| 模組 | Firebase 專案 ID | 命名慣例 |
|------|------------------|----------|
| 平台層 (Platform) | **platform-bc783** | `platform-*` |
| 奉香簽到 (Check-in) | **checkin-29f7f** | `checkin-*` |
| 神服服務 (Service) | **service-b9d4a** | `service-*` |
| 排班系統 (Schedule) | **schedule-48ff9** | `schedule-*` |

所有端點皆需帶入 **Firebase ID Token** 驗證使用者身分。  

---

## 2. 通用授權與安全規範

1. **所有 HTTP 端點需驗證 Firebase Token**
   - Request Header:  
     ```
     Authorization: Bearer <Firebase_ID_Token>
     ```
2. **角色授權層級**
   - user：一般使用者，僅能操作自己資料。
   - poweruser：可建立服務單。
   - admin：可審核、修改、匯出資料。
   - superadmin：可管理角色與設定。

3. **錯誤回應格式**
   ```json
   {
     "ok": false,
     "code": "2001_NOT_AUTHORIZED",
     "message": "User role not permitted for this operation"
   }        
```
``
## **3. 奉香簽到模組 (checkin-29f7f)**
### **3.1 驗證簽到距離 —** **verifyCheckinDistance**

- **Method:** POST
- **Endpoint:** https://asia-east2-checkin-29f7f.cloudfunctions.net/verifyCheckinDistance

**Request**
```
{
  "userId": "UID_xxx",
  "patrolId": "P001",
  "lat": 25.147924,
  "lng": 121.410296
}
```

**Response (成功)**
```
{
  "ok": true,
  "distanceMeters": 12.5,
  "patrolId": "P001",
  "createdAt": "2025-10-30T12:00:00Z"
}
```

**Response (失敗)**
```
{
  "ok": false,
  "code": "1001_OUT_OF_RANGE",
  "distanceMeters": 84.3,
  "allowedMeters": 30
}
```
> 🔴確認 distance 判定邏輯與容許誤差（建議 30 公尺）。

## **4. 神服服務模組 (service-b9d4a)**
### **4.1 建立服務單 —** **createServiceRequest**

- **Method:** POST
- **Endpoint:** https://asia-east2-service-b9d4a.cloudfunctions.net/createServiceRequest

**Request**
```
{
  "userId": "UID_xxx",
  "serviceType": "light",
  "applicantName": "張三",
  "wishFor": "家宅平安",
  "amount": 300,
  "note": "初一點燈"
}
```

**Response**
```
{
  "ok": true,
  "serviceId": "SV20251030001"
}
```
### **4.2 審核服務單 —**  approveServiceRequest

- **Method:** POST
- **Endpoint:** https://asia-east2-service-b9d4a.cloudfunctions.net/approveServiceRequest

**Request**
```
{
  "serviceId": "SV20251030001",
  "adminId": "UID_admin",
  "status": "approved",
  "note": "法會確認"
}
```
**Response**
```
{ "ok": true }
```
**授權條件**
- 僅限 admin / superadmin
- Cloud Function 內需驗證角色。

## **5. 排班模組 (schedule-48ff9)**
### **5.1 建立班表 —** **createSchedule**

- **Method:** POST
- **Endpoint:** https://asia-east2-schedule-48ff9.cloudfunctions.net/createSchedule

**Request**
```
{
  "date": "2025-11-01",
  "userId": "UID_abc",
  "shift": "morning"
}
```

**Response**
```
{ "ok": true, "scheduleId": "SC2025110101" }
```

### **5.2 更新出勤狀態 —**### **updateAttendance**

- **Method:** POST
- **Endpoint:** https://asia-east2-schedule-48ff9.cloudfunctions.net/updateAttendance

**Request**
```
{
  "scheduleId": "SC2025110101",
  "attendance": "present"
}
```

**Response**
```
{ "ok": true }
```

## **6. 平台層 (platform-bc783)**

### **6.1 產生 Custom Token —**  **generateCustomToken**

- **Method:** POST
- **Endpoint:** https://asia-east2-platform-bc783.cloudfunctions.net/generateCustomToken

**Request**
```
{ "lineUserId": "U4af4980629..." }
```

**Response**
```
{
  "ok": true,
  "firebaseCustomToken": "eyJhbGciOiJSUzI1NiIs..."
}
```

### **6.2 更新使用者角色 —** **updateUserRole**

- **Method:** POST
- **Endpoint:** https://asia-east2-platform-bc783.cloudfunctions.net/updateUserRole

**Request**
```
{
  "targetUserId": "UID_xxx",
  "newRole": "admin"
}
```

**Response**
```
{ "ok": true }
```

**授權條件**
- 需 admin 或 superadmin
- 若權限不足，回傳：
```
{ "ok": false, "code": "2001_NOT_AUTHORIZED" }
```

## **7. 錯誤代碼定義**
| **代碼**               | **說明**     |
| -------------------- | ---------- |
| 1000_INVALID_REQUEST | 請求格式錯誤     |
| 1001_OUT_OF_RANGE    | GPS 超出距離範圍 |
| 2000_INVALID_ROLE    | 無效角色       |
| 2001_NOT_AUTHORIZED  | 權限不足       |
| 3000_NOT_FOUND       | 找不到文件或資源   |
| 4000_INTERNAL_ERROR  | 系統內部錯誤     |
## **8. 安全實作與日誌**
- 所有 Functions 皆應寫入 console.log(JSON.stringify({userId, action, result}))。
- 錯誤記錄在 Cloud Logging，重要操作（角色變更、審核）須標註 severity=WARNING。
- 🔴如要串金流或上傳收據，請使用 Firebase Storage 並限制 MIME type。
## **9. 尚待補填項目**
- 🔴最終部署 region（預設 asia-east2）
- 🔴API Gateway / Rate limit 設定（若開放外部）
- 🔴Functions logging 級別與 retention 設定