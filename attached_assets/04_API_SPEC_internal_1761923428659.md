---
Document ID: DOC-API-04
Version: 1.0-internal
Last Updated: 2025-10-30
Maintainer: guimashan-dev
Visibility: internal-only
---
## API èˆ‡ Cloud Functions è¦æ ¼æ–‡ä»¶ (Internal)

æœ¬æ–‡ä»¶å®šç¾©æ‰€æœ‰å…§éƒ¨ Cloud Functions ç«¯é»ã€è«‹æ±‚ / å›æ‡‰æ ¼å¼ã€æˆæ¬Šè¦æ±‚èˆ‡éŒ¯èª¤ä»£ç¢¼æ¨™æº–ã€‚  

---

## 1. æ•´é«”èªªæ˜

ç³»çµ±å¾Œç«¯ä¸»è¦ä½¿ç”¨ Firebase Cloud Functionsï¼ˆNode.js 20 ç’°å¢ƒï¼‰ï¼Œ  
ä¸¦ä¾æ¨¡çµ„å€åˆ†éƒ¨ç½²ï¼š

| æ¨¡çµ„ | Firebase å°ˆæ¡ˆ ID | å‘½åæ…£ä¾‹ |
|------|------------------|----------|
| å¹³å°å±¤ (Platform) | **platform-bc783** | `platform-*` |
| å¥‰é¦™ç°½åˆ° (Check-in) | **checkin-29f7f** | `checkin-*` |
| ç¥æœæœå‹™ (Service) | **service-b9d4a** | `service-*` |
| æ’ç­ç³»çµ± (Schedule) | **schedule-48ff9** | `schedule-*` |

æ‰€æœ‰ç«¯é»çš†éœ€å¸¶å…¥ **Firebase ID Token** é©—è­‰ä½¿ç”¨è€…èº«åˆ†ã€‚  

---

## 2. é€šç”¨æˆæ¬Šèˆ‡å®‰å…¨è¦ç¯„

1. **æ‰€æœ‰ HTTP ç«¯é»éœ€é©—è­‰ Firebase Token**
   - Request Header:  
     ```
     Authorization: Bearer <Firebase_ID_Token>
     ```
2. **è§’è‰²æˆæ¬Šå±¤ç´š**
   - userï¼šä¸€èˆ¬ä½¿ç”¨è€…ï¼Œåƒ…èƒ½æ“ä½œè‡ªå·±è³‡æ–™ã€‚
   - poweruserï¼šå¯å»ºç«‹æœå‹™å–®ã€‚
   - adminï¼šå¯å¯©æ ¸ã€ä¿®æ”¹ã€åŒ¯å‡ºè³‡æ–™ã€‚
   - superadminï¼šå¯ç®¡ç†è§’è‰²èˆ‡è¨­å®šã€‚

3. **éŒ¯èª¤å›æ‡‰æ ¼å¼**
   ```json
   {
     "ok": false,
     "code": "2001_NOT_AUTHORIZED",
     "message": "User role not permitted for this operation"
   }        
```
``
## **3. å¥‰é¦™ç°½åˆ°æ¨¡çµ„ (checkin-29f7f)**
### **3.1 é©—è­‰ç°½åˆ°è·é›¢ â€”**Â **verifyCheckinDistance**

- **Method:** POST
- **Endpoint:** https://asia-east2-checkin-29f7f.cloudfunctions.net/verifyCheckinDistance

**Request**
```
{
  "userId": "UID_xxx",
  "patrolId": "P001",
  "lat": 25.147924,
  "lng": 121.410296
}
```

**Response (æˆåŠŸ)**
```
{
  "ok": true,
  "distanceMeters": 12.5,
  "patrolId": "P001",
  "createdAt": "2025-10-30T12:00:00Z"
}
```

**Response (å¤±æ•—)**
```
{
  "ok": false,
  "code": "1001_OUT_OF_RANGE",
  "distanceMeters": 84.3,
  "allowedMeters": 30
}
```
> ğŸ”´ç¢ºèª distance åˆ¤å®šé‚è¼¯èˆ‡å®¹è¨±èª¤å·®ï¼ˆå»ºè­° 30 å…¬å°ºï¼‰ã€‚

## **4. ç¥æœæœå‹™æ¨¡çµ„ (service-b9d4a)**
### **4.1 å»ºç«‹æœå‹™å–® â€”**Â **createServiceRequest**

- **Method:** POST
- **Endpoint:** https://asia-east2-service-b9d4a.cloudfunctions.net/createServiceRequest

**Request**
```
{
  "userId": "UID_xxx",
  "serviceType": "light",
  "applicantName": "å¼µä¸‰",
  "wishFor": "å®¶å®…å¹³å®‰",
  "amount": 300,
  "note": "åˆä¸€é»ç‡ˆ"
}
```

**Response**
```
{
  "ok": true,
  "serviceId": "SV20251030001"
}
```
### **4.2 å¯©æ ¸æœå‹™å–® â€”**  approveServiceRequest

- **Method:** POST
- **Endpoint:** https://asia-east2-service-b9d4a.cloudfunctions.net/approveServiceRequest

**Request**
```
{
  "serviceId": "SV20251030001",
  "adminId": "UID_admin",
  "status": "approved",
  "note": "æ³•æœƒç¢ºèª"
}
```
**Response**
```
{ "ok": true }
```
**æˆæ¬Šæ¢ä»¶**
- åƒ…é™ admin / superadmin
- Cloud Function å…§éœ€é©—è­‰è§’è‰²ã€‚

## **5. æ’ç­æ¨¡çµ„ (schedule-48ff9)**
### **5.1 å»ºç«‹ç­è¡¨ â€”**Â **createSchedule**

- **Method:** POST
- **Endpoint:** https://asia-east2-schedule-48ff9.cloudfunctions.net/createSchedule

**Request**
```
{
  "date": "2025-11-01",
  "userId": "UID_abc",
  "shift": "morning"
}
```

**Response**
```
{ "ok": true, "scheduleId": "SC2025110101" }
```

### **5.2 æ›´æ–°å‡ºå‹¤ç‹€æ…‹ â€”**### **updateAttendance**

- **Method:** POST
- **Endpoint:** https://asia-east2-schedule-48ff9.cloudfunctions.net/updateAttendance

**Request**
```
{
  "scheduleId": "SC2025110101",
  "attendance": "present"
}
```

**Response**
```
{ "ok": true }
```

## **6. å¹³å°å±¤ (platform-bc783)**

### **6.1 ç”¢ç”Ÿ Custom Token â€”**Â  **generateCustomToken**

- **Method:** POST
- **Endpoint:** https://asia-east2-platform-bc783.cloudfunctions.net/generateCustomToken

**Request**
```
{ "lineUserId": "U4af4980629..." }
```

**Response**
```
{
  "ok": true,
  "firebaseCustomToken": "eyJhbGciOiJSUzI1NiIs..."
}
```

### **6.2 æ›´æ–°ä½¿ç”¨è€…è§’è‰² â€”** **updateUserRole**

- **Method:** POST
- **Endpoint:** https://asia-east2-platform-bc783.cloudfunctions.net/updateUserRole

**Request**
```
{
  "targetUserId": "UID_xxx",
  "newRole": "admin"
}
```

**Response**
```
{ "ok": true }
```

**æˆæ¬Šæ¢ä»¶**
- éœ€ admin æˆ– superadmin
- è‹¥æ¬Šé™ä¸è¶³ï¼Œå›å‚³ï¼š
```
{ "ok": false, "code": "2001_NOT_AUTHORIZED" }
```

## **7. éŒ¯èª¤ä»£ç¢¼å®šç¾©**
| **ä»£ç¢¼**               | **èªªæ˜**     |
| -------------------- | ---------- |
| 1000_INVALID_REQUEST | è«‹æ±‚æ ¼å¼éŒ¯èª¤     |
| 1001_OUT_OF_RANGE    | GPS è¶…å‡ºè·é›¢ç¯„åœ |
| 2000_INVALID_ROLE    | ç„¡æ•ˆè§’è‰²       |
| 2001_NOT_AUTHORIZED  | æ¬Šé™ä¸è¶³       |
| 3000_NOT_FOUND       | æ‰¾ä¸åˆ°æ–‡ä»¶æˆ–è³‡æº   |
| 4000_INTERNAL_ERROR  | ç³»çµ±å…§éƒ¨éŒ¯èª¤     |
## **8. å®‰å…¨å¯¦ä½œèˆ‡æ—¥èªŒ**
- æ‰€æœ‰ Functions çš†æ‡‰å¯«å…¥ console.log(JSON.stringify({userId, action, result}))ã€‚
- éŒ¯èª¤è¨˜éŒ„åœ¨ Cloud Loggingï¼Œé‡è¦æ“ä½œï¼ˆè§’è‰²è®Šæ›´ã€å¯©æ ¸ï¼‰é ˆæ¨™è¨» severity=WARNINGã€‚
- ğŸ”´å¦‚è¦ä¸²é‡‘æµæˆ–ä¸Šå‚³æ”¶æ“šï¼Œè«‹ä½¿ç”¨ Firebase Storage ä¸¦é™åˆ¶ MIME typeã€‚
## **9. å°šå¾…è£œå¡«é …ç›®**
- ğŸ”´æœ€çµ‚éƒ¨ç½² regionï¼ˆé è¨­ asia-east2ï¼‰
- ğŸ”´API Gateway / Rate limit è¨­å®šï¼ˆè‹¥é–‹æ”¾å¤–éƒ¨ï¼‰
- ğŸ”´Functions logging ç´šåˆ¥èˆ‡ retention è¨­å®š