

Replit=R 社

**致 R 社 (Replit AI)：**

本藍圖包含兩大部分，請嚴格遵守：

1. **最終版規格更新日誌 (V3 架構)：** 告訴您「**要做什麼**」。
    
2. **Replit 開發環境設定指南：** 告訴您「**要如何設定環境來做**」。
    

請依循本藍圖，開始開發**第一階段 (Platform)** 和**第二階段 (Check-in)**。

---

### 第一部分：最終版規格更新日誌 (V3 架構)

以下是針對八份文件的所有變更與決策詳情：

#### 1. `01_SRS_PRD_internal.md` (系統需求書)

- **LINE 登入資訊 (Section 9):**
    
    - Channel ID: `2008269293`
        
    - Channel Secret: 025a71c97099343e6e688bb6e393a125
        
- **Firebase 專案資訊 (Section 9):**
    
    - `platform-bc783`: (ApiKey:AIzaSyAcQJA7Tx0LnW8M51WM9bChvlAS_J7qcEw/AppId:1:971307854623:web:29b96be8c4f0a457d19e2a)
        
    - `checkin-29f7f`: (ApiKey:AIzaSyAnXFLHm7u9Ji0ualJDl9qGQQ1l4zcRnvg/AppId:1:264033873783:web:d871356277e5d06749fb72)
        
    - `service-b9d4a`: (ApiKey:AIzaSyAxuPR2U1Gk03fNOOPndC00XPnLeCuH57o/AppId:1:662128429399:web:3a132ce010d046649a1612)
        
    - `schedule-48ff9`: (ApiKey:AIzaSyCnuspwgT20n5104dBtMVPfV54KclZI92s/AppId:1:135135952493:web:24fdd0155b17c881014964)
        
- **角色命名 (Section 8):** (**V3 架構變更**)
    
    - 原有的 `admin` 角色被廢除。
        
    - 角色系統**升級為陣列 (Array)**。
        
    - 新增角色：`admin_checkin`, `admin_service`, `admin_schedule`。
        

#### 2. `02_SAD_HLD_internal.md` (系統架構設計)

- **LINE 登入 (Section 1 & 9):**
    
    - 最終版 LINE Login callback URL 確認為：`https://go.guimashan.org.tw/__/auth/handler`。
        
    - 系統將同時支援此 Web 登入流程 (由 Firebase SDK 自動處理) 與 LIFF 登入流程 (使用 `generateCustomToken` API)。
        
- **前端部署 (Section 1, 6, 9):**
    
    - 部署策略：確認以 **Vercel 為主**。
        
    - Vercel 團隊名稱: `guimashan's projects`。
        
    - Vercel 專案 ID: `prj_FwuUrTa2m4MaMocVnb2wAGB8CPyy`。
        
    - Staging (測試) 網址：確認使用 `guimashan.vercel.app`。
        
- **後端部署 (Section 9):**
    
    - Cloud Functions 部署區域：確認使用 `asia-east2`。
        
- **安全設定 (Section 9):**
    
    - 確認**不啟用** `/admin/` 的 IP 白名單限制。
        

#### 3. `03_UI_UX_internal.md` (介面與使用者體驗)

- **角色與導覽 (Section 2):** (**V3 架構變更**)
    
    - 角色定義更新為 `admin_checkin`, `admin_service`, `admin_schedule`, `superadmin`。
        
    - 導覽行為變更：使用者登入後，前端需檢查其 `roles` (陣列)，以決定導向哪個管理頁面或顯示哪些 UI 元件。
        
- **奉香簽到 (Section 4.1):**
    
    - GPS 容許誤差：預設值為 30 公尺。
        
    - `checkin/admin.html` (巡邏點管理) 頁面 必須允許 `admin_checkin` 和 `superadmin` 自行新增/編輯巡邏點，並可自定義每個巡邏點的 `tolerance` (容許誤差) 欄位。
        
- **管理後台 (Section 4.4):** (**V3 架構變更**)
    
    - `admin/dashboard.html` (儀表板) 必須是**動態儀表板**。
        
    - 儀表板應根據使用者的 `roles` (陣列) 來決定顯示哪些模組的統計卡片（例如 `roles` 包含 `admin_checkin` 才顯示簽到統計）。
        
    - `superadmin` 可看到所有模組的統計。
        
- **神服服務 (Section 4.2 & 9):**
    
    - (待辦) 第三階段：檔案上傳功能 (Storage) 暫緩開發。
        

#### 4. `04_API_SPEC_internal.md` (API 與 Functions 規格)

- **通用授權 (Section 2):** (**V3 架構變更**)
    
    - 所有 API 的授權驗證邏輯，必須從檢查 `role` (字串) `== "admin"`，**全面升級**為檢查 `roles` (陣列) `includes("...")`。
        
    - 範例：`approveServiceRequest` (Section 4.2) 的授權條件改為 `roles.includes("admin_service") || roles.includes("superadmin")`。
        
- **簽到模組 (Section 3.1):**
    
    - `verifyCheckinDistance`: API 需讀取 `patrols/{patrolId}` 中的 `tolerance` 欄位 作為容許誤差（若該欄位不存在，則預設 30 公尺）。
        
- **平台層 (Section 6.2):** (**V3 架構變更**)
    
    - `updateUserRole`: 此 API 邏輯需重構，使其能夠編輯 `targetUserId` 的 `roles` (陣列)，例如新增或移除陣列中的特定角色字串。
        
- **尚待補填 (Section 9):**
    
    - 部署 Region：確認 `asia-east2`。
        
    - Rate Limit：確認**不用**。
        
    - Logging 保留：確認 **30 天**。
        

#### 5. `05_DDD_DB_DESIGN_internal.md` (資料模型與領域設計)

- **users 集合 (Section 3.1):** (**V3 架構變更 - 核心**)
    
    - `role` (String) 欄位**正式廢除**。
        
    - **變更為 `roles` (Array) 欄位**。
        
    - 範例：
        
        - 一般使用者: `roles: ["user"]`
            
        - 神服使用者: `roles: ["user", "poweruser"]`
            
        - 單一管理員: `roles: ["user", "poweruser", "admin_service"]`
            
        - 多重管理員: `roles: ["user", "poweruser", "admin_checkin", "admin_schedule"]`
            
        - 超級管理員: `roles: ["user", "poweruser", "admin_checkin", "admin_service", "admin_schedule", "superadmin"]`
            
    - `email` 欄位：確認啟用，用於記錄從 LINE 取得的 Email（非用於 Email/密碼 登入）。
        
- **checkins 集合 (Section 3.2 & 8):**
    
    - **啟用 TTL (Time-to-Live) 政策**。
        
    - 資料保留時間：**半年 (6 個月)**。
        
- **patrols 集合 (Section 3.3):**
    
    - `tolerance` 欄位：確認使用此欄位，預設 30 公尺。
        
- **globalConfig 集合 (Section 3.6 & 8):**
    
    - 確認**僅需中文**，不導入多語系欄位。
        
- **Storage (Section 8):**
    
    - (待辦) 第三階段：Storage 結構 (收據上傳) 暫緩設計。
        

#### 6. `06_TEST_PLAN_internal.md` (測試計畫)

- **測試環境 (Section 4):**
    
    - Staging 專案與域名：確認為 **`guimashan.vercel.app`**。
        
- **錯誤追蹤 (Section 9):**
    
    - 確認使用 **Google Sheets**。
        
- **尚待補填 (Section 10):**
    
    - 自動化測試：確認**初期 (P1/P2) 不導入**。
        
    - 最終驗收負責人：**您本人 (專案業主)**。
        

#### 7. `07_PMP_Project_Plan_internal.md` (專案計畫書)

- **專案組織 (Section 4 & 10):**
    
    - 專案經理：Gemini (AI 團隊)
        
    - 系統架構師：Gemini (AI 團隊)
        
    - 測試與驗收：您本人 (專案業主)
        
    - 維運與文件：Gemini (AI 團隊)
        
    - 前端/後端開發：R 社 (Replit AI)
        

#### 8. `README_internal_index.md` (索引文件)

- **文件維護 (Section 5 & 6):**
    
    - 角色分配已依 PMP 文件 更新。
        

---

### 第二部分：Replit 開發環境設定指南 (R 社用)

為了正確開發「龜馬山 goLine 平台」，Replit 專案必須符合以下環境設定：

#### 1. 核心環境 (Core Environment)

- **Node.js 版本：** 必須使用 **20.x** 版本。這符合 Cloud Functions Node.js 20 的執行環境。
    
- **Firebase CLI：** 必須安裝並使用最新版的 `firebase-tools` (Firebase CLI)。
    

#### 2. 專案結構 (Monorepo Setup)

- **單一倉庫 (Monorepo)：** 整個專案應在一個 Replit 倉庫中（GitHub: `guimashan/platfrom`），但程式碼需按模組**嚴格分離**。
    
- **前端目錄：** 依照 `03_UI_UX_internal.md` 的規劃，前端應有 `checkin/`, `service/`, `schedule/`, `admin/` 等子目錄，以及根目錄的 `login.html`。
    
- **後端目錄：** 建議建立一個 `functions/` 目錄，用來存放所有 Cloud Functions 的原始碼，並在內部再分子目錄 (例如 `functions/src/platform`, `functions/src/checkin` 等)。
    

#### 3. 🔴 特殊設定：環境變數 (Replit Secrets)

這是**最重要**的設定。根據 `02_SAD_HLD_internal.md` 的安全規範，**嚴禁**將任何 API Key 或 Secret 硬編碼 (Hardcode) 在程式碼中。所有金鑰必須使用 Replit 的 **"Secrets"** 工具來管理。

R 社在開發時，程式碼需要讀取以下 Secrets：

**A. 前端 (Client-Side) 所需的 Secrets：**

- 前端 JavaScript 必須**同時初始化四個 Firebase 應用實例**。程式碼應從 Secrets 讀取這四組金鑰（金鑰內容已由 PM 存檔）：
    
    - `REPLIT_SECRET_FIREBASE_CONFIG_PLATFORM` (內容為 `platform-bc783` 的 apiKey, appId 等)
        
    - `REPLIT_SECRET_FIREBASE_CONFIG_CHECKIN` (內容為 `checkin-29f7f` 的 apiKey, appId 等)
        
    - `REPLIT_SECRET_FIREBASE_CONFIG_SERVICE` (內容為 `service-b9d4a` 的 apiKey, appId 等)
        
    - `REPLIT_SECRET_FIREBASE_CONFIG_SCHEDULE` (內容為 `schedule-48ff9` 的 apiKey, appId 等)
        

**B. 後端 (Server-Side / Functions) 所需的 Secrets：**

- `platform-bc783` 專案中的 Cloud Functions (例如 `generateCustomToken`) 需要 LINE 的金鑰：
    
    - `REPLIT_SECRET_LINE_CHANNEL_ID_LOGIN` (值: `2008269293`)
        
    - `REPLIT_SECRET_LINE_CHANNEL_SECRET_LOGIN` (值: 已由 PM 存檔)
        
- Cloud Functions 需要 Firebase Admin SDK。在 Replit 環境中，可能需要設定 `GOOGLE_APPLICATION_CREDENTIALS` 指向您為**四個專案**分別下載的 Service Account JSON 金鑰。
    

#### 4. 本地開發與模擬 (Local Emulation)

- 在 Replit 中進行本地開發時，**必須**使用 **Firebase Emulator Suite**。
    
- R 社需要設定 `firebase.json` 檔案，以便能透過 `firebase emulators:start` 指令，在本機（Replit 伺服器上）模擬 **Auth, Firestore, 和 Functions** 服務，以利開發和測試。