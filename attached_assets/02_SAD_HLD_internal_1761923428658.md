---
Document ID: DOC-SAD-02
Version: 1.0-internal
Last Updated: 2025-10-30
Maintainer: guimashan-dev
Visibility: internal-only
---

# 龜馬山 goLine 平台
## 系統架構設計文件 (SAD / HLD)

本文件說明「龜馬山 goLine 平台」的整體技術架構、模組切分、前端路徑規劃與 Firebase 專案對應，供內部開發與維運人員參考。

---

## 1. 架構概述

系統採 **前後端分離**，前端以 HTML5 / JavaScript (ES6+) 實作並部署於 **Vercel**（Firebase Hosting 作為備援），後端以 **Google Firebase** 為主體，整合 LINE Login (OAuth 2.0)。

整體流程如下：

1. 使用者於瀏覽器開啟平台首頁。
2. 點選「LINE 登入」，導向 LINE OAuth。
3. 完成授權後回到平台層（platform-bc783），由 Cloud Function 產生 Firebase Custom Token。
4. 前端以該 Token 登入 Firebase Auth。
5. 依照角色導向各模組（checkin / service / schedule）對應的前端路徑。

---

## 2. 系統模組與 Firebase 專案

| 模組名稱 | Firebase 專案 ID | 主要用途 |
|----------|------------------|----------|
| **平台層 (Platform)** | **platform-bc783** | 登入、角色管理、公告、導流、共用後台 |
| **奉香簽到 (Check-in)** | **checkin-29f7f** | GPS 驗證簽到、巡邏點管理、簽到紀錄存取 |
| **神服服務 (Service)** | **service-b9d4a** | 點燈、法會報名、香油錢紀錄、管理審核 |
| **排班系統 (Schedule)** | **schedule-48ff9** | 志工排班、出勤記錄、報表匯出 |

> 🔴<span style="color:red">若日後新增「統計 / 分析」模組，可再增設獨立 Firebase 專案，避免查詢與寫入互相影響。</span>

---

## 3. Firebase 四大服務說明

| Firebase 元件         | 用途     | 本專案使用方式                                          |
| ------------------- | ------ | ------------------------------------------------ |
| **Auth**            | 身分驗證   | 整合 LINE Login，登入後建立 / 更新 Firestore `users/{uid}` |
| **Firestore**       | 文件型資料庫 | 儲存 users、checkins、patrols、services、schedules     |
| **Cloud Functions** | 雲端執行邏輯 | 驗證 GPS 距離、審核神服申請、更新使用者角色                         |
| **Hosting**         | 靜態網站託管 | 可做為 Vercel 備援，或提供後台內部網址                          |


> 所有「只能由管理員操作」的行為，一律在 Cloud Functions 端完成，前端只發出請求、不直接改資料。

---

## 4. 資料流說明

```text
[User Browser]
    │ 1. LINE OAuth 2.0
    ▼
[Platform (platform-bc783)]
    │ 2. 產生 Firebase Custom Token
    ▼
[Firebase Auth]
    │ 3. 依角色分流
    ├──> Check-in 前端 (/checkin/)
    ├──> Service 前端 (/service/)
    └──> Schedule 前端 (/schedule/)
           │
           ▼
        [Firestore + Cloud Functions]
```
說明：
1. **登入階段** 一律走 platform 專案，確保登入與角色判斷在同一個環境。
2. **業務資料** 分別落在各自的專案（checkin / service / schedule），降低資料互相干擾的風險。
3. **管理端（/admin/）** 總是回到 platform，因為要橫跨三個模組。

## 5. 前端路徑與 Firebase 專案對應
這一段是前端最常問、也是剛剛你說「怎麼少了一個」的地方，這裡一次說清楚 👇

| **前端路徑**   | **所屬模組**       | **Firebase 專案**    | **部署建議**                     | **說明**                 |
| ---------- | -------------- | ------------------ | ---------------------------- | ---------------------- |
| /          | 平台層 (Platform) | **platform-bc783** | Vercel 主站 / Firebase Hosting | 登入首頁、公告、導流             |
| /checkin/  | 奉香簽到           | **checkin-29f7f**  | Vercel 子路徑或獨立專案              | GPS 簽到、巡邏點管理           |
| /service/  | 神服服務           | **service-b9d4a**  | Vercel 子路徑或獨立專案              | 點燈、法會報名、香油錢            |
| /schedule/ | 排班系統           | **schedule-48ff9** | Vercel 子路徑或獨立專案              | 志工班表、出勤記錄              |
| /admin/    | 管理後台           | **platform-bc783** | 僅限內部                         | superadmin / admin 控制台 |
備註：
/admin/ 一定要綁在 platform-bc783，因為它要能看 / 改「三個模組」的資料。

各模組前端可以是同一個 repo 下的不同子資料夾，也可以是三個獨立前端專案，視你們 R 社的開發習慣而定。

🔴<span style="color:red">若要走單頁應用 (SPA) 路徑重寫，請在 Vercel 或 Firebase Hosting 加上 rewrites 規則。</span>

## 6. 前端部署建議（Vercel / Firebase Hosting）
6.1 Vercel 多路徑部署範例

```json
{
  "rewrites": [
    { "source": "/checkin/:path*", "destination": "/checkin/index.html" },
    { "source": "/service/:path*", "destination": "/service/index.html" },
    { "source": "/schedule/:path*", "destination": "/schedule/index.html" },
    { "source": "/admin/:path*", "destination": "/admin/index.html" }
  ]
}
```
6.2 Firebase Hosting 備援部署
```bash

# 奉香簽到前端
firebase deploy --project checkin-29f7f --only hosting

# 神服服務前端
firebase deploy --project service-b9d4a --only hosting
```
🔴<span style="color:red"></span>請決定最終要以 Vercel 為主，還是要讓 Firebase Hosting 當災難備援（DR），兩者同時開要注意網域設定。

## **7. 安全與權限設計**

1. **身分驗證**
    - 透過 LINE → Firebase Auth，所有請求均須帶 Firebase ID Token。
2. **授權控管**
    - Cloud Functions 驗證角色權限，拒絕非管理者操作敏感資料。
3. **資料庫規則**
    - 禁止 client 端直接修改 users.role 或 services.status。
4. **最小權限原則**
    - 各 Firebase 專案僅開放對應人員；Platform 專案由 superadmin 全權管控。
5. **憑證管理**
    - 所有金鑰存放於 Secret Manager 或 GitHub Secrets，不應提交至任何 repo。

## 8. CI / CD 與環境
| **環境**         | **說明**                      | **例示**                      |
| -------------- | --------------------------- | --------------------------- |
| **local**      | 本機開發環境，使用 Firebase Emulator | firebase emulators:start    |
| **staging**    | 測試環境，對應測試 Firebase 專案       | 🔴填入 staging 網域             |
| **production** | 正式環境，對應四個正式專案               | https://go.guimashan.org.tw |
**部署策略**
- main → production
- develop → staging
- Functions 各模組獨立 deploy，避免互相覆蓋。
- Vercel 自動偵測分支並分配 preview domain。

## 9. 尚待補填項目
- 🔴最終版 LINE Login callback URL
- 🔴Vercel 專案 ID 與團隊名稱
- 🔴Cloud Functions 部署區域（建議 asia-east2）
- 🔴Firebase Hosting DNS 設定文件
- 🔴是否啟用 /admin/ 白名單限制
