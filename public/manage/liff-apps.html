<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <link rel="icon" type="image/png" href="/images/temple-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF æ‡‰ç”¨ç®¡ç† - é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/common.css">
    <style>
        .liff-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-gold-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: 4px;
        }

        .section-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--bg-cream);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-gold-dark));
            border-radius: 2px;
        }

        .liff-grid {
            display: grid;
            gap: 16px;
        }

        .liff-card {
            background: var(--bg-cream);
            border-radius: var(--radius-md);
            padding: 20px;
            transition: all var(--transition-base);
            border: 2px solid transparent;
        }

        .liff-card:hover {
            border-color: var(--primary-gold-light);
            box-shadow: var(--shadow-md);
        }

        .liff-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .liff-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .liff-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-used {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .status-unused {
            background: var(--color-warning-light);
            color: var(--color-warning);
        }

        .liff-info {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .liff-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }

        .liff-info-label {
            color: var(--text-secondary);
            min-width: 80px;
        }

        .liff-info-value {
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 0.8125rem;
            word-break: break-all;
        }

        .liff-keywords {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }

        .keywords-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .keyword-tag {
            display: inline-block;
            padding: 4px 10px;
            background: white;
            border: 1px solid var(--primary-gold-light);
            color: var(--primary-gold-dark);
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            font-weight: 500;
        }

        .liff-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-copy {
            flex: 1;
            padding: 8px 16px;
            background: white;
            color: var(--primary-gold);
            border: 2px solid var(--primary-gold);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all var(--transition-base);
        }

        .btn-copy:hover {
            background: var(--primary-gold-lighter);
        }

        .btn-edit-keywords {
            flex: 1;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-gold-dark));
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all var(--transition-base);
        }

        .btn-edit-keywords:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary-gold), var(--primary-gold-dark));
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: white;
            color: var(--primary-gold);
            border: 2px solid var(--primary-gold);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all var(--transition-base);
        }

        .btn-secondary:hover {
            background: var(--primary-gold-lighter);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-2xl);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
        }

        .form-hint {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .keyword-input-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .keyword-input-group input {
            flex: 1;
        }

        .btn-remove {
            padding: 8px 16px;
            background: var(--color-error-light);
            color: var(--color-error);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <div class="manage-layout">
        <header class="manage-header">
            <div class="manage-header-content">
                <div class="manage-header-left">
                    <h1>âš™ï¸ å…¨ç«™ç®¡ç†</h1>
                    <p>LIFF æ‡‰ç”¨ç®¡ç† - 24 å€‹æ‡‰ç”¨èˆ‡é—œéµå­—è¨­å®š</p>
                </div>
                <div class="manage-header-actions">
                    <button onclick="window.history.back()" class="manage-header-btn">å‰ä¸€é </button>
                    <button onclick="window.location.href='/'" class="manage-header-btn">å›é¦–é </button>
                    <button onclick="window.location.href='/manage/index.html'" class="manage-header-btn">ç™»å‡º</button>
                </div>
            </div>
        </header>
        
        <nav class="manage-subnav">
            <div class="manage-subnav-content">
                <a href="/manage/dashboard.html" class="manage-subnav-link">å„€è¡¨æ¿</a>
                <a href="/manage/user.html" class="manage-subnav-link">ç”¨æˆ¶ç¸½è¡¨</a>
                <a href="/manage/line-bot.html" class="manage-subnav-link">LINE Bot ç®¡ç†</a>
                <a href="/manage/liff-apps.html" class="manage-subnav-link active">LIFF æ‡‰ç”¨ç®¡ç†</a>
            </div>
        </nav>

        <main class="liff-container">
            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalApps">0</div>
                    <div class="stat-label">LIFF æ‡‰ç”¨ç¸½æ•¸</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="usedApps">0</div>
                    <div class="stat-label">å·²ç¶å®šé—œéµå­—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unusedApps">0</div>
                    <div class="stat-label">æœªä½¿ç”¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="weeklyUsage">0</div>
                    <div class="stat-label">æœ¬é€±ä½¿ç”¨æ¬¡æ•¸</div>
                </div>
            </div>

            <!-- é—œéµå­—æ—¥èªŒ -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">ğŸ“ é—œéµå­—æ—¥èªŒ</h2>
                    <button onclick="loadKeywordLogs()" class="btn-primary">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                </div>

                <div id="keywordLogsLoading" class="loading">è¼‰å…¥ä¸­...</div>
                <div id="keywordLogsContent" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th style="width: 15%">æ™‚é–“</th>
                                <th style="width: 20%">ç”¨æˆ¶</th>
                                <th style="width: 15%">é—œéµå­—</th>
                                <th style="width: 30%">LIFF æ‡‰ç”¨</th>
                                <th style="width: 10%">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="keywordLogsTableBody"></tbody>
                    </table>

                    <!-- åˆ†é æ§åˆ¶ -->
                    <div class="pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 16px; background: #f5f5f5; border-radius: 8px;">
                        <button id="keywordLogsPrevBtn" onclick="changeKeywordLogsPage(-1)" class="btn-secondary" disabled>â† ä¸Šä¸€é </button>
                        <span id="keywordLogsPageInfo" style="color: #555;">ç¬¬ 1 é </span>
                        <button id="keywordLogsNextBtn" onclick="changeKeywordLogsPage(1)" class="btn-secondary" disabled>ä¸‹ä¸€é  â†’</button>
                    </div>
                </div>
            </div>

            <!-- LIFF æ‡‰ç”¨åˆ—è¡¨ -->
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title">LIFF æ‡‰ç”¨åˆ—è¡¨</h2>
                    <button onclick="syncLiffApps()" class="btn-primary">ğŸ”„ åŒæ­¥ LIFF åˆ—è¡¨</button>
                </div>

                <div id="liffLoading" class="loading">è¼‰å…¥ä¸­...</div>
                <div id="liffGrid" class="liff-grid" style="display: none;"></div>
            </div>
        </main>
    </div>

    <!-- ç·¨è¼¯é—œéµå­— Modal -->
    <div id="keywordModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 class="modal-header">ç·¨è¼¯é—œéµå­—</h3>

            <div class="form-group">
                <label class="form-label">LIFF æ‡‰ç”¨åç¨±</label>
                <input type="text" id="modalLiffName" class="form-control" readonly style="background: #f5f5f5; color: #666;">
            </div>

            <div class="form-group">
                <label class="form-label">LIFF ID</label>
                <input type="text" id="modalLiffId" class="form-control" readonly style="background: #f5f5f5; color: #666;">
            </div>

            <div class="form-group">
                <label class="form-label">LIFF URL</label>
                <input type="text" id="modalLiffUrl" class="form-control" readonly style="background: #f5f5f5; color: #666; font-size: 12px;">
            </div>

            <div class="form-group">
                <label class="form-label">ä¸»é—œéµå­—</label>
                <input type="text" id="modalMainKeyword" class="form-control" placeholder="ä¾‹å¦‚ï¼šå¹´æ–—">
                <div class="form-hint">é€™æ˜¯ç”¨æˆ¶è¼¸å…¥çš„ä¸»è¦é—œéµå­—</div>
            </div>

            <div class="form-group">
                <label class="form-label">åˆ¥åï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
                <input type="text" id="modalAliases" class="form-control" placeholder="ä¾‹å¦‚ï¼šND,nd">
                <div class="form-hint">è¼¸å…¥å¤šå€‹åˆ¥åæ™‚ï¼Œè«‹ç”¨é€—è™Ÿåˆ†éš”</div>
            </div>

            <div class="form-group">
                <label class="form-label">ç‹€æ…‹</label>
                <select id="modalEnabled" class="form-control">
                    <option value="true">å•Ÿç”¨</option>
                    <option value="false">åœç”¨</option>
                </select>
            </div>

            <div class="modal-actions" style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="deleteKeywordSetting()" class="btn-secondary" style="margin-right: auto; background: #dc3545; color: white;">ğŸ—‘ï¸ åˆªé™¤é—œéµå­—</button>
                <button onclick="closeKeywordModal()" class="btn-secondary">å–æ¶ˆ</button>
                <button onclick="saveKeywordSetting()" class="btn-primary">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { platformAuth, platformDb } from '/js/firebase-init.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        let currentUser = null;
        let liffApps = [];
        let keywords = {};
        let currentEditingLiff = null;

        // LIFF æ‡‰ç”¨è³‡æ–™ï¼ˆå¾æ‚¨æä¾›çš„åˆ—è¡¨ï¼‰
        const LIFF_APPS_DATA = [
            { name: 'åŒä»æ’ç­', liffId: '2008269293-Y1akmZkJ' },
            { name: 'ç¥å‹™æœå‹™', liffId: '2008269293-o3rL8ZLz' },
            { name: 'ç°½åˆ°è¨˜éŒ„', liffId: '2008269293-Y9pEQkEL' },
            { name: 'æ’ç­ç®¡ç†', liffId: '2008269293-xjEnOwnj' },
            { name: 'æœ¬æœˆç­è¡¨', liffId: '2008269293-LrRMjAMP' },
            { name: 'æœ¬é€±ç­è¡¨', liffId: '2008269293-RPQ5xL5g' },
            { name: 'ç­è¡¨', liffId: '2008269293-4aLNk0NZ' },
            { name: 'å¿—å·¥æ’ç­', liffId: '2008269293-qJmPeWPp' },
            { name: 'ç¦ç”°æœƒ_ç¦ç”° Youth', liffId: '2008269293-XPgaLra8' },
            { name: 'ç¦ç”°æœƒ_ä¼æ¥­åœ˜é«”', liffId: '2008269293-LKR2Nr2x' },
            { name: 'ç¦ç”°æœƒ_ä¿¡çœ¾å€‹äºº', liffId: '2008269293-71e3y43M' },
            { name: 'ç¦ç”°æœƒ', liffId: '2008269293-qX36NQ6Z' },
            { name: 'æ·»é¦™æ²¹', liffId: '2008269293-08nodJoY' },
            { name: 'å»ºå®®å»Ÿæ¬¾', liffId: '2008269293-kP3wR7w2' },
            { name: 'ç§‹ç¥­æ³•æœƒ', liffId: '2008269293-jJAOXRON' },
            { name: 'æ™®æ–½æ³•æœƒ', liffId: '2008269293-JxweaMeq' },
            { name: 'ä¸­å…ƒæ³•æœƒ', liffId: '2008269293-nvWQDYQr' },
            { name: 'ç¦®æ–—æ³•æœƒ', liffId: '2008269293-npEKdxKa' },
            { name: 'å¹´æ–—æ³•æœƒ', liffId: '2008269293-xPnd6gdR' },
            { name: 'ç·šä¸Šé»ç‡ˆ', liffId: '2008269293-pam9Q09l' },
            { name: 'ç¥å‹™ç®¡ç†', liffId: '2008269293-R1objlb1' },
            { name: 'ç°½åˆ°ç®¡ç†', liffId: '2008269293-VGLP8oPw' },
            { name: 'å¥‰é¦™ç°½åˆ°', liffId: '2008269293-nYBm3JmV' },
            { name: 'æ’ç­ç³»çµ±', liffId: '2008269293-N0wnqknr' }
        ];

        // åˆå§‹åŒ–
        onAuthStateChanged(platformAuth, async (user) => {
            if (user) {
                currentUser = user;
                await checkPermission();
                await loadData();
            } else {
                window.location.href = '/';
            }
        });

        // æª¢æŸ¥æ¬Šé™
        async function checkPermission() {
            const userDoc = await getDoc(doc(platformDb, 'users', currentUser.uid));
            if (!userDoc.exists()) {
                alert('ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡æ–™');
                window.location.href = '/';
                return;
            }

            const userData = userDoc.data();
            const roles = userData.roles || [];
            const isAdmin = roles.some(role => 
                role === 'superadmin' || 
                role === 'admin' || 
                role.startsWith('admin_')
            );

            if (!isAdmin) {
                alert('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢');
                window.location.href = '/';
            }
        }

        // é—œéµå­—æ—¥èªŒç›¸é—œè®Šæ•¸
        let keywordLogs = [];
        let keywordLogsCurrentPage = 1;
        const LOGS_PER_PAGE = 10;

        // è¼‰å…¥è³‡æ–™
        async function loadData() {
            // è¼‰å…¥ LIFF æ‡‰ç”¨åˆ—è¡¨
            const liffDoc = await getDoc(doc(platformDb, 'line_bot_settings', 'liff_apps'));
            if (liffDoc.exists()) {
                liffApps = liffDoc.data().apps || [];
            } else {
                liffApps = LIFF_APPS_DATA;
                await setDoc(doc(platformDb, 'line_bot_settings', 'liff_apps'), { apps: liffApps });
            }

            // è¼‰å…¥é—œéµå­—è¨­å®š
            const keywordsDoc = await getDoc(doc(platformDb, 'line_bot_settings', 'keywords'));
            if (keywordsDoc.exists()) {
                keywords = keywordsDoc.data();
            } else {
                keywords = {};
            }

            renderLiffApps();
            updateStats();
            loadKeywordLogs();
        }

        // è¼‰å…¥é—œéµå­—æ—¥èªŒ
        window.loadKeywordLogs = async function() {
            document.getElementById('keywordLogsLoading').style.display = 'block';
            document.getElementById('keywordLogsContent').style.display = 'none';

            try {
                const { collection, query, orderBy, getDocs, limit } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                const logsRef = collection(platformDb, 'message_logs');
                // è¼‰å…¥æœ€è¿‘ 500 ç­†è¨˜éŒ„ä»¥æé«˜æ•ˆèƒ½ï¼Œé¡¯ç¤ºæ‰€æœ‰æ—¥èªŒï¼ˆåŒ…æ‹¬å¤±æ•—çš„ï¼‰
                const logsQuery = query(logsRef, orderBy('timestamp', 'desc'), limit(500));
                const logsSnapshot = await getDocs(logsQuery);

                // ä¸å†éæ¿¾ï¼Œé¡¯ç¤ºæ‰€æœ‰æ—¥èªŒè¨˜éŒ„
                keywordLogs = logsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                keywordLogsCurrentPage = 1;
                renderKeywordLogs();
                
                document.getElementById('keywordLogsLoading').style.display = 'none';
                document.getElementById('keywordLogsContent').style.display = 'block';
            } catch (error) {
                console.error('è¼‰å…¥é—œéµå­—æ—¥èªŒå¤±æ•—:', error);
                alert('è¼‰å…¥é—œéµå­—æ—¥èªŒå¤±æ•—');
            }
        }

        // æ¸²æŸ“é—œéµå­—æ—¥èªŒ
        function renderKeywordLogs() {
            const tbody = document.getElementById('keywordLogsTableBody');
            tbody.innerHTML = '';

            const startIndex = (keywordLogsCurrentPage - 1) * LOGS_PER_PAGE;
            const endIndex = startIndex + LOGS_PER_PAGE;
            const pageLogs = keywordLogs.slice(startIndex, endIndex);

            if (pageLogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">æš«ç„¡æ—¥èªŒè¨˜éŒ„</td></tr>';
                return;
            }

            pageLogs.forEach(log => {
                const timestamp = log.timestamp?.toDate ? log.timestamp.toDate() : new Date(log.timestamp);
                const timeStr = timestamp.toLocaleString('zh-TW', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // åˆ¤æ–·ç‹€æ…‹ï¼ˆå„ªå…ˆä½¿ç”¨ status æ¬„ä½ï¼‰
                let statusBadge = '';
                const status = log.status || 'unknown';
                
                if (status === 'success') {
                    statusBadge = '<span class="status-badge status-success">âœ“ å·²å›è¦†</span>';
                } else if (status === 'error') {
                    statusBadge = '<span class="status-badge status-error">âœ— å›è¦†å¤±æ•—</span>';
                } else if (status === 'ignored') {
                    statusBadge = '<span class="status-badge status-warning">âŠ˜ å·²å¿½ç•¥</span>';
                } else if (log.matchedKeyword) {
                    statusBadge = '<span class="status-badge status-warning">âš  éƒ¨åˆ†åŒ¹é…</span>';
                } else {
                    statusBadge = '<span class="status-badge status-error">âœ— æœªåŒ¹é…</span>';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${log.displayName || log.userId || 'æœªçŸ¥ç”¨æˆ¶'}</td>
                    <td><span class="keyword-tag">${log.matchedKeyword || '-'}</span></td>
                    <td>${log.liffApp || '-'}</td>
                    <td>${statusBadge}</td>
                `;
                tbody.appendChild(row);
            });

            // æ›´æ–°åˆ†é è³‡è¨Š
            const totalPages = Math.ceil(keywordLogs.length / LOGS_PER_PAGE);
            document.getElementById('keywordLogsPageInfo').textContent = `ç¬¬ ${keywordLogsCurrentPage} / ${totalPages} é  (å…± ${keywordLogs.length} ç­†)`;
            
            document.getElementById('keywordLogsPrevBtn').disabled = keywordLogsCurrentPage === 1;
            document.getElementById('keywordLogsNextBtn').disabled = keywordLogsCurrentPage >= totalPages;
        }

        // åˆ‡æ›é—œéµå­—æ—¥èªŒé é¢
        window.changeKeywordLogsPage = function(delta) {
            keywordLogsCurrentPage += delta;
            renderKeywordLogs();
        }

        // æ¸²æŸ“ LIFF æ‡‰ç”¨
        function renderLiffApps() {
            const grid = document.getElementById('liffGrid');
            grid.innerHTML = '';

            liffApps.forEach(app => {
                // æ‰¾å‡ºä½¿ç”¨æ­¤ LIFF çš„é—œéµå­—
                const usedKeywords = Object.values(keywords)
                    .filter(kw => kw.liffId === app.liffId)
                    .flatMap(kw => [kw.keyword, ...(kw.aliases || [])]);

                const isUsed = usedKeywords.length > 0;
                const liffUrl = `https://liff.line.me/${app.liffId}`;

                const card = document.createElement('div');
                card.className = 'liff-card';
                card.innerHTML = `
                    <div class="liff-header">
                        <div class="liff-name">${app.name}</div>
                        <span class="liff-status ${isUsed ? 'status-used' : 'status-unused'}">
                            ${isUsed ? 'âœ“ å·²ç¶å®š' : 'æœªä½¿ç”¨'}
                        </span>
                    </div>
                    <div class="liff-info">
                        <div class="liff-info-item">
                            <span class="liff-info-label">LIFF ID:</span>
                            <span class="liff-info-value">${app.liffId}</span>
                        </div>
                        <div class="liff-info-item">
                            <span class="liff-info-label">LIFF URL:</span>
                            <span class="liff-info-value">${liffUrl}</span>
                        </div>
                    </div>
                    ${isUsed ? `
                        <div class="liff-keywords">
                            <div class="keywords-label">ç¶å®šçš„é—œéµå­—ï¼š</div>
                            <div class="keyword-list">
                                ${usedKeywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div class="liff-actions">
                        <button class="btn-copy" onclick="copyLiffUrl('${liffUrl}')">ğŸ“‹ è¤‡è£½ URL</button>
                        <button class="btn-edit-keywords" onclick="editLiffKeywords('${app.liffId}')">âœï¸ ç·¨è¼¯é—œéµå­—</button>
                    </div>
                `;
                grid.appendChild(card);
            });

            document.getElementById('liffLoading').style.display = 'none';
            document.getElementById('liffGrid').style.display = 'grid';
        }

        // æ›´æ–°çµ±è¨ˆ
        async function updateStats() {
            const usedLiffs = new Set(Object.values(keywords).map(kw => kw.liffId));
            
            // è¨ˆç®—æœ¬é€±ä½¿ç”¨æ¬¡æ•¸ï¼ˆå°ç£æ™‚é–“ UTC+8ï¼‰
            let weeklyUsage = 0;
            try {
                const { collection, query, where, getDocs, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
                
                // ç²å–ç•¶å‰ UTC æ™‚é–“
                const nowUtc = new Date();
                const nowUtcMs = nowUtc.getTime();
                
                // è¨ˆç®—å°ç£æ™‚é–“çš„æœ¬é€±é–‹å§‹ï¼ˆé€±æ—¥ 00:00:00ï¼‰
                // å°ç£æ™‚é–“ = UTC + 8å°æ™‚ = UTC + 28800000ms
                const taiwanOffset = 8 * 60 * 60 * 1000;
                const nowTaiwanMs = nowUtcMs + taiwanOffset;
                
                // ä½¿ç”¨ UTC æ–¹æ³•è¨ˆç®—å°ç£æ™‚é–“çš„é€±æ—¥
                const nowTaiwanDate = new Date(nowTaiwanMs);
                const taiwanDayOfWeek = nowTaiwanDate.getUTCDay();
                const taiwanHours = nowTaiwanDate.getUTCHours();
                const taiwanMinutes = nowTaiwanDate.getUTCMinutes();
                const taiwanSeconds = nowTaiwanDate.getUTCSeconds();
                const taiwanMillis = nowTaiwanDate.getUTCMilliseconds();
                
                // è¨ˆç®—åˆ°æœ¬é€±æ—¥ 00:00:00 çš„åç§»ï¼ˆä»¥å°ç£æ™‚é–“è¨ˆç®—ï¼‰
                const msToWeekStart = taiwanDayOfWeek * 24 * 60 * 60 * 1000 +
                                     taiwanHours * 60 * 60 * 1000 +
                                     taiwanMinutes * 60 * 1000 +
                                     taiwanSeconds * 1000 +
                                     taiwanMillis;
                
                // é€±é–‹å§‹çš„å°ç£æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰
                const weekStartTaiwanMs = nowTaiwanMs - msToWeekStart;
                
                // è½‰æ›å› UTC æ™‚é–“
                const weekStartUtcMs = weekStartTaiwanMs - taiwanOffset;
                const weekStartTimestamp = Timestamp.fromMillis(weekStartUtcMs);
                
                const logsRef = collection(platformDb, 'message_logs');
                const weekQuery = query(logsRef, where('timestamp', '>=', weekStartTimestamp));
                const logsSnapshot = await getDocs(weekQuery);
                
                // åªè¨ˆç®—æœ‰ liffApp çš„è¨˜éŒ„
                weeklyUsage = logsSnapshot.docs.filter(doc => doc.data().liffApp).length;
            } catch (error) {
                console.error('è¨ˆç®—æœ¬é€±ä½¿ç”¨æ¬¡æ•¸å¤±æ•—:', error);
            }

            document.getElementById('totalApps').textContent = liffApps.length;
            document.getElementById('usedApps').textContent = usedLiffs.size;
            document.getElementById('unusedApps').textContent = liffApps.length - usedLiffs.size;
            document.getElementById('weeklyUsage').textContent = weeklyUsage;
        }

        // è¤‡è£½ LIFF URL
        window.copyLiffUrl = function(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('âœ“ LIFF URL å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            });
        }

        // ç·¨è¼¯ LIFF é—œéµå­—
        window.editLiffKeywords = function(liffId) {
            currentEditingLiff = liffApps.find(app => app.liffId === liffId);
            if (!currentEditingLiff) return;

            const liffUrl = `https://liff.line.me/${liffId}`;
            document.getElementById('modalLiffName').value = currentEditingLiff.name;
            document.getElementById('modalLiffId').value = liffId;
            document.getElementById('modalLiffUrl').value = liffUrl;

            // æ‰¾å‡ºä½¿ç”¨æ­¤ LIFF çš„é—œéµå­—è¨­å®š
            const keywordSetting = Object.values(keywords).find(kw => kw.liffId === liffId);
            
            if (keywordSetting) {
                document.getElementById('modalMainKeyword').value = keywordSetting.keyword || '';
                document.getElementById('modalAliases').value = (keywordSetting.aliases || []).join(',');
                document.getElementById('modalEnabled').value = keywordSetting.enabled !== false ? 'true' : 'false';
            } else {
                document.getElementById('modalMainKeyword').value = '';
                document.getElementById('modalAliases').value = '';
                document.getElementById('modalEnabled').value = 'true';
            }

            document.getElementById('keywordModal').classList.add('active');
        }

        // å„²å­˜é—œéµå­—è¨­å®š
        window.saveKeywordSetting = async function() {
            if (!currentEditingLiff) return;

            const mainKeyword = document.getElementById('modalMainKeyword').value.trim();
            const aliasesInput = document.getElementById('modalAliases').value.trim();
            const enabled = document.getElementById('modalEnabled').value === 'true';

            if (!mainKeyword) {
                alert('è«‹è¼¸å…¥ä¸»é—œéµå­—');
                return;
            }

            // è™•ç†åˆ¥å
            const aliases = aliasesInput
                .split(',')
                .map(a => a.trim())
                .filter(a => a);

            // æ‰¾åˆ°ç¾æœ‰è¨­å®šä»¥ä¿ç•™ reply ç›¸é—œæ¬„ä½
            const existingKeyword = Object.values(keywords).find(kw => kw.liffId === currentEditingLiff.liffId);
            
            // å…ˆç§»é™¤æ­¤ LIFF çš„èˆŠè¨­å®š
            Object.keys(keywords).forEach(key => {
                if (keywords[key].liffId === currentEditingLiff.liffId) {
                    delete keywords[key];
                }
            });

            // æ–°å¢æˆ–æ›´æ–°é—œéµå­—è¨­å®šï¼ˆä¿ç•™ç¾æœ‰çš„ reply è¨­å®šï¼‰
            keywords[mainKeyword] = {
                keyword: mainKeyword,
                aliases: aliases,
                liffId: currentEditingLiff.liffId,
                replyMessage: existingKeyword?.replyMessage || `è«‹ä½¿ç”¨ ${currentEditingLiff.name}`,
                buttonText: existingKeyword?.buttonText || 'é–‹å§‹ä½¿ç”¨',
                enabled: enabled,
                updatedAt: new Date().toISOString()
            };

            await setDoc(doc(platformDb, 'line_bot_settings', 'keywords'), keywords);
            await loadData();
            closeKeywordModal();
            alert('âœ“ é—œéµå­—è¨­å®šå·²å„²å­˜');
        }

        // åˆªé™¤é—œéµå­—è¨­å®š
        window.deleteKeywordSetting = async function() {
            if (!currentEditingLiff) return;

            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ LIFF æ‡‰ç”¨çš„é—œéµå­—è¨­å®šå—ï¼Ÿ')) return;

            // ç§»é™¤æ­¤ LIFF çš„æ‰€æœ‰é—œéµå­—è¨­å®š
            Object.keys(keywords).forEach(key => {
                if (keywords[key].liffId === currentEditingLiff.liffId) {
                    delete keywords[key];
                }
            });

            await setDoc(doc(platformDb, 'line_bot_settings', 'keywords'), keywords);
            await loadData();
            closeKeywordModal();
            alert('âœ“ é—œéµå­—è¨­å®šå·²åˆªé™¤');
        }

        // é—œé–‰ Modal
        window.closeKeywordModal = function() {
            document.getElementById('keywordModal').classList.remove('active');
            currentEditingLiff = null;
        }

        // åŒæ­¥ LIFF åˆ—è¡¨
        window.syncLiffApps = async function() {
            if (!confirm('ç¢ºå®šè¦é‡æ–°åŒæ­¥ LIFF åˆ—è¡¨å—ï¼Ÿé€™æœƒæ›´æ–°è³‡æ–™åº«ä¸­çš„ LIFF æ‡‰ç”¨è³‡æ–™ã€‚')) return;

            liffApps = LIFF_APPS_DATA;
            await setDoc(doc(platformDb, 'line_bot_settings', 'liff_apps'), { apps: liffApps });
            await loadData();
            alert('LIFF åˆ—è¡¨å·²åŒæ­¥');
        }
    </script>
</body>
</html>
