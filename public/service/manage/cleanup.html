<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…ç†èˆŠè¨‚å–® - ç¥å‹™æœå‹™ç®¡ç†</title>
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .cleanup-container {
            max-width: 900px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .warning-box h3 {
            color: #856404;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .warning-box ul {
            margin: 10px 0;
            padding-left: 30px;
            color: #856404;
        }
        
        .warning-box li {
            margin: 8px 0;
        }
        
        .valid-types {
            background: #d4edda;
            border-left: 5px solid #28a745;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .valid-types h3 {
            color: #155724;
            margin-top: 0;
        }
        
        .valid-types .type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .type-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            color: #155724;
        }
        
        .type-code {
            font-weight: bold;
            color: #28a745;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-cleanup {
            background: #dc3545;
            color: white;
        }
        
        .btn-cleanup:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .btn-back {
            background: #6c757d;
            color: white;
        }
        
        .btn-back:hover {
            background: #5a6268;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-box {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .result-box.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result-box.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result-details {
            margin-top: 15px;
            padding: 20px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 30px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-text {
            color: #667eea;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="cleanup-container" style="display: none;">
        <h1>ğŸ—‘ï¸ æ¸…ç†èˆŠæ ¼å¼è¨‚å–®</h1>
        
        <div class="warning-box">
            <h3>âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯é€†</h3>
            <p><strong>æ­¤åŠŸèƒ½å°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰ä¸ç¬¦åˆæ¨™æº–æ ¼å¼çš„è¨‚å–®è³‡æ–™ï¼š</strong></p>
            <ul>
                <li>æ‰€æœ‰ serviceType ä¸åœ¨ä¸‹æ–¹ã€Œæ¨™æº–æ ¼å¼ã€åˆ—è¡¨ä¸­çš„è¨‚å–®å°‡è¢«åˆªé™¤</li>
                <li>åŒ…å«èˆŠçš„æ‹¼éŸ³æ ¼å¼ï¼ˆå¦‚ xiangyou, lidou ç­‰ï¼‰çš„è¨‚å–®</li>
                <li>åˆªé™¤å¾Œ<strong>ç„¡æ³•å¾©åŸ</strong></li>
                <li>å»ºè­°å…ˆåœ¨ Firebase Console ç¢ºèªé€™äº›æ˜¯æ¸¬è©¦è³‡æ–™</li>
            </ul>
        </div>
        
        <div class="valid-types">
            <h3>âœ… æ¨™æº–æ ¼å¼ï¼ˆå°‡ä¿ç•™ï¼‰</h3>
            <div class="type-grid">
                <div class="type-item"><span class="type-code">dd</span> - é¾œé¦¬å±±ä¸€é»éˆ</div>
                <div class="type-item"><span class="type-code">nd</span> - å¹´æ–—æ³•æœƒ</div>
                <div class="type-item"><span class="type-code">ld</span> - ç¦®æ–—æ³•æœƒ</div>
                <div class="type-item"><span class="type-code">zy</span> - ä¸­å…ƒæ³•æœƒ</div>
                <div class="type-item"><span class="type-code">ps</span> - æ™®æ–½æ³•æœƒ</div>
                <div class="type-item"><span class="type-code">qj</span> - ç§‹ç¥­æ³•æœƒ</div>
                <div class="type-item"><span class="type-code">bg</span> - å»ºå®®å»Ÿæ¬¾</div>
                <div class="type-item"><span class="type-code">xy</span> - æ·»é¦™æ²¹</div>
                <div class="type-item"><span class="type-code">ftp</span> - ç¦ç”°_ä¿¡çœ¾å€‹äºº</div>
                <div class="type-item"><span class="type-code">ftc</span> - ç¦ç”°_ä¼æ¥­åœ˜é«”</div>
                <div class="type-item"><span class="type-code">fty</span> - ç¦ç”°_Youth æœƒ</div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="backBtn" class="btn btn-back">â† è¿”å›å„€è¡¨æ¿</button>
            <button id="cleanupBtn" class="btn btn-cleanup">åŸ·è¡Œæ¸…ç†</button>
        </div>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p class="progress-text">æ­£åœ¨æ¸…ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
        
        <div id="resultBox" class="result-box">
            <h3 id="resultTitle"></h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script type="module">
        import { checkAdminAuth } from '/js/auth-guard.js';
        import { serviceFunctions } from '/js/firebase-init.js';
        import { httpsCallable } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js';

        let currentUser = null;

        // è¿”å›æŒ‰éˆ•äº‹ä»¶ï¼ˆä¸éœ€è¦æ¬Šé™å³å¯è¿”å›ï¼‰
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = '/service/manage/dashboard.html';
        });

        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ï¼ˆåªå…è¨± superadmin å’Œ admin_serviceï¼‰
        checkAdminAuth(['superadmin', 'admin_service']).then((result) => {
            console.log('âœ… ç³»çµ±ç¶­è­· æ¬Šé™é©—è­‰æˆåŠŸ:', result.roles);
            
            // ç¢ºèªç”¨æˆ¶å’Œè§’è‰²éƒ½å­˜åœ¨
            if (!result.user || !result.roles || result.roles.length === 0) {
                throw new Error('ç”¨æˆ¶è³‡è¨Šä¸å®Œæ•´');
            }
            
            // ç¢ºèªèªè­‰ç‹€æ…‹
            if (!result.authenticated) {
                throw new Error('èªè­‰å¤±æ•—');
            }
            
            currentUser = result.user;
            
            // é¡¯ç¤ºé é¢å…§å®¹
            document.querySelector('.cleanup-container').style.display = 'block';
            
            // æ¬Šé™é©—è­‰æˆåŠŸå¾Œæ‰ç¶å®šæ¸…ç†æŒ‰éˆ•äº‹ä»¶
            setupCleanupHandler();
        }).catch((error) => {
            console.error('âŒ æ¬Šé™é©—è­‰å¤±æ•—:', error);
            alert('â›” æ¬Šé™ä¸è¶³\n\nç³»çµ±ç¶­è­·åŠŸèƒ½åƒ…é™ superadmin å’Œ admin_service è§’è‰²ä½¿ç”¨ã€‚\n\nå¦‚éœ€å”åŠ©ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡ã€‚');
            window.location.href = '/service/manage/dashboard.html';
        });

        // æ¸…ç†è™•ç†å‡½æ•¸ï¼ˆåªåœ¨æ¬Šé™é©—è­‰æˆåŠŸå¾Œèª¿ç”¨ï¼‰
        function setupCleanupHandler() {
            document.getElementById('cleanupBtn').addEventListener('click', async () => {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }

            if (!confirm('âš ï¸ ç¢ºå®šè¦åŸ·è¡Œæ¸…ç†å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰èˆŠæ ¼å¼çš„è¨‚å–®è³‡æ–™ï¼Œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            if (!confirm('ğŸ”´ æœ€å¾Œç¢ºèªï¼š\n\né€™å°‡åˆªé™¤æ‰€æœ‰ serviceType ä¸æ˜¯æ¨™æº–ç¸®å¯«çš„è¨‚å–®ã€‚\n\nç¢ºå®šç¹¼çºŒå—ï¼Ÿ')) {
                return;
            }

            const cleanupBtn = document.getElementById('cleanupBtn');
            const loading = document.getElementById('loading');
            const resultBox = document.getElementById('resultBox');
            
            cleanupBtn.disabled = true;
            loading.style.display = 'block';
            resultBox.style.display = 'none';

            try {
                console.log('ğŸ” é–‹å§‹æ¸…ç†èˆŠè¨‚å–®...');
                
                // ä½¿ç”¨ Firebase Callable Functionï¼ˆè‡ªå‹•è™•ç† CORS å’Œèªè­‰ï¼‰
                const cleanupOldOrders = httpsCallable(serviceFunctions, 'cleanupOldOrders');
                
                // èª¿ç”¨å‡½æ•¸ï¼ˆFirebase SDK æœƒè‡ªå‹•æ·»åŠ èªè­‰ tokenï¼‰
                const result = await cleanupOldOrders();
                
                const summary = result.data.summary;
                const deletedOrders = result.data.deletedDetails || [];
                
                // é¡¯ç¤ºæˆåŠŸçµæœ
                resultBox.className = 'result-box success';
                resultBox.style.display = 'block';
                document.getElementById('resultTitle').textContent = 'âœ… æ¸…ç†å®Œæˆï¼';
                
                let content = `
                    <div class="result-details">
                        <strong>æ¸…ç†æ‘˜è¦ï¼š</strong><br>
                        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>
                        ç¸½è¨‚å–®æ•¸ï¼š${summary.totalOrders} ç­†<br>
                        âœ… ä¿ç•™è¨‚å–®ï¼š${summary.validOrders} ç­†<br>
                        âŒ åˆªé™¤è¨‚å–®ï¼š${summary.deletedOrders} ç­†<br>
                        <br>
                        <strong>ç™¼ç¾çš„èˆŠæ ¼å¼ serviceTypeï¼š</strong><br>
                        ${summary.oldServiceTypes && summary.oldServiceTypes.length > 0 
                            ? summary.oldServiceTypes.map(t => `  â€¢ ${t}`).join('<br>') 
                            : '  ç„¡'}
                `;
                
                if (deletedOrders.length > 0) {
                    content += `<br><br><strong>å·²åˆªé™¤çš„è¨‚å–®æ˜ç´°ï¼š</strong><br>`;
                    deletedOrders.forEach(order => {
                        content += `  â€¢ ${order.orderId} (${order.serviceType})<br>`;
                    });
                }
                
                content += `<br>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</div>`;
                
                document.getElementById('resultContent').innerHTML = content;
                
                console.log('âœ… æ¸…ç†æˆåŠŸå®Œæˆ:', summary);

            } catch (error) {
                console.error('æ¸…ç†å¤±æ•—:', error);
                
                let errorMessage = error.message || 'æœªçŸ¥éŒ¯èª¤';
                
                // Firebase Functions éŒ¯èª¤ä»£ç¢¼è™•ç†
                if (error.code === 'unauthenticated') {
                    errorMessage = 'è«‹å…ˆç™»å…¥';
                } else if (error.code === 'permission-denied') {
                    errorMessage = 'æ‚¨æ²’æœ‰åŸ·è¡Œæ­¤æ“ä½œçš„æ¬Šé™ï¼ˆåƒ…é™ superadmin å’Œ admin_serviceï¼‰';
                } else if (error.code === 'not-found') {
                    errorMessage = 'æ‰¾ä¸åˆ°ä½¿ç”¨è€…è³‡æ–™';
                }
                
                resultBox.className = 'result-box error';
                resultBox.style.display = 'block';
                document.getElementById('resultTitle').textContent = 'âŒ æ¸…ç†å¤±æ•—';
                document.getElementById('resultContent').innerHTML = `
                    <div class="result-details">
                        <strong>éŒ¯èª¤è¨Šæ¯ï¼š</strong><br>
                        ${errorMessage}<br>
                        <br>
                        è«‹æª¢æŸ¥ï¼š<br>
                        â€¢ æ˜¯å¦æœ‰ç®¡ç†å“¡æ¬Šé™<br>
                        â€¢ ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸<br>
                        â€¢ Firebase æœå‹™æ˜¯å¦æ­£å¸¸
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
                cleanupBtn.disabled = false;
            }
            });
        }
    </script>
</body>
</html>
