<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·»é¦™æ²¹ - é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/common.css">
    </head>
<body>
    <!-- æœªç™»å…¥ç•«é¢ (é è¨­é¡¯ç¤º) -->
    <div id="loginPrompt" class="login-prompt">
        <div class="welcome-card">
            <h2>æ­¡è¿</h2>
            <p style="color: #6B5D4F; margin-bottom: 2rem;">è«‹ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥ç³»çµ±</p>
            <button id="loginBtn" class="btn btn-primary">
                LINE ç™»å…¥
            </button>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ (é è¨­éš±è—ï¼Œç™»å…¥å¾Œæ‰é¡¯ç¤º) -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-left">
                <h1>æ·»é¦™æ²¹</h1>
                <p>ç™¼é¡˜æ·»é¦™æ²¹ï¼ŒåŠŸå¾·ç„¡é‡</p>
            </div>
            <div class="header-actions">
                <button class="btn-logout" onclick="window.location.href='/'">
                    è¿”å›é¦–é 
                </button>
            </div>
        </header>

        <div class="container">
            <div class="main-content" style="max-width: 800px; margin: 0 auto; padding: 20px;">
            
            <!-- I. å ±åè¯çµ¡è³‡è¨Š -->
            <div class="card">
                <h2 class="card-title">å ±åè¯çµ¡è³‡è¨Š</h2>
                <div class="form-group">
                    <label for="contactName">å ±åå§“å (ä¸»è¦è¯çµ¡äºº)</label>
                    <input type="text" id="contactName" class="input-field" placeholder="è«‹è¼¸å…¥å§“å">
                </div>
                
                <div class="form-group">
                    <label for="contactPhone">é€£çµ¡é›»è©±</label>
                    <input type="tel" id="contactPhone" class="input-field" placeholder="è«‹è¼¸å…¥é›»è©±">
                </div>
                
                <div class="form-group">
                    <label for="contactEmail">é›»å­ä¿¡ç®±</label>
                    <input type="email" id="contactEmail" class="input-field" placeholder="è«‹è¼¸å…¥ Email">
                </div>
                
                <div class="form-group">
                    <label>æ„Ÿè¬ç‹€é ˜å–</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" id="receiptSend" name="receiptOption" value="send" checked>
                            <span>å¯„ç™¼æ„Ÿè¬ç‹€</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" id="receiptSelf" name="receiptOption" value="self">
                            <span>è¦ªè‡ªé ˜å–</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contactAddress">é€šè¨Šåœ°å€</label>
                    <input type="text" id="contactAddress" class="input-field" placeholder="è«‹è¼¸å…¥æ„Ÿè¬ç‹€å¯„é€åœ°å€">
                </div>
            </div>

            <!-- II. å ±ååå–® -->
            <div class="card">
                <h2 class="card-title">å ±ååå–®</h2>
                
                <div class="form-group">
                    <label>å ±åå°è±¡</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" id="modeSingle" name="mode" value="single" checked>
                            <span>å€‹äººå ±å</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" id="modeMulti" name="mode" value="multi">
                            <span>å¤šäººå ±å</span>
                        </label>
                    </div>
                </div>

                <div id="applicantCardList"></div>

                <button id="addApplicantBtn" class="btn-secondary" style="display: none; margin-top: 15px;">
                    æ–°å¢å ±åè€…
                </button>
            </div>

            <!-- III. ä¿¡ç”¨å¡è³‡è¨Š -->
            <div class="card payment-card">
                <h2 class="card-title">ä¿¡ç”¨å¡è³‡è¨Š (æ‰‹å‹•åˆ·å¡ç”¨)</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                    è«‹å¡«å¯«ä¿¡ç”¨å¡è³‡è¨Šï¼Œå»Ÿæ–¹å°‡èˆ‡æ‚¨è¯çµ¡ç¢ºèªå¾Œæ‰‹å‹•åˆ·å¡
                </p>
                
                <div class="form-group">
                    <label for="cardHolderName">æŒå¡äººå§“å</label>
                    <input type="text" id="cardHolderName" class="input-field">
                </div>
                
                <div class="form-group">
                    <label for="cardNumber">ä¿¡ç”¨å¡å¡è™Ÿ</label>
                    <input type="text" id="cardNumber" class="input-field" placeholder="xxxx-xxxx-xxxx-xxxx">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cardExpiry">æœ‰æ•ˆå¹´æœˆ (MM/YY)</label>
                        <input type="text" id="cardExpiry" class="input-field" placeholder="MM/YY">
                    </div>
                    
                    <div class="form-group">
                        <label for="cardCVV">èƒŒé¢æœ«ä¸‰ç¢¼ (CVV)</label>
                        <input type="text" id="cardCVV" class="input-field" placeholder="CVV">
                    </div>
                </div>
            </div>

            <!-- å…¶ä»–å‚™è¨» -->
            <div class="card">
                <h2 class="card-title">å…¶ä»–å‚™è¨»</h2>
                <div class="form-group">
                    <textarea id="otherNote" class="input-field" rows="4" placeholder="è‹¥æœ‰å…¶ä»–éœ€æ±‚è«‹å¡«å¯«æ–¼æ­¤"></textarea>
                </div>
            </div>

            </div>
        </div>

        <!-- æµ®å‹•ç¸½çµæ¬„ä½ -->
        <div id="floatingFooter">
        <div class="footer-content">
            <div class="footer-summary">
                <div class="summary-item">
                    <span class="summary-label">æ‡‰ç¹³ç¸½é‡‘é¡ï¼š</span>
                    <span id="totalAmount" class="summary-value total-price">NT$ 0</span>
                </div>
            </div>
            <button id="submitBtn" class="btn-submit">ç¢ºèªå ±åä¸¦é€å‡º</button>
        </div>
    </div>
    </div> <!-- é—œé–‰ mainApp -->

    <script type="module">
        // å°å…¥çµ±ä¸€çš„ç™»å…¥è™•ç†å‡½æ•¸
        import { handleLineLogin } from '/js/auth.js';
        
        // Firebase å»¶é²è¼‰å…¥ - åªåœ¨éœ€è¦æ™‚æ‰è¼‰å…¥
        let loginBtnBound = false;
        let moduleLoaded = false;
        async function loadModule() {
                await module.init();
        // ç¶å®šç™»å…¥æŒ‰éˆ• - é˜²é‡è¤‡ç¶å®š
        const loginBtn = document.getElementById('loginBtn');
        if (loginBtn && !loginBtnBound) {
            loginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                console.log('ğŸ” [XY.html] è§¸ç™¼ç™»å…¥');
                await handleLineLogin();
            });
            loginBtnBound = true;
        }

        // æª¢æŸ¥æ˜¯å¦æ‡‰è©²è‡ªå‹•è¼‰å…¥ï¼ˆç”¨æˆ¶å¯èƒ½æ˜¯å¾ LINE ç™»å…¥è¿”å›ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const hasAuthParams = urlParams.has('code') || urlParams.has('state');
        const hasReturnUrl = sessionStorage.getItem('line_login_return_url');
        const fromLine = document.referrer.includes('line.me');

        if (hasAuthParams || hasReturnUrl || fromLine) {
            // ç”¨æˆ¶å¯èƒ½å·²ç™»å…¥æˆ–æ­£åœ¨ç™»å…¥æµç¨‹ä¸­ï¼Œè¼‰å…¥æ¨¡çµ„æª¢æŸ¥ç‹€æ…‹
            loadModule();
        }
    </script>
</body>
</html>
