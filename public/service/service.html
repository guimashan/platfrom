<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>神務服務 - 龜馬山整合服務平台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/common.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <h1>神務服務</h1>
                <p class="subtitle">選擇您需要的服務項目</p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn-logout" onclick="window.location.href='/service/history.html'" style="background: #8A2BE2;">我的報名記錄</button>
                <button class="btn-logout" onclick="window.location.href='/'">返回首頁</button>
            </div>
        </header>

        <main class="main-content">
            <div class="module-grid active">
                <div class="module-card" onclick="checkServiceStatus('dd', 'DD.html')">
                    <div class="module-icon">🕯️</div>
                    <div class="module-title">龜馬山一點靈</div>
                    <div class="module-desc">祈福點燈，光明祈願</div>
                </div>
                
                <div class="module-card" onclick="checkServiceStatus('nd', 'ND.html')">
                    <div class="module-icon">🎊</div>
                    <div class="module-title">年斗法會</div>
                    <div class="module-desc">新春祈福，闔家平安</div>
                </div>
                
                <div class="module-card" onclick="checkServiceStatus('ld', 'LD.html')">
                    <div class="module-icon">⭐</div>
                    <div class="module-title">禮斗法會</div>
                    <div class="module-desc">禮拜星斗，消災延壽</div>
                </div>
                
                <div class="module-card" onclick="checkServiceStatus('zy', 'ZY.html')">
                    <div class="module-icon">🏮</div>
                    <div class="module-title">中元法會</div>
                    <div class="module-desc">普渡眾生，超薦先靈</div>
                </div>
                
                <div class="module-card" onclick="checkServiceStatus('ps', 'PS.html')">
                    <div class="module-icon">🙏</div>
                    <div class="module-title">普施法會</div>
                    <div class="module-desc">慈悲布施，廣結善緣</div>
                </div>
                
                <div class="module-card" onclick="checkServiceStatus('qj', 'QJ.html')">
                    <div class="module-icon">🍂</div>
                    <div class="module-title">秋祭法會</div>
                    <div class="module-desc">秋季祭典，感恩祈福</div>
                </div>
            </div>
        </main>

        <div class="bottom-nav">
            <div class="bottom-nav-items">
                <a href="/" class="bottom-nav-item">
                    <span class="icon">🏠</span>
                    <span>首頁</span>
                </a>
                <a href="/checkin/checkin.html" class="bottom-nav-item">
                    <span class="icon"><img src="/images/temple-icon.png" alt="簽到" style="width: 24px; height: 24px;"></span>
                    <span>簽到</span>
                </a>
                <a href="/service/history.html" class="bottom-nav-item">
                    <span class="icon">📋</span>
                    <span>報名記錄</span>
                </a>
                <a href="/manage/index.html" class="bottom-nav-item">
                    <span class="icon">🔔</span>
                    <span>通知中心</span>
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        console.log('✅ 神務服務頁面已載入');
        
        let serviceConfigs = {};
        const SERVICE_API_BASE = 'https://asia-east2-service-b9d4a.cloudfunctions.net';
        
        async function loadServiceConfigs() {
            try {
                const response = await fetch(`${SERVICE_API_BASE}/getServiceConfigs`);
                const result = await response.json();
                
                if (response.ok) {
                    serviceConfigs = result.result;
                    console.log('✅ 服務配置已載入', serviceConfigs);
                } else {
                    console.error('載入服務配置失敗:', result);
                }
            } catch (error) {
                console.error('載入服務配置失敗:', error);
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }
        
        function showServiceClosedNotification(config) {
            // 創建遮罩層
            const overlay = document.createElement('div');
            overlay.id = 'serviceClosedOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-in-out;
            `;
            
            // 創建通知框
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 12px;
                max-width: 450px;
                width: 90%;
                text-align: center;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease-out;
            `;
            
            // 圖標
            const icon = document.createElement('div');
            icon.style.cssText = 'font-size: 4rem; margin-bottom: 1rem;';
            icon.textContent = '⚠️';
            
            // 標題
            const title = document.createElement('h2');
            title.style.cssText = 'color: #E74C3C; margin-bottom: 1rem; font-size: 1.5rem; font-weight: 700;';
            title.textContent = '此服務目前未開放報名';
            
            // 訊息內容
            const message = document.createElement('p');
            message.style.cssText = 'color: #666; margin-bottom: 1.5rem; line-height: 1.6; font-size: 1rem;';
            
            if (config.closedMessage) {
                message.textContent = config.closedMessage;
            } else if (config.startDate) {
                message.textContent = `預計 ${formatDate(config.startDate)} 開放報名`;
            } else {
                message.textContent = '敬請期待開放時間';
            }
            
            // 確定按鈕
            const button = document.createElement('button');
            button.style.cssText = `
                background: #8A2BE2;
                color: white;
                border: none;
                padding: 0.75rem 2rem;
                border-radius: 6px;
                font-size: 1rem;
                cursor: pointer;
                font-weight: 500;
                transition: background 0.2s;
            `;
            button.textContent = '確定';
            button.onmouseover = () => button.style.background = '#7B27C7';
            button.onmouseout = () => button.style.background = '#8A2BE2';
            button.onclick = () => {
                overlay.style.animation = 'fadeOut 0.2s ease-in-out';
                setTimeout(() => overlay.remove(), 200);
            };
            
            // 組裝通知框
            alertBox.appendChild(icon);
            alertBox.appendChild(title);
            alertBox.appendChild(message);
            alertBox.appendChild(button);
            overlay.appendChild(alertBox);
            
            // 添加 CSS 動畫
            if (!document.getElementById('notificationStyles')) {
                const style = document.createElement('style');
                style.id = 'notificationStyles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes fadeOut {
                        from { opacity: 1; }
                        to { opacity: 0; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-50px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 顯示通知
            document.body.insertBefore(overlay, document.body.firstChild);
            
            // 點擊遮罩層也可以關閉
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.style.animation = 'fadeOut 0.2s ease-in-out';
                    setTimeout(() => overlay.remove(), 200);
                }
            };
        }
        
        window.checkServiceStatus = function(serviceType, targetPage) {
            const config = serviceConfigs[serviceType];
            
            if (!config) {
                window.location.href = targetPage;
                return;
            }
            
            if (!config.isOpen) {
                showServiceClosedNotification(config);
                return;
            }
            
            window.location.href = targetPage;
        };
        
        loadServiceConfigs();
    </script>
</body>
</html>
