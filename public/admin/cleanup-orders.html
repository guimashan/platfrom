<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…ç†èˆŠè¨‚å–® - é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</title>
    <link rel="stylesheet" href="../styles/common.css">
    <style>
        .cleanup-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .warning-box h3 {
            color: #856404;
            margin-top: 0;
        }
        
        .warning-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .btn-cleanup {
            background: #dc3545;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .btn-cleanup:hover {
            background: #c82333;
        }
        
        .btn-cleanup:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .result-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .result-box.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result-box.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result-details {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="cleanup-container">
        <h1>ğŸ—‘ï¸ æ¸…ç†èˆŠæ ¼å¼è¨‚å–®</h1>
        
        <div class="warning-box">
            <h3>âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯é€†</h3>
            <p>æ­¤åŠŸèƒ½å°‡åˆªé™¤æ‰€æœ‰ä¸ç¬¦åˆæ¨™æº–æ ¼å¼çš„è¨‚å–®è³‡æ–™ï¼š</p>
            <ul>
                <li>æ¨™æº–æ ¼å¼ï¼šdd, nd, ld, zy, ps, qj, bg, xy, ftp, ftc, fty</li>
                <li>æ‰€æœ‰å…¶ä»–æ ¼å¼ï¼ˆå¦‚ xiangyou, lidou ç­‰ï¼‰çš„è¨‚å–®å°‡è¢«æ°¸ä¹…åˆªé™¤</li>
                <li>åˆªé™¤å¾Œç„¡æ³•å¾©åŸ</li>
            </ul>
            <p><strong>è«‹ç¢ºèªé€™äº›æ˜¯æ¸¬è©¦è³‡æ–™å¾Œå†åŸ·è¡Œï¼</strong></p>
        </div>
        
        <button id="cleanupBtn" class="btn-cleanup">åŸ·è¡Œæ¸…ç†</button>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æ¸…ç†ä¸­ï¼Œè«‹ç¨å€™...</p>
        </div>
        
        <div id="resultBox" class="result-box">
            <h3 id="resultTitle"></h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';

        const platformConfig = {
            apiKey: "AIzaSyCViTkj-aIMqIp7Ov3Wv7iSKEB5-L96zNA",
            authDomain: "platform-bc783.firebaseapp.com",
            projectId: "platform-bc783",
            storageBucket: "platform-bc783.firebasestorage.app",
            messagingSenderId: "102685160692",
            appId: "1:102685160692:web:67d6bccba52e33b63bc3ea"
        };

        const app = initializeApp(platformConfig);
        const auth = getAuth(app);

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = '/platform/login.html';
            }
        });

        document.getElementById('cleanupBtn').addEventListener('click', async () => {
            if (!confirm('ç¢ºå®šè¦åŸ·è¡Œæ¸…ç†å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            if (!confirm('å†æ¬¡ç¢ºèªï¼šé€™å°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰èˆŠæ ¼å¼çš„è¨‚å–®è³‡æ–™ï¼')) {
                return;
            }

            const cleanupBtn = document.getElementById('cleanupBtn');
            const loading = document.getElementById('loading');
            const resultBox = document.getElementById('resultBox');
            
            cleanupBtn.disabled = true;
            loading.style.display = 'block';
            resultBox.style.display = 'none';

            try {
                const idToken = await currentUser.getIdToken();
                
                const response = await fetch('https://asia-east2-service-b9d4a.cloudfunctions.net/cleanupOldOrders', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || 'æ¸…ç†å¤±æ•—');
                }

                // é¡¯ç¤ºæˆåŠŸçµæœ
                resultBox.className = 'result-box success';
                resultBox.style.display = 'block';
                document.getElementById('resultTitle').textContent = 'âœ… æ¸…ç†æˆåŠŸï¼';
                
                const summary = data.result.summary;
                const details = data.result.deletedDetails;
                
                let content = `
                    <div class="result-details">
                        <strong>æ¸…ç†æ‘˜è¦ï¼š</strong><br>
                        ç¸½è¨‚å–®æ•¸ï¼š${summary.totalOrders}<br>
                        ä¿ç•™è¨‚å–®ï¼š${summary.validOrders}<br>
                        åˆªé™¤è¨‚å–®ï¼š${summary.deletedOrders}<br>
                        <br>
                        <strong>ç™¼ç¾çš„èˆŠæ ¼å¼ï¼š</strong><br>
                        ${summary.oldServiceTypes.length > 0 ? summary.oldServiceTypes.join(', ') : 'ç„¡'}
                `;
                
                if (details && details.length > 0) {
                    content += `<br><br><strong>å·²åˆªé™¤çš„è¨‚å–®ï¼š</strong><br>`;
                    details.forEach(order => {
                        content += `- ${order.orderId} (${order.serviceType})<br>`;
                    });
                }
                
                content += `</div>`;
                
                document.getElementById('resultContent').innerHTML = content;

            } catch (error) {
                console.error('æ¸…ç†å¤±æ•—:', error);
                resultBox.className = 'result-box error';
                resultBox.style.display = 'block';
                document.getElementById('resultTitle').textContent = 'âŒ æ¸…ç†å¤±æ•—';
                document.getElementById('resultContent').innerHTML = `
                    <p>éŒ¯èª¤è¨Šæ¯ï¼š${error.message}</p>
                `;
            } finally {
                loading.style.display = 'none';
                cleanupBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
