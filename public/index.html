<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="/styles/common.css">
</head>
<body>
    <!-- ä¸»è¦å…§å®¹å€ï¼ˆç™»å…¥å¾Œæ‰é¡¯ç¤ºï¼‰ -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <header class="header">
                <div>
                    <h1>é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</h1>
                </div>
                <button id="logoutBtn" class="btn-logout" style="display: none;">ç™»å‡º</button>
            </header>

            <main class="main-content" role="main">
                <section id="userInfo" class="user-info" style="display: none;" aria-label="ä½¿ç”¨è€…è³‡è¨Š">
                    <img id="userAvatar" class="user-avatar" alt="ä½¿ç”¨è€…é ­åƒ">
                    <div class="user-details">
                        <h3 id="userName"></h3>
                        <div id="userRoles" class="user-roles"></div>
                    </div>
                </section>

                <section id="moduleGrid" class="module-grid" aria-label="æœå‹™æ¨¡çµ„é¸å–®">
                <div class="module-card" data-module="service" role="button" tabindex="0" aria-label="ç¥å‹™æœå‹™ï¼šæ³•æœƒå ±åèˆ‡æœå‹™ç®¡ç†">
                    <div class="module-icon" aria-hidden="true">ğŸ•¯ï¸</div>
                    <div class="module-title">ç¥å‹™æœå‹™</div>
                    <div class="module-desc">æ³•æœƒå ±åèˆ‡æœå‹™ç®¡ç†</div>
                </div>
                
                <div class="module-card" data-module="bx" role="button" tabindex="0" aria-label="ä¿¡çœ¾å¥‰ç»ï¼šå»ºå®®å»Ÿæ¬¾èˆ‡æ·»é¦™æ²¹">
                    <div class="module-icon" aria-hidden="true">ğŸ®</div>
                    <div class="module-title">ä¿¡çœ¾å¥‰ç»</div>
                    <div class="module-desc">å»ºå®®å»Ÿæ¬¾èˆ‡æ·»é¦™æ²¹</div>
                </div>
                
                <div class="module-card" data-module="ft" role="button" tabindex="0" aria-label="ç¦ç”°æœƒï¼šç¦ç”°æœƒå…¥æœƒç”³è«‹">
                    <div class="module-icon" aria-hidden="true">ğŸ™</div>
                    <div class="module-title">ç¦ç”°æœƒ</div>
                    <div class="module-desc">ç¦ç”°æœƒå…¥æœƒç”³è«‹</div>
                </div>
                
                <div class="module-card" data-module="checkin" role="button" tabindex="0" aria-label="å¥‰é¦™ç°½åˆ°ï¼šç°½åˆ°æ‰“å¡èˆ‡æ­·ç¨‹ç´€éŒ„">
                    <div class="module-icon" aria-hidden="true">âœ…</div>
                    <div class="module-title">å¥‰é¦™ç°½åˆ°</div>
                    <div class="module-desc">ç°½åˆ°æ‰“å¡èˆ‡æ­·ç¨‹ç´€éŒ„</div>
                </div>
                
                <div class="module-card module-card-locked" data-module="schedule" role="button" tabindex="0" aria-label="æ’ç­ç³»çµ±ï¼šå¿—å·¥æ’ç­èˆ‡ç­è¡¨ç®¡ç†ï¼ˆå³å°‡é–‹æ”¾ï¼‰" aria-disabled="true">
                    <div class="module-badge">å³å°‡é–‹æ”¾</div>
                    <div class="module-icon" aria-hidden="true">ğŸ“…</div>
                    <div class="module-title">æ’ç­ç³»çµ±</div>
                    <div class="module-desc">å¿—å·¥æ’ç­èˆ‡ç­è¡¨ç®¡ç†</div>
                </div>
                
                <div class="module-card" data-module="manage" style="display: none;" role="button" tabindex="0" aria-label="ç³»çµ±ç®¡ç†ï¼šä½¿ç”¨è€…èˆ‡æ¬Šé™ç®¡ç†">
                    <div class="module-icon" aria-hidden="true">âš™ï¸</div>
                    <div class="module-title">ç³»çµ±ç®¡ç†</div>
                    <div class="module-desc">ä½¿ç”¨è€…èˆ‡æ¬Šé™ç®¡ç†</div>
                </div>
                </section>

                <div id="loadingIndicator" class="loading hidden" role="status" aria-live="polite">
                    <div class="spinner"></div>
                    <p>ç™»å…¥ä¸­...</p>
                </div>
            </main>

            <nav class="bottom-nav" role="navigation" aria-label="ä¸»è¦å°èˆª">
                <div class="bottom-nav-items">
                    <a href="/" class="bottom-nav-item active" aria-current="page" aria-label="é¦–é ">
                        <span class="icon" aria-hidden="true">ğŸ </span>
                        <span>é¦–é </span>
                    </a>
                    <a href="/checkin/checkin.html" class="bottom-nav-item" aria-label="å¥‰é¦™ç°½åˆ°">
                        <span class="icon" aria-hidden="true"><img src="/images/temple-icon.png" alt="" style="width: 24px; height: 24px;"></span>
                        <span>ç°½åˆ°</span>
                    </a>
                    <a href="/checkin/history.html" class="bottom-nav-item" aria-label="æ­·ç¨‹è¡¨">
                        <span class="icon" aria-hidden="true">ğŸ“‹</span>
                        <span>æ­·ç¨‹è¡¨</span>
                    </a>
                    <a href="/manage/index.html" class="bottom-nav-item" aria-label="é€šçŸ¥ä¸­å¿ƒ">
                        <span class="icon" aria-hidden="true">ğŸ””</span>
                        <span>é€šçŸ¥ä¸­å¿ƒ</span>
                    </a>
                </div>
            </nav>
        </div>
    </div> <!-- é—œé–‰ mainApp -->

    <script type="module">
        import { checkAuthWithUI } from '/js/auth-guard.js';
        import { logout } from '/js/auth.js';

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥èªè­‰ç‹€æ…‹
        checkAuthWithUI({
            onAuthenticated: async (result) => {
                console.log('âœ… [index.html] ä½¿ç”¨è€…å·²ç™»å…¥:', result.userData.displayName);
                
                // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
                const userInfo = document.getElementById('userInfo');
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                const userRoles = document.getElementById('userRoles');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (userName) userName.textContent = result.userData.displayName || 'ä½¿ç”¨è€…';
                if (userAvatar) {
                    userAvatar.src = result.userData.pictureUrl || '/images/default-avatar.svg';
                    userAvatar.alt = result.userData.displayName || 'ä½¿ç”¨è€…é ­åƒ';
                }
                if (userRoles) {
                    const roleNames = {
                        'user': 'ä¸€èˆ¬ä½¿ç”¨è€…',
                        'poweruser_checkin': 'ç°½åˆ°å¹¹éƒ¨',
                        'poweruser_service': 'ç¥å‹™å¹¹éƒ¨',
                        'poweruser_schedule': 'æ’ç­å¹¹éƒ¨',
                        'admin_checkin': 'ç°½åˆ°ç®¡ç†å“¡',
                        'admin_service': 'ç¥å‹™ç®¡ç†å“¡',
                        'admin_schedule': 'æ’ç­ç®¡ç†å“¡',
                        'superadmin': 'è¶…ç´šç®¡ç†å“¡'
                    };
                    const roleText = result.roles.map(r => roleNames[r] || r).join(', ');
                    userRoles.textContent = roleText;
                }
                
                if (userInfo) userInfo.style.display = 'flex';
                if (logoutBtn) logoutBtn.style.display = 'block';
                
                // é¡¯ç¤ºæ¨¡çµ„é¸å–®
                const moduleGrid = document.getElementById('moduleGrid');
                if (moduleGrid) {
                    moduleGrid.classList.add('active');
                    
                    // æ ¹æ“šè§’è‰²æ§åˆ¶æ¨¡çµ„å¯è¦‹æ€§
                    const modules = document.querySelectorAll('.module-card');
                    modules.forEach(card => {
                        const module = card.dataset.module;
                        
                        if (!module) {
                            card.style.display = 'block';
                            return;
                        }
                        
                        let canAccess = false;
                        let isVisible = false;
                        
                        if (module === 'checkin' || module === 'service' || module === 'bx' || module === 'ft') {
                            canAccess = true;
                            isVisible = true;
                        } else if (module === 'schedule') {
                            canAccess = false;
                            isVisible = true;
                        } else if (module === 'manage') {
                            const isAdmin = result.roles.some(role => 
                                role === 'poweruser' ||
                                role === 'admin' ||
                                role.startsWith('poweruser_') || 
                                role.startsWith('admin_') || 
                                role === 'superadmin'
                            );
                            canAccess = isAdmin;
                            isVisible = isAdmin;
                        }
                        
                        if (isVisible) {
                            card.style.display = 'block';
                            if (canAccess && !card.classList.contains('module-card-locked')) {
                                card.style.cursor = 'pointer';
                                card.addEventListener('click', () => handleModuleClick(module));
                            }
                        } else {
                            card.style.display = 'none';
                        }
                    });
                }
            },
            onUnauthenticated: () => {
                console.log('âŒ [index.html] ä½¿ç”¨è€…æœªç™»å…¥');
            }
        });

        // æ¨¡çµ„é»æ“Šè™•ç†
        function handleModuleClick(module) {
            const routes = {
                'checkin': '/checkin/checkin.html',
                'service': '/service/service.html',
                'bx': '/service/bx.html',
                'ft': '/service/ft.html',
                'manage': '/manage/index.html'
            };
            
            if (routes[module]) {
                window.location.href = routes[module];
            }
        }

        // éµç›¤ç„¡éšœç¤™æ”¯æ´
        document.addEventListener('keydown', (e) => {
            const target = e.target;
            if (target.classList.contains('module-card') && target.getAttribute('role') === 'button') {
                // æŒ‰ä¸‹ Enter æˆ– Space éµæ™‚è§¸ç™¼é»æ“Š
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    target.click();
                }
            }
        });

        // ç™»å‡ºæŒ‰éˆ•
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
        }
    </script>
</body>
</html>
