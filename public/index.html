<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="/styles/common.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <h1>é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</h1>
            </div>
            <button id="logoutBtn" class="btn-logout" style="display: none;">ç™»å‡º</button>
        </header>

        <main class="main-content">
            <div id="userInfo" class="user-info" style="display: none;">
                <img id="userAvatar" class="user-avatar" alt="ä½¿ç”¨è€…é ­åƒ">
                <div class="user-details">
                    <h3 id="userName"></h3>
                    <div id="userRoles" class="user-roles"></div>
                </div>
            </div>

            <div id="loginCard" class="welcome-card">
                <h2>æ­¡è¿</h2>
                <p style="color: #6B5D4F; margin-bottom: 2rem;">è«‹ä½¿ç”¨ LINE å¸³è™Ÿç™»å…¥ç³»çµ±</p>
                <button id="lineLoginBtn" class="btn btn-primary">
                    LINE ç™»å…¥
                </button>
            </div>

            <div id="moduleGrid" class="module-grid">
                <div class="module-card" data-module="checkin">
                    <div class="module-icon">ğŸ™</div>
                    <div class="module-title">å¥‰é¦™ç°½åˆ°</div>
                    <div class="module-desc">ç°½åˆ°æ‰“å¡èˆ‡æ­·ç¨‹ç´€éŒ„</div>
                </div>
                
                <div class="module-card" data-module="service">
                    <div class="module-icon">âš¡</div>
                    <div class="module-title">ç¥å‹™æœå‹™</div>
                    <div class="module-desc">æ³•æœƒå ±åèˆ‡æœå‹™ç®¡ç†</div>
                </div>
                
                <div class="module-card module-card-locked" data-module="schedule">
                    <div class="module-badge">å³å°‡é–‹æ”¾</div>
                    <div class="module-icon">ğŸ“…</div>
                    <div class="module-title">æ’ç­ç³»çµ±</div>
                    <div class="module-desc">å¿—å·¥æ’ç­èˆ‡ç­è¡¨ç®¡ç†</div>
                </div>
                
                <div class="module-card" data-module="manage" style="display: none;">
                    <div class="module-icon">âš™ï¸</div>
                    <div class="module-title">ç³»çµ±ç®¡ç†</div>
                    <div class="module-desc">ä½¿ç”¨è€…èˆ‡æ¬Šé™ç®¡ç†</div>
                </div>
            </div>

            <div id="loadingIndicator" class="loading hidden">
                <div class="spinner"></div>
                <p>ç™»å…¥ä¸­...</p>
            </div>
        </main>

        <div class="bottom-nav">
            <div class="bottom-nav-items">
                <a href="/" class="bottom-nav-item active">
                    <span class="icon">ğŸ </span>
                    <span>é¦–é </span>
                </a>
                <a href="/checkin/checkin.html" class="bottom-nav-item">
                    <span class="icon"><img src="/images/temple-icon.png" alt="ç°½åˆ°" style="width: 24px; height: 24px;"></span>
                    <span>ç°½åˆ°</span>
                </a>
                <a href="/checkin/history.html" class="bottom-nav-item">
                    <span class="icon">ğŸ“‹</span>
                    <span>æ­·ç¨‹è¡¨</span>
                </a>
                <a href="/manage/index.html" class="bottom-nav-item">
                    <span class="icon">ğŸ””</span>
                    <span>é€šçŸ¥ä¸­å¿ƒ</span>
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        let firebaseLoaded = false;
        let authModule = null;

        async function loadFirebase() {
            if (firebaseLoaded) return authModule;
            
            // ç«‹å³æ¨™è¨˜ç‚ºå·²è¼‰å…¥ï¼Œé˜²æ­¢ä¸¦ç™¼èª¿ç”¨
            firebaseLoaded = true;
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.classList.remove('hidden');
            
            try {
                await import('/js/firebase-init.js');
                authModule = await import('/js/auth.js');
                
                // åƒ…åœ¨é¦–é åˆå§‹åŒ–èªè­‰ç‹€æ…‹ç›£è½ï¼ˆåªåŸ·è¡Œä¸€æ¬¡ï¼‰
                if (authModule.initAuthStateListener) {
                    authModule.initAuthStateListener();
                }
                
                return authModule;
            } catch (error) {
                console.error('Firebase è¼‰å…¥å¤±æ•—:', error);
                alert('ç³»çµ±è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                firebaseLoaded = false; // å¤±æ•—æ™‚é‡ç½®ï¼Œå…è¨±é‡è©¦
                throw error;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        document.getElementById('lineLoginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const auth = await loadFirebase();
            if (auth && auth.handleLineLogin) {
                auth.handleLineLogin();
            }
        });

        (async function checkAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const hasAuthParams = urlParams.has('code') || urlParams.has('state') || 
                                  document.referrer.includes('line.me') ||
                                  sessionStorage.getItem('firebase_loaded');
            
            if (hasAuthParams) {
                sessionStorage.setItem('firebase_loaded', 'true');
                await loadFirebase();
            } else {
                document.getElementById('loginCard').style.display = 'block';
                document.getElementById('moduleGrid').style.opacity = '0.6';
            }
        })();
    </script>
</body>
</html>
