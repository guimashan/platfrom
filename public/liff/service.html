<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ç¥å‹™æœå‹™ - é¾œé¦¬å±±æ•´åˆæœå‹™å¹³å°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles/common.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div>
                <h1>ç¥å‹™æœå‹™</h1>
                <p class="subtitle">é¸æ“‡æ‚¨éœ€è¦çš„æœå‹™é …ç›®</p>
            </div>
            <button class="btn-logout" id="backBtn">è¿”å›</button>
        </header>

        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥ä¸­...</p>
        </div>

        <main class="main-content" id="mainContent" style="display: none;">
            <div class="module-grid active">
                <div class="module-card" data-service="DD">
                    <div class="module-icon">ğŸ•¯ï¸</div>
                    <div class="module-title">é¾œé¦¬å±±ä¸€é»éˆ</div>
                    <div class="module-desc">ç¥ˆç¦é»ç‡ˆï¼Œå…‰æ˜ç¥ˆé¡˜</div>
                </div>
                
                <div class="module-card" data-service="ND">
                    <div class="module-icon">ğŸŠ</div>
                    <div class="module-title">å¹´æ–—æ³•æœƒ</div>
                    <div class="module-desc">æ–°æ˜¥ç¥ˆç¦ï¼Œé—”å®¶å¹³å®‰</div>
                </div>
                
                <div class="module-card" data-service="LD">
                    <div class="module-icon">â­</div>
                    <div class="module-title">ç¦®æ–—æ³•æœƒ</div>
                    <div class="module-desc">ç¦®æ‹œæ˜Ÿæ–—ï¼Œæ¶ˆç½å»¶å£½</div>
                </div>
                
                <div class="module-card" data-service="ZY">
                    <div class="module-icon">ğŸ®</div>
                    <div class="module-title">ä¸­å…ƒæ³•æœƒ</div>
                    <div class="module-desc">æ™®æ¸¡çœ¾ç”Ÿï¼Œè¶…è–¦å…ˆéˆ</div>
                </div>
                
                <div class="module-card" data-service="PS">
                    <div class="module-icon">ğŸ™</div>
                    <div class="module-title">æ™®æ–½æ³•æœƒ</div>
                    <div class="module-desc">æ…ˆæ‚²å¸ƒæ–½ï¼Œå»£çµå–„ç·£</div>
                </div>
                
                <div class="module-card" data-service="QJ">
                    <div class="module-icon">ğŸ‚</div>
                    <div class="module-title">ç§‹ç¥­æ³•æœƒ</div>
                    <div class="module-desc">ç§‹å­£ç¥­å…¸ï¼Œæ„Ÿæ©ç¥ˆç¦</div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="module">
        import { initLiff } from '/js/liff-init.js';
        import { platformAuth } from '/js/firebase-init.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        const LIFF_ID = '2008269293-Nl2pZBpV';

        // æœå‹™è·¯å¾‘æ˜ å°„ï¼ˆä½¿ç”¨å®Œæ•´ URLï¼Œç¢ºä¿åœ¨ LINE App LIFF ç’°å¢ƒä¸­æ­£ç¢ºè·³è½‰ï¼‰
        const BASE_URL = 'https://go.guimashan.org.tw';
        const SERVICE_PATHS = {
            DD: `${BASE_URL}/liff/service/DD.html`,
            ND: `${BASE_URL}/liff/service/ND.html`,
            LD: `${BASE_URL}/liff/service/LD.html`,
            ZY: `${BASE_URL}/liff/service/ZY.html`,
            PS: `${BASE_URL}/liff/service/PS.html`,
            QJ: `${BASE_URL}/liff/service/QJ.html`
        };

        async function init() {
            try {
                // ğŸ¯ å„ªå…ˆæª¢æŸ¥ liff.state åƒæ•¸ï¼Œå¦‚æœæœ‰å‰‡ç›´æ¥å°èˆªï¼ˆä¸éœ€è¦ç­‰ LIFF åˆå§‹åŒ–ï¼‰
                const urlParams = new URLSearchParams(window.location.search);
                const liffState = urlParams.get('liff.state');
                
                if (liffState) {
                    console.log('æª¢æ¸¬åˆ° liff.state åƒæ•¸:', liffState);
                    
                    // ğŸ¯ è™•ç†ä¸‰ç¨®æ ¼å¼çš„ liff.stateï¼š
                    // 1. å®Œæ•´è·¯å¾‘æ ¼å¼ï¼š/liff/service/DD.html
                    // 2. çŸ­æ ¼å¼ï¼š/DDï¼ˆé—œéµè©ç®¡ç†é é¢ç”Ÿæˆçš„æ ¼å¼ï¼‰
                    // 3. æœå‹™ä»£ç¢¼æ ¼å¼ï¼šDD
                    let targetUrl;
                    
                    // ç§»é™¤é–‹é ­çš„ / ä»¥ä¾¿çµ±ä¸€è™•ç†
                    const cleanState = liffState.startsWith('/') ? liffState.substring(1) : liffState;
                    
                    if (cleanState.startsWith('liff/service/')) {
                        // æ ¼å¼1ï¼šå®Œæ•´è·¯å¾‘ /liff/service/DD.html
                        targetUrl = `${BASE_URL}/${cleanState}`;
                        console.log('å®Œæ•´è·¯å¾‘æ ¼å¼ï¼Œå°èˆªåˆ°:', targetUrl);
                    } else if (SERVICE_PATHS[cleanState]) {
                        // æ ¼å¼2 & 3ï¼šæœå‹™ä»£ç¢¼ï¼ˆDD, ND, LD ç­‰ï¼‰
                        targetUrl = SERVICE_PATHS[cleanState];
                        console.log('æœå‹™ä»£ç¢¼æ ¼å¼ï¼Œå°èˆªåˆ°:', targetUrl);
                    } else {
                        // å…¶ä»–æœå‹™ä»£ç¢¼ï¼ˆdonation, ft, BG, XY, FTC, FTP, FTY ç­‰ï¼‰
                        targetUrl = `${BASE_URL}/liff/service/${cleanState}.html`;
                        console.log('å…¶ä»–æœå‹™æ ¼å¼ï¼Œå°èˆªåˆ°:', targetUrl);
                    }
                    
                    window.location.replace(targetUrl);
                    return;
                }

                // è¨­ç½®åˆå§‹åŒ–è¶…æ™‚ï¼ˆ10 ç§’ï¼‰
                const timeoutId = setTimeout(() => {
                    console.warn('LIFF åˆå§‹åŒ–è¶…æ™‚ï¼Œå˜—è©¦é¡¯ç¤ºå…§å®¹');
                    showContent();
                }, 10000);

                // ä½¿ç”¨å…±ç”¨çš„ LIFF åˆå§‹åŒ–æ¨¡çµ„
                const liffData = await initLiff(LIFF_ID);
                
                clearTimeout(timeoutId);
                
                if (!liffData) {
                    console.warn('LIFF åˆå§‹åŒ–è¿”å› nullï¼Œä½†ä»é¡¯ç¤ºå…§å®¹');
                    showContent();
                    return;
                }

                // ç­‰å¾… Firebase èªè­‰å®Œæˆ
                onAuthStateChanged(platformAuth, async (user) => {
                    if (user) {
                        console.log('âœ… Firebase ä½¿ç”¨è€…å·²ç™»å…¥:', user.displayName);
                        showContent();
                    } else {
                        console.log('â„¹ï¸ ä½¿ç”¨è€…æœªç™»å…¥ Firebaseï¼Œä½†å¯ç¹¼çºŒä½¿ç”¨');
                        showContent();
                    }
                });

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                        <h3 style="margin-bottom: 10px;">åˆå§‹åŒ–å¤±æ•—</h3>
                        <p style="color: #666; margin-bottom: 20px;">è«‹é‡æ–°æ•´ç†é é¢æˆ–ç¨å¾Œå†è©¦</p>
                        <button onclick="location.reload()" class="btn btn-primary">é‡æ–°æ•´ç†</button>
                    </div>
                `;
                document.getElementById('mainContent').style.display = 'block';
            }
        }

        function showContent() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // ç¶å®šæœå‹™å¡ç‰‡é»æ“Šäº‹ä»¶
            document.querySelectorAll('.module-card').forEach(card => {
                card.addEventListener('click', () => {
                    const service = card.dataset.service;
                    navigateToService(service);
                });
            });

            // ç¶å®šè¿”å›æŒ‰éˆ•
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.replace(`${BASE_URL}/liff/index.html`);
            });
        }

        function navigateToService(service) {
            const path = SERVICE_PATHS[service];
            if (path) {
                console.log('å°èˆªåˆ°æœå‹™:', service, path);
                window.location.replace(path);
            } else {
                alert('æœå‹™è·¯å¾‘æœªé…ç½®');
            }
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
