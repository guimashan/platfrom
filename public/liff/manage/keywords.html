<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Bot é—œéµè©ç®¡ç† - é¾œé¦¬å±± goLine å¹³å°</title>
    <link rel="stylesheet" href="/styles/common.css">
    <style>
        .keyword-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
            margin: 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .keyword-list {
            display: grid;
            gap: 15px;
        }

        .keyword-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .keyword-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .keyword-item.disabled {
            opacity: 0.6;
            background: #f5f5f5;
        }

        .keyword-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .keyword-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .keyword-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .keyword-status.enabled {
            background: #4CAF50;
            color: white;
        }

        .keyword-status.disabled {
            background: #9e9e9e;
            color: white;
        }

        .keyword-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }

        .keyword-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .keyword-url {
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .keyword-aliases {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .alias-tag {
            padding: 4px 10px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
        }

        .keyword-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .keyword-actions button {
            flex: 1;
            padding: 8px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 22px;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .alias-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .alias-input-group input {
            flex: 1;
        }

        .alias-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .alias-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 13px;
        }

        .alias-item button {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            padding: 0;
            font-size: 16px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .form-actions button {
            flex: 1;
            padding: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state img {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="keyword-container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¤– LINE Bot é—œéµè©ç®¡ç†</h1>
            <button class="btn btn-primary" onclick="showAddModal()">
                â• æ–°å¢é—œéµè©
            </button>
        </div>

        <!-- Search Box -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é—œéµè©..." oninput="filterKeywords()">
        </div>

        <!-- Keyword List -->
        <div id="keywordList" class="keyword-list">
            <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“</div>
            <h3>å°šç„¡é—œéµè©</h3>
            <p>é»æ“Šã€Œæ–°å¢é—œéµè©ã€é–‹å§‹å»ºç«‹æ‚¨çš„ LINE Bot è‡ªå‹•å›è¦†</p>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="keywordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°å¢é—œéµè©</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <div id="modalError" class="error-message" style="display: none;"></div>

            <form id="keywordForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="keywordId">

                <div class="form-group">
                    <label for="keyword">é—œéµè© *</label>
                    <input type="text" id="keyword" required placeholder="ä¾‹å¦‚ï¼šé»ç‡ˆ">
                    <small>ä½¿ç”¨è€…è¼¸å…¥é€™å€‹é—œéµè©æ™‚æœƒè§¸ç™¼å›è¦†</small>
                </div>

                <div class="form-group">
                    <label for="liffUrl">LIFF ç¶²é  URL *</label>
                    <input type="url" id="liffUrl" required placeholder="https://liff.line.me/...">
                    <small>å®Œæ•´çš„ LIFF URLï¼ŒåŒ…å« https://</small>
                </div>

                <div class="form-group">
                    <label for="description">èªªæ˜</label>
                    <textarea id="description" placeholder="é€™å€‹é—œéµè©çš„ç”¨é€”èªªæ˜"></textarea>
                </div>

                <div class="form-group">
                    <label>åˆ¥åï¼ˆé¸å¡«ï¼‰</label>
                    <div class="alias-input-group">
                        <input type="text" id="aliasInput" placeholder="è¼¸å…¥åˆ¥åä¸¦æŒ‰ Enter">
                        <button type="button" class="btn btn-secondary" onclick="addAlias()">æ–°å¢</button>
                    </div>
                    <div id="aliasList" class="alias-list"></div>
                    <small>åˆ¥åä¹Ÿæœƒè§¸ç™¼ç›¸åŒçš„å›è¦†</small>
                </div>

                <div class="form-group">
                    <label for="priority">å„ªå…ˆç´š</label>
                    <input type="number" id="priority" value="0" min="0" max="100">
                    <small>æ•¸å­—è¶Šå¤§å„ªå…ˆç´šè¶Šé«˜ï¼ˆ0-100ï¼‰</small>
                </div>

                <div class="form-group">
                    <label for="buttonLabel">æŒ‰éˆ•æ–‡å­—</label>
                    <input type="text" id="buttonLabel" value="ç«‹å³é–‹å•Ÿ">
                    <small>LINE è¨Šæ¯ä¸Šçš„æŒ‰éˆ•é¡¯ç¤ºæ–‡å­—</small>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="enabled" checked>
                    <label for="enabled">å•Ÿç”¨æ­¤é—œéµè©</label>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="module">
        import { initLiff } from '/js/liff-init.js';
        import { platformAuth, platformDb } from '/js/firebase-init.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import * as keywordService from '/js/keyword-service.js';

        const LIFF_ID = '2008269293-Nl2pZBpV';
        
        let currentUser = null;
        let currentUserId = null;
        let allKeywords = [];
        let currentAliases = [];

        // åˆå§‹åŒ–
        async function init() {
            try {
                const liffData = await initLiff(LIFF_ID);
                
                if (!liffData) {
                    return;
                }

                // ç­‰å¾… Firebase èªè­‰
                onAuthStateChanged(platformAuth, async (user) => {
                    if (user) {
                        currentUser = user;
                        currentUserId = user.uid;
                        await checkPermission();
                    } else {
                        showError('è«‹å…ˆç™»å…¥');
                    }
                });

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                showError('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // æª¢æŸ¥æ¬Šé™
        async function checkPermission() {
            try {
                const userRef = doc(platformDb, 'users', currentUserId);
                const userSnap = await getDoc(userRef);
                
                if (!userSnap.exists()) {
                    showError('ä½¿ç”¨è€…è³‡æ–™ä¸å­˜åœ¨');
                    return;
                }
                
                const userData = userSnap.data();
                const roles = userData.roles || [];
                
                if (!roles.includes('superadmin')) {
                    showError('æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ï¼ˆåƒ…é™ superadminï¼‰');
                    setTimeout(() => {
                        window.location.href = '/liff/index.html';
                    }, 2000);
                    return;
                }
                
                console.log('âœ… æ¬Šé™é©—è­‰é€šé');
                await loadKeywords();
                
            } catch (error) {
                console.error('æ¬Šé™æª¢æŸ¥å¤±æ•—:', error);
                showError('æ¬Šé™æª¢æŸ¥å¤±æ•—');
            }
        }

        // è¼‰å…¥é—œéµè©åˆ—è¡¨
        async function loadKeywords() {
            try {
                allKeywords = await keywordService.getAllKeywords();
                renderKeywords(allKeywords);
            } catch (error) {
                console.error('è¼‰å…¥é—œéµè©å¤±æ•—:', error);
                showError('è¼‰å…¥é—œéµè©å¤±æ•—');
            }
        }

        // æ¸²æŸ“é—œéµè©åˆ—è¡¨
        function renderKeywords(keywords) {
            const listEl = document.getElementById('keywordList');
            const emptyState = document.getElementById('emptyState');
            
            if (keywords.length === 0) {
                listEl.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            listEl.innerHTML = keywords.map(kw => `
                <div class="keyword-item ${kw.enabled ? '' : 'disabled'}">
                    <div class="keyword-header">
                        <div class="keyword-title">${escapeHtml(kw.keyword)}</div>
                        <div class="keyword-status ${kw.enabled ? 'enabled' : 'disabled'}">
                            ${kw.enabled ? 'å•Ÿç”¨' : 'åœç”¨'}
                        </div>
                    </div>
                    
                    <div class="keyword-meta">
                        <span>ğŸ”¢ å„ªå…ˆç´š: ${kw.priority}</span>
                        ${kw.createdAt ? `<span>ğŸ“… ${formatDate(kw.createdAt)}</span>` : ''}
                    </div>
                    
                    ${kw.description ? `<div style="margin-bottom: 10px; color: #666;">${escapeHtml(kw.description)}</div>` : ''}
                    
                    <div class="keyword-url">ğŸ”— ${escapeHtml(kw.liffUrl)}</div>
                    
                    ${kw.aliases && kw.aliases.length > 0 ? `
                        <div class="keyword-aliases">
                            ${kw.aliases.map(alias => `<span class="alias-tag">${escapeHtml(alias)}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="keyword-actions">
                        <button class="btn btn-secondary" onclick="window.toggleStatus('${kw.id}', ${!kw.enabled})">
                            ${kw.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}
                        </button>
                        <button class="btn btn-primary" onclick="window.showEditModal('${kw.id}')">
                            ç·¨è¼¯
                        </button>
                        <button class="btn btn-danger" onclick="window.deleteKeyword('${kw.id}', '${escapeHtml(kw.keyword)}')">
                            åˆªé™¤
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // æœå°‹éæ¿¾
        window.filterKeywords = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                renderKeywords(allKeywords);
                return;
            }
            
            const filtered = allKeywords.filter(kw => 
                kw.keyword.toLowerCase().includes(searchTerm) ||
                kw.description?.toLowerCase().includes(searchTerm) ||
                kw.aliases?.some(alias => alias.toLowerCase().includes(searchTerm))
            );
            
            renderKeywords(filtered);
        };

        // é¡¯ç¤ºæ–°å¢ Modal
        window.showAddModal = function() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢é—œéµè©';
            document.getElementById('keywordForm').reset();
            document.getElementById('keywordId').value = '';
            currentAliases = [];
            renderAliases();
            document.getElementById('keywordModal').classList.add('active');
        };

        // é¡¯ç¤ºç·¨è¼¯ Modal
        window.showEditModal = async function(keywordId) {
            try {
                const kw = await keywordService.getKeyword(keywordId);
                
                document.getElementById('modalTitle').textContent = 'ç·¨è¼¯é—œéµè©';
                document.getElementById('keywordId').value = kw.id;
                document.getElementById('keyword').value = kw.keyword;
                document.getElementById('liffUrl').value = kw.liffUrl;
                document.getElementById('description').value = kw.description || '';
                document.getElementById('priority').value = kw.priority || 0;
                document.getElementById('buttonLabel').value = kw.replyPayload?.label || 'ç«‹å³é–‹å•Ÿ';
                document.getElementById('enabled').checked = kw.enabled;
                
                currentAliases = kw.aliases || [];
                renderAliases();
                
                document.getElementById('keywordModal').classList.add('active');
            } catch (error) {
                console.error('è¼‰å…¥é—œéµè©å¤±æ•—:', error);
                showError('è¼‰å…¥é—œéµè©å¤±æ•—');
            }
        };

        // é—œé–‰ Modal
        window.closeModal = function() {
            document.getElementById('keywordModal').classList.remove('active');
            document.getElementById('modalError').style.display = 'none';
        };

        // æ–°å¢åˆ¥å
        window.addAlias = function() {
            const input = document.getElementById('aliasInput');
            const alias = input.value.trim();
            
            if (!alias) return;
            
            if (currentAliases.includes(alias)) {
                showModalError('åˆ¥åå·²å­˜åœ¨');
                return;
            }
            
            currentAliases.push(alias);
            renderAliases();
            input.value = '';
        };

        // ç§»é™¤åˆ¥å
        window.removeAlias = function(alias) {
            currentAliases = currentAliases.filter(a => a !== alias);
            renderAliases();
        };

        // æ¸²æŸ“åˆ¥ååˆ—è¡¨
        function renderAliases() {
            const listEl = document.getElementById('aliasList');
            
            if (currentAliases.length === 0) {
                listEl.innerHTML = '';
                return;
            }
            
            listEl.innerHTML = currentAliases.map(alias => `
                <div class="alias-item">
                    ${escapeHtml(alias)}
                    <button type="button" onclick="window.removeAlias('${escapeHtml(alias)}')">&times;</button>
                </div>
            `).join('');
        }

        // è™•ç†è¡¨å–®æäº¤
        window.handleSubmit = async function(event) {
            event.preventDefault();
            
            const keywordId = document.getElementById('keywordId').value;
            const keywordData = {
                keyword: document.getElementById('keyword').value,
                liffUrl: document.getElementById('liffUrl').value,
                description: document.getElementById('description').value,
                priority: document.getElementById('priority').value,
                enabled: document.getElementById('enabled').checked,
                aliases: currentAliases,
                replyType: 'template',
                replyPayload: {
                    altText: document.getElementById('keyword').value,
                    text: document.getElementById('keyword').value,
                    label: document.getElementById('buttonLabel').value
                }
            };
            
            try {
                if (keywordId) {
                    await keywordService.updateKeyword(keywordId, keywordData, currentUserId);
                } else {
                    await keywordService.createKeyword(keywordData, currentUserId);
                }
                
                closeModal();
                await loadKeywords();
                showSuccess(keywordId ? 'é—œéµè©å·²æ›´æ–°' : 'é—œéµè©å·²æ–°å¢');
            } catch (error) {
                console.error('å„²å­˜å¤±æ•—:', error);
                showModalError(error.message || 'å„²å­˜å¤±æ•—');
            }
        };

        // åˆ‡æ›ç‹€æ…‹
        window.toggleStatus = async function(keywordId, enabled) {
            try {
                await keywordService.toggleKeywordStatus(keywordId, enabled, currentUserId);
                await loadKeywords();
                showSuccess(enabled ? 'é—œéµè©å·²å•Ÿç”¨' : 'é—œéµè©å·²åœç”¨');
            } catch (error) {
                console.error('æ›´æ–°ç‹€æ…‹å¤±æ•—:', error);
                showError('æ›´æ–°ç‹€æ…‹å¤±æ•—');
            }
        };

        // åˆªé™¤é—œéµè©
        window.deleteKeyword = async function(keywordId, keyword) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é—œéµè©ã€Œ${keyword}ã€å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                await keywordService.deleteKeyword(keywordId);
                await loadKeywords();
                showSuccess('é—œéµè©å·²åˆªé™¤');
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—:', error);
                showError('åˆªé™¤å¤±æ•—');
            }
        };

        // å·¥å…·å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('zh-TW');
        }

        function showError(message) {
            alert('âŒ ' + message);
        }

        function showSuccess(message) {
            alert('âœ… ' + message);
        }

        function showModalError(message) {
            const errorEl = document.getElementById('modalError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        // Enter éµæ–°å¢åˆ¥å
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('aliasInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addAlias();
                }
            });
        });

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
