<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Token æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-all;
        }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        button {
            background: #8A2BE2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” LIFF Token äº¤æ¢æµ‹è¯•</h1>
    <div id="status"></div>
    
    <button onclick="testTokenExchange()">æµ‹è¯• Token äº¤æ¢</button>
    <button onclick="location.reload()">é‡æ–°åŠ è½½</button>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const LIFF_ID = '2008269293-Nl2pZBpV';
        const TOKEN_URL = 'https://asia-east2-platform-bc783.cloudfunctions.net/generateCustomTokenFromLiff';
        
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('status').appendChild(div);
            console.log(message);
        }
        
        async function testTokenExchange() {
            document.getElementById('status').innerHTML = '';
            
            try {
                log('æ­¥éª¤ 1: åˆå§‹åŒ– LIFF...');
                await liff.init({ liffId: LIFF_ID });
                log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                log('æ­¥éª¤ 2: æ£€æŸ¥ç™»å½•çŠ¶æ€...');
                if (!liff.isLoggedIn()) {
                    log('âš ï¸ ç”¨æˆ·æœªç™»å½•ï¼Œå‡†å¤‡ç™»å½•...', 'error');
                    liff.login();
                    return;
                }
                log('âœ… ç”¨æˆ·å·²ç™»å½•', 'success');
                
                log('æ­¥éª¤ 3: è·å–ç”¨æˆ·èµ„æ–™...');
                const profile = await liff.getProfile();
                log(`âœ… ç”¨æˆ·: ${profile.displayName} (${profile.userId})`, 'success');
                
                log('æ­¥éª¤ 4: è·å– LIFF ID Token...');
                const idToken = liff.getIDToken();
                if (!idToken) {
                    throw new Error('æ— æ³•è·å– LIFF ID Token');
                }
                log(`âœ… ID Token (å‰20å­—ç¬¦): ${idToken.substring(0, 20)}...`, 'success');
                
                log('æ­¥éª¤ 5: è°ƒç”¨ Cloud Function äº¤æ¢ Firebase Token...');
                log(`ğŸ“¡ è¯·æ±‚ URL: ${TOKEN_URL}`);
                log(`ğŸ“¦ è¯·æ±‚æ•°æ®: lineUserId=${profile.userId}`);
                
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        liffIdToken: idToken,
                        lineUserId: profile.userId,
                        displayName: profile.displayName,
                        pictureUrl: profile.pictureUrl
                    })
                });
                
                log(`ğŸ“¬ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                log(`ğŸ“¥ å“åº”æ•°æ®: ${JSON.stringify(data).substring(0, 100)}...`);
                
                if (!response.ok || !data.ok) {
                    throw new Error(data.message || `HTTP ${response.status}`);
                }
                
                log('âœ… Firebase Custom Token è·å–æˆåŠŸï¼', 'success');
                log(`ğŸŸï¸ Token (å‰30å­—ç¬¦): ${data.customToken.substring(0, 30)}...`, 'success');
                
                log('âœ¨ æ‰€æœ‰æ­¥éª¤å®Œæˆï¼LIFF Token äº¤æ¢æ­£å¸¸å·¥ä½œã€‚', 'success');
                
            } catch (error) {
                log(`âŒ é”™è¯¯: ${error.message}`, 'error');
                log(`ğŸ“‹ è¯¦ç»†ä¿¡æ¯: ${JSON.stringify(error, null, 2)}`, 'error');
                if (error.stack) {
                    log(`ğŸ“š Stack: ${error.stack}`, 'error');
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', () => {
            log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ç‚¹å‡»"æµ‹è¯• Token äº¤æ¢"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>
